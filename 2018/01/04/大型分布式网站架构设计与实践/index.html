<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head><meta name="generator" content="Hexo 3.8.0">
  

<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">






  <link rel="stylesheet" type="text/css" href="../../../../vendors/fancybox/source/jquery.fancybox.css?v=2.1.5">


<link rel="stylesheet" type="text/css" href="../../../../css/main.css?v=0.4.2">


    <meta name="description" content="在码农炼成之路不断挣扎……stay hungry……keep learning……">



  <meta name="keywords" content="分布式系统,阅读,">





  <link rel="shorticon icon" type="image/x-icon" href="../../../../favicon.ico?v=0.4.2">



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?6749450";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  <title> 大型分布式网站架构设计与实践 // CharlesXiao‘s Blog </title>
</head>

<body>
<!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <div class="container one-column page-post-detail">
    <div class="headband"></div>
    <!-- fork me github icon  -->
    <a href="https://github.com/Charles-Xiao" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">CharlesXiao‘s Blog</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>


  <ul id="menu" class="menu">
     
    <!--增加swiftype搜索功能-->
    <form class="menu-item menu-item-search">
      <input type="text" id="st-search-input" class="st-search-input st-default-search-input">
    </form>
    
    <script type="text/javascript">
      (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
      (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
      e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
      })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

      _st('install','yxUhPQ2aHyszT_1btxX9','2.0.0');
    </script>
    <!--增加swiftype搜索功能end-->
    
    
      
      <li class="menu-item menu-item-home">
        <a href="/">
          <i class="menu-item-icon icon-home"></i> <br>
          首页
        </a>
      </li>
    
      
      <li class="menu-item menu-item-categories">
        <a href="/categories">
          <i class="menu-item-icon icon-categories"></i> <br>
          分类
        </a>
      </li>
    
      
      <li class="menu-item menu-item-about">
        <a href="/about">
          <i class="menu-item-icon icon-about"></i> <br>
          关于
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="/archives">
          <i class="menu-item-icon icon-archives"></i> <br>
          归档
        </a>
      </li>
    
      
      <li class="menu-item menu-item-tags">
        <a href="/tags">
          <i class="menu-item-icon icon-tags"></i> <br>
          标签
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              大型分布式网站架构设计与实践
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2018-01-04
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="#comments">
              <span class="post-comments-count ds-thread-count" data-thread-key="2018/01/04/大型分布式网站架构设计与实践/"></span>
            </a>
          </span>
          
        

        <span class="post-count">字数统计8.6k字</span>
        <span class="post-comments-count">
        <span class="post-count">阅读时长30分钟</span>
      </span></div>
    </div>

    <div class="post-body">

      
      

      
        <h3 id="SOA和RPC">SOA和RPC</h3><p>随着互联网规模发展，面向服务的体系架构(SOA)成为主流的架构方式，各个系统之间通过服务的方式进行交互，这样保证了交互的标准性，这对于一个复杂的大规模系统来说显得尤为重要，子系统之间能够标准清晰地互相配合与沟通。同时，随着数据规模的飞速发展，从单一应用架构，再到拆分成多个子系统，演变成垂直应用架构，最后演变成分布式应用架构。此时，在一个分布式系统中，如何实现节点之间的RPC调用方式？如何实现服务的动态发现与路由？如何实现软件层面的负载均衡(4层还是7层更优)？这些都将成为我们要解决的问题。</p>
<h4 id="体系化认识RPC">体系化认识RPC</h4><p>远程过程调用(Remote Process Call): 简单地来说，就是client通过网络来调用server的地址空间上的函数/方法，就跟调本地方法一样简单便捷，这样就相当于扩展了client的能力。一个RPC框架的实现必须考虑的几个核心组件如下：  </p>
<h4 id="RPC组成部分">RPC组成部分</h4><ul>
<li><strong>传输协议</strong>：我们知道，七层网络协议栈中，从http到tcp，不过只是层层嵌套header而已，RPC传输的message可以只是TCP的body内容(也叫payload)，也可以是header+body，那么基于TCP还是基于HTTP来实现RPC呢？它们各有优劣：<ul>
<li>基于TCP可以更便于定制协议字段，减少网络传输字节数，降低网络开销，提高性能，增加并发数和吞吐量；这也带来实现代价高的问题</li>
<li>有利于跨平台的调用，因为json，xml这些传输标准是通用的，成熟的http框架也多，不比过于关心底层细节；不过由于是上层协议，传输需要占用的字节数多，导致传输效率低，往往通过使用Gzip压缩来优化</li>
</ul>
</li>
<li><strong>序列化和反序列化</strong>：也就是对象与二进制流(byte数组)之间的相互转化，如何高效稳定且能够跨平台地完成这个过程？也将成为设计中的考量，目前可选的有ProtoBuff，Hessian，bson等</li>
<li><strong>IO模型</strong>：选择一个合适的IO模型可以让server在更短时间内响应更多的请求，linux里的IO分为等待数据准备和把数据从内核拷贝到进程的两个阶段，严格意义上在《UNIX网络编程》中提到了5种，除了基于信号驱动的IO之外，还有以下几种：<ul>
<li><strong>Blocking IO</strong>：IO调用无响应时，CPU就也挂起等待，也就导致线程或者进程被IO阻塞</li>
<li><strong>Non-blocking IO</strong>：通过设置socket使其变为non-blocking，当用户进程发出read操作时，如果kernel中的数据还没有准备好，那么它并不会block用户进程，而是立刻返回一个error。用户进程其实是需要不断的主动询问kernel数据好了没</li>
<li><strong>IO-multiplexing</strong>：基于内核的epoll或者kqueue实现，引入一个代理线程来监听所有的TCP连接(IO请求)，有任何事件发生就通知用户态进行处理，避免用户态的CPU被IO阻塞；基本原理就是select/epoll这个function会不断的轮询所负责的所有socket，当某个socket有数据到达了，就通知用户进程。</li>
<li><strong>Async IO</strong>：理论上前3种都属于同步IO，异步IO是当进程发起IO请求之后，就直接返回，直到kernel IO操作完成之后发送一个信号告诉进程说IO完成，一般通过回调函数进行通知。</li>
<li><strong>阻塞与非阻塞区别</strong>：调用blocking IO会一直block住对应的进程直到操作完成，而non-blocking IO在kernel还在准备数据的情况下会立刻返回，然后不断轮询，不过拷贝数据过程是阻塞的。</li>
</ul>
</li>
<li><strong>进程/线程模型</strong>：</li>
<li><strong>协议结构</strong>：固定长度的header+playload</li>
<li><strong>可靠性和易用性</strong>：网络闪断时如何保持心跳？</li>
</ul>
<h5 id="基于TCP的RPC">基于TCP的RPC</h5><p>最简单的方式，例如基于Java Socket API实现RPC，一种非常典型的CS架构，client携带参数和调用方法名请求server，server使用一个while循环来监听客户端请求并予以处理；再往下延伸就涉及到当client请求并发数很大时，是用阻塞IO还是非阻塞IO？如何做服务路由以及负载均衡来将请求分发到多个server？轮询法？</p>
<h5 id="基于HTTP的RPC">基于HTTP的RPC</h5><p>基于HTTP一定程度上就是为了节省在底层细节上的关注，而可以去利用更高层的协议和现有的开源库去实现RPC，例如基于HttpClient库去实现RPC，基于json或者xml作为序列化之后的传输格式，当然这也会带来效率低，定制化程度低等弊端。</p>
<h5 id="RESTFul和RPC形式url">RESTFul和RPC形式url</h5><p>RESTFul把所有网络上的实体作为资源，具体的资源通过不同的格式作为表现层，例如图片的表现层可能是jpg，也可能是png；然后通过http协议的常用操作方式(例如GET、POST等)来改变和转换资源状态，也就是表现层转换  </p>
<p>而传统的RPC形式url会把操作类型、需要远程调用的服务接口名、参数都通过queryString携带到服务端，RESTFul则把操作类型放到了http请求方式中，使得url更加简洁，只留下一部分参数在url中</p>
<h5 id="RPC相关">RPC相关</h5><ol>
<li><a href="">RPC和HTTP之间区别</a>：HTTP 调用其实也可以看成是一种特殊的 RPC，只不过传统意义上的 RPC 是指长连接数据交互，而 HTTP(1.x) 一般是指即用即走的短链接; 当 HTTP 协议进化到 2.0 之后，Google 开源了一个建立在 HTTP2.0 协议之上的通信框架直接取名为 gRPC，也就是 Google RPC，这时 HTTP 和 RPC 之间已经没有非常明显的界限了</li>
</ol>
<h4 id="服务路由和负载均衡">服务路由和负载均衡</h4><p>所谓SOA，也就是把共用组件和共用逻辑提取成为可以复用的服务，这样一来，一个大型系统中的服务就会越来越多，如何通过服务路由来找到需要的服务以及通过负载均衡算法来均匀地将请求分配到一个服务集群下面对应的某台机器，就显得尤为重要。现在陆续使用zookeeper来做服务配置中心，取代原来的硬件负载均衡F5或者LVS/Nginx软件方案，避免单点故障，动态注册和下线服务。</p>
<h5 id="常用负载均衡算法">常用负载均衡算法</h5><ol>
<li><strong>轮询法与加权轮询</strong></li>
<li><strong>随机法与加权随机</strong></li>
<li><strong>源地址Hash法</strong>：对来源IP % Server数目，将同源IP请求分发到了同一台Server，有利于保持CS之间的Session会话，但是如果存在缓存，服务器上下线带来的雪崩需要考虑引进一致性哈希算法</li>
<li><strong>服务端最小连接数法</strong></li>
<li><strong>动态策略配置</strong>：服务端Groovy脚本动态加载或者Zookeeper Watch机制</li>
</ol>
<h5 id="Zookeeper">Zookeeper</h5><p>类似于一个精简版的文件系统，一种分布式集群中的协调系统，包括配置维护，名字服务，一致性与同步状态，动态服务注册，服务发现等；内部使用Zab协议提供一致性，leader与follower之间同步状态；基于Watcher机制，zookeeper维护的节点状态发生变化时，client会收到通知。</p>
<h5 id="Http服务网关">Http服务网关</h5><p>由于Http协议明文带来的不安全性，再加上随着互联网发展，多个client端需要复用同一套后端服务，需要考虑引入Http网关来作为安全权限校验模块，请求先到达网关，网关再去查询服务配置中心，找到对应的服务并调用，取出需要的数据返回给多个client；这样一来，服务就被隐藏，不再对外直接提供服务，网关就成为所有服务的所依赖的核心节点，流量相当于所有服务节点之和，那么网关集群的可扩展性和监控系统就显得尤为重要，一般我们可以选择网关与服务机器一对一的架构方式。</p>
<h3 id="分布式系统基础设施">分布式系统基础设施</h3><p>一个大型、稳健、成熟的分布式系统，包括许多部分。</p>
<h5 id="分布式缓存">分布式缓存</h5><ol>
<li>redis或者memcache，分布式对象缓存系统</li>
<li>一致性哈希引入虚拟节点，解决缓存雪崩和不均衡问题</li>
<li><strong>分布式session应用</strong>：在分布式系统中要保存session会话，传统做法会考虑用cookie来做同步，存在安全性和数据大小有限的问题；也可以考虑持久化到DB中，显然这会极大地影响到系统吞吐量；此时，我们考虑引入分布是缓存作为同步session的集群，它既可以放在web server集群之后，也可以放在之前，也就是sticky和non-sticky两种模式，达到多台server之间session共享与同步的效果，还能增加系统的容错性。</li>
</ol>
<h5 id="去IOE的持久化存储">去IOE的持久化存储</h5><ol>
<li><p><strong>MySQL拓展</strong>：传统关系型数据库在查询方式上非常完善，支持group，join，order等复杂方式，但是并不支持高并发访问和海量数据存储，为了应对规模扩展，在扩容上要做以下考虑与规划</p>
<ul>
<li>业务拆分：比如将表迁移到库</li>
<li>复制策略：常见的Dual-master架构，单个master可写，多个slave和stand by master只可读(提高并发读能力)，实现读写分离以及避免master单点故障，减少停机维护时间，也就是减少不可写时间</li>
<li>分表：水平切表，例如uid%256这种方式，将一张大表切成256张表，每张表记录数下降，可以提高查询效率</li>
<li>分库：然而以上方式都没法解决数据库并发写效率低的问题，此时就需要分库，同样采用Hash方式把数据拆分到多个库中</li>
<li>分库分表：带来查询性能和并发访问能力的提高，却要求必须指定路由字段进行查询，而且对于关联查询，分布式事务的支持都将成为新的问题</li>
</ul>
</li>
<li><p><strong>HBase</strong>：并发写入能力出色，因为具有多个region server；可用于处理海量数据存储，可扩展性和伸缩能力强；放弃关联查询，一致性，事务等复杂特性，可以通过ES等搜索引擎来实现组合查询</p>
<ul>
<li>构建在HDFS之上的一种列式存储数据库，数据以表的形式组织，每个表由行列组成，行列确定存储单元，每一列属于一个列族，并支持时间戳来标识多版本；表支持自动分裂成多个region</li>
</ul>
</li>
<li><p><strong>Redis</strong>：更好的读写吞吐能力，支持高并发，以及丰富的数据类型，可以提高高性能缓存服务</p>
</li>
</ol>
<h5 id="分布式消息队列">分布式消息队列</h5><p>主要用于系统之间的通信与解耦，异步通信机制可以提高系统的吞吐能力，而且在高峰期可以作为系统的缓冲存在。包括Kafka，ActiveMQ等。  </p>
<p>ActiveMQ(JMS)：JMS两种消息发送接收模型，一种是点对点之间的P2P模型，另一种是一对多广播时的发布订阅模型  </p>
<p>业务规模与并发请求数的提高，一方面需要我们进行垂直扩展，例如提升机器性能，优化内存配置，阻塞IO变NIO等。水平扩展方法包括水平拆分topic到多个broker中等方式。</p>
<h5 id="垂直化搜索引擎">垂直化搜索引擎</h5><ol>
<li><strong>Lucene</strong>：<ul>
<li>倒排索引：建立词和文档之间的映射关系</li>
<li>分词：中文分词包括CJKAnalyzer、MM分词、庖丁分词</li>
<li>相关性排序：</li>
<li>关键概念：</li>
</ul>
</li>
<li><strong>ElasticSearch</strong>：Elasticsearch是一个建立在全文搜索引擎 Apache Lucene™ 基础上的搜索引擎，可以说Lucene是当今最先进，最高效的全功能开源搜索引擎框架。Elasticsearch使用Lucene作为内部引擎，还提供以下功能：<ul>
<li>分布式实时文件存储，并将每一个字段都编入索引，使其可以被搜索。</li>
<li>实时分析的分布式搜索引擎。</li>
<li>可以扩展到上百台服务器，处理PB级别的结构化或非结构化数据。</li>
</ul>
</li>
</ol>
<h3 id="互联网安全架构">互联网安全架构</h3><h4 id="常见Web攻击手段和防御方法">常见Web攻击手段和防御方法</h4><h5 id="XSS跨站脚本攻击">XSS跨站脚本攻击</h5><p>没有对用户在表单输入的html代码做转义，把代码当做了数据保存，那么在页面重定向或者加载数据时就出现执行脚本的情况，从而盗取用户cookie，密码。  </p>
<p>可以通过urlEncode予以特殊字符串的处理来防止该攻击</p>
<h5 id="CRSF跨站请求伪造攻击">CRSF跨站请求伪造攻击</h5><p>攻击者盗用受信任用户的账号，伪装成受信任的请求访问网站，一般通过利用浏览器cookie实现。  </p>
<p>解决方法：把cookie设置成httpOnly，避免被脚本读取cookie；服务端生成定时过期的Token，每次请求都需要携带token，会话过期时token失效；设置请求的referer字段，标明该http请求的来源地址</p>
<h5 id="SQL注入攻击">SQL注入攻击</h5><p>把SQL命令伪装成请求参数传入到Server端，从而对数据库内容进行修改或者删库操作；例如传一个参数为’or ‘1’=’1，这样可以空密码登录。  </p>
<p>解决方法：使用预编译语句或者ORM框架，预先对特殊字符进行转义；哈希加盐法来避免密码明文存放，DB中保存Hash值和Salt值，每次对Key+Salt做指定摘要处理之后再合Server保存的值比对，避免彩虹表和穷举攻击；处理好异常信息和重定向页面，不暴露数据库等版本信息。</p>
<h5 id="文件上传漏洞">文件上传漏洞</h5><p>攻击者利用服务器不检测文件类型的漏洞，上传脚本或者木马文件进行攻击，或者上传大型文件把server当做免费存储使用，</p>
<p>解决方法：对文件类型进行白名单校验，通过比较文件开头几个字节内容(魔数)来判断；文件重命名防止找到文件路径；文件大小限制</p>
<h5 id="DDos分布式拒绝服务攻击">DDos分布式拒绝服务攻击</h5><ol>
<li>SYN Flood：TCP作为一个面向连接的协议，三次握手环节中的第二步，通过伪造IP发送大量的SYN报文给服务端，服务端处于SYN_RECV状态，不断重试轮询、分配资源，导致正常请求不能得到处理。</li>
<li>DNS Query Flood(UDP Flood)：向服务器发送大量的域名解析请求，随机生成域名，导致服务器不能读取缓存，而是层层往上读取，最终导致域名解析超时</li>
<li>CC攻击(Http Flood)：利用肉鸡或者http代理向服务器发送海量http请求，避开缓存或者需要大量的DB请求，从而拖垮业务处理系统，甚至DB</li>
<li>DNS域名劫持，CDN回源攻击，服务器权限提升，缓冲区溢出等其他攻击</li>
</ol>
<h4 id="常用安全算法">常用安全算法</h4><h5 id="数字摘要">数字摘要</h5><ol>
<li>MD5：为输入生成一个128位的摘要，作为数字指纹，利用它来验证消息的完整性；相似消息的摘要差异巨大，可逆性很小</li>
<li>SHA256：Secure Hash Algorithm，生成256位摘要</li>
</ol>
<p><strong>对摘要信息编码</strong>：因为摘要中可能存在无法显示的特殊字符穿，需要编码</p>
<ol>
<li>十六进制编码：把二进制数组转化成十六进制来表示</li>
<li>Base64：用64个可打印字符来表示二进制数据，64个字符分别是A-Z、a-z、0-9，还有2个因为系统不同而不一样</li>
</ol>
<h5 id="对称加密">对称加密</h5><p>加解密使用同一个密钥，计算量较小，速度较快，存在密码泄露风险。</p>
<ol>
<li>DES、3DES：64位密钥长度，从56位参与DES运算到扩大成3*56</li>
<li>AES：最低128位密钥长度</li>
</ol>
<h5 id="非对称加密">非对称加密</h5><p>使用私钥加密，然后对方用公钥解密，避免私钥在传输过程中泄露，往往用于保证数据完整性；或者先生成一对公钥私钥，然后广播公钥，对方用公钥加密之后发给自己，然后自己用私钥解密。</p>
<p>由于非对称加密速度慢，两种方式结合来达到更好的效果：先用对称加密对大文件进行加密，然后再对文件密钥使用非对称加密，也就是用公钥加密，然后发送给对方，对方再使用私钥解密，这样就防止了密钥泄露。</p>
<ol>
<li>RSA：基于数论事实，将两个大素数相乘十分容易，但是想要对其乘积进行因式分解却极其困难，因此可以将乘积公开作为加密密钥</li>
</ol>
<h5 id="数字签名(MD5withRSA_or_SHA256withRSA)">数字签名(MD5withRSA or SHA256withRSA)</h5><p>发送方将原文的MD5等摘要信息，用私钥进行加密得到密文，然后将原文和密文一起发送给对方，对方用公钥解密密文，得到摘要，判断其和原文的摘要(使用同样的摘要计算方法)是否一致；其中对摘要加密得到的就是数字签名，可以用于确保传输数据的完整性，防止被第三方篡改</p>
<h5 id="数字证书">数字证书</h5><p>类似于身份证书，用于标识网络中的身份；数字证书会携带公钥信息，数字签名等内容，一般由CA负责签发(也就是进行数字签名)，使用keytool、OpenSSL进行证书管理</p>
<h4 id="摘要认证">摘要认证</h4><p>为了防止通信过程中数据被篡改或者客户端伪造请求，因此利用摘要认证来对客户端身份，以及客户端请求参数等内容进行认证；之所以不采用https是因为性能成本以及需要额外申请CA证书；摘要认证本质上采用了对称加密手段，实现方式为：client和server采用同样的秘钥和摘要算法，将参数排序之后生成摘要，然后每次交互都带上内容和利用秘钥生成的摘要，每次对方都会进行摘要校验，确保内容未被篡改。</p>
<h4 id="签名认证">签名认证</h4><p>摘要认证存在secret泄露的安全问题，因为client和server使用同样的密钥；因此我们引入签名认证，也就是利用数字签名做认证，采用非对称加密手段，client采用密钥加密，然后server采用公钥解密，防止私钥泄露问题</p>
<h4 id="HTTPS协议(基于SSL的http协议)">HTTPS协议(基于SSL的http协议)</h4><p>尽管摘要认证和签名认证可以解决client和server之间身份认证问题和内容防篡改问题，但是由于http明文传输，如果进行抓包或者中途拦截，内容很容易被监听和暴露，因此我们需要https。  </p>
<p>https作为一种数字证书，包含公钥，数字签名，拥有者信息等内容。本质上就是在http和TCP之间加了一层安全层，采用SSL(安全套接层)或者TLS，来将内容加密。https支持单向认证和双向认证两种方式。一般像银行网银，支付宝这种都是双向认证。</p>
<p>SSL/TLS本身又包括两层，记录协议和握手协议，分别负责不同的工作。握手过程生成对称加密的密钥，并交换密钥。</p>
<h5 id="http和https区别">http和https区别</h5><ol>
<li>https = http + tls协议(从SSL演变到TLS, 都是一种传输层加密协议，位于应用层和传输层之间) + 传输加密 + 身份认证  —-&gt; 保证传输过程中的安全性，因为http传输的是明文内容，也不对传输双方进行身份验证<br>2.https保证以下三点:<ul>
<li>内容加密。浏览器到百度服务器的内容都是以加密形式传输，中间者无法直接查看原始内容。非对称密钥交换算法。建议优先使用 ECDHE，禁用 DHE，次优先选择 RSA；证书签名算法默认都是使用 RSA 签名；对称加解密算法。优先使用 AES-GCM 算法，针对 1.0 以上协议禁用 RC4；</li>
<li>身份认证。保证用户访问的是百度服务，即使被 DNS 劫持到了第三方站点，也会提醒用户没有访问百度服务，有可能被劫持。主要涉及到 PKI（公钥基础设施）和数字证书</li>
<li>数据完整性。防止内容被第三方冒充或者篡改。openssl 现在使用的完整性校验算法有两种：MD5或者SHA，由于 MD5 在实际应用中存在冲突的可能性比较大，尽量别用MD5来验证内容一致性。SHA 也不能使用 SHA0 和 SHA1，已被破解，建议使用 sha2 以上的安全哈希函数。</li>
</ul>
</li>
<li><strong>中间劫持</strong>：用户数据在浏览器和百度服务器中间传输必须要经过的节点。比如WIFI热点，路由器，防火墙，反向代理，缓存服务器等，都可能出现劫持。例如，运营商的内容劫持是如何进行的，运营商会分析你的网络请求，它可以先于网站回包，也能修改数据包的内容。所以它可以让你跳转一次，在网址上加上小尾巴，也能在你访问的页面弹出小广告</li>
</ol>
<h5 id="图解https"><a href="http://www.cnblogs.com/zhuqil/archive/2012/07/23/2604572.html" target="_blank" rel="noopener">图解https</a></h5><h5 id="https对性能的影响">https对性能的影响</h5><ol>
<li>HTTPS会降低用户访问速度(协议交互所增加的网络RTT(round trip time+加解密相关的计算耗时30ms)，增加网站服务器的计算资源消耗；非对称密钥交换很安全，但同时也是HTTPS性能和速度严重降低的“罪魁祸首”。</li>
</ol>
<h5 id="优化策略">优化策略</h5><h6 id="HTTPS_访问速度优化">HTTPS 访问速度优化</h6><ol>
<li><strong>Tcp fast open</strong>：HTTPS和HTTP使用TCP协议进行传输，也就意味着必须通过三次握手建立TCP连接，但一个RTT的时间内只传输一个 syn 包是不是太浪费？能不能在syn包发出的同时捎上应用层的数据？其实是可以的，这也是tcpfastopen的思路，简称TFO。遗憾的是 TFO需要高版本内核的支持，linux从3.7以后支持TFO，但是目前的windows系统还不支持TFO，所以只能在公司内部服务器之间发挥作用。</li>
<li><strong>Session resume</strong>：顾名思义就是复用session，实现简化握手<ul>
<li><strong>Session cache</strong> 的原理是使用 client hello 中的session id 查询服务端的sessioncache,如果服务端有对应的缓存，则直接使用已有的session信息提前完成握手，称为简化握手</li>
<li><strong>Session ticket</strong>的原理参考RFC4507。简述如下：server将session信息加密成ticket发送给浏览器，浏览器后续握手请求时会发送 ticket，server 端如果能成功解密和处理 ticket，就能完成简化握手。显然，session ticket 的优点是不需要服务端消耗大量资源来存储 session 内容。</li>
</ul>
</li>
<li><strong>HSTS(HTTP Strict Transport Security)</strong>。服务端返回一个HSTS的http header，浏览器获取到HSTS头部之后，在一段时间内，不管用户输入www.baidu.com还是<a href="http://www.baidu.com，都会默认将请求内部跳转成https://www.baidu.com。" target="_blank" rel="noopener">http://www.baidu.com，都会默认将请求内部跳转成https://www.baidu.com。</a></li>
<li>Ocsp stapling</li>
<li>False start:原理就是在 client_key_exchange 发出时将应用层数据一起发出来，能够节省一个 RTT</li>
<li>使用 SPDY 或者 HTTP2: SPDY 最大的特性就是多路复用，能将多个 HTTP 请求在同一个连接上一起发出去，不像目前的 HTTP 协议一样，只能串行地逐个发送请求。Pipeline 虽然支持多个请求一起发送，但是接收时依然得按照顺序接收，本质上无法解决并发的问题。</li>
</ol>
<h6 id="HTTPS_计算性能优化">HTTPS 计算性能优化</h6><ol>
<li>优先使用ECC椭圆加密算术相比普通的离散对数计算速度性能要强很多；对于 RSA 算法来讲，目前至少使用 2048 位以上的密钥长度才能保证安全性。ECC 只需要使用 224 位长度的密钥就能实现 RSA2048 位长度的安全强度。在进行相同的模指数运算时速度显然要快很多。</li>
<li>使用最新版的 openssl</li>
<li>TLS 硬件加速方案主要有两种：SSL 专用加速卡+ GPU SSL 加速。</li>
<li>TLS 远程代理计算</li>
</ol>
<h4 id="OAuth第三方授权—-开放资源授权的标准协议">OAuth第三方授权—-开放资源授权的标准协议</h4><p>旨在为用户资源的授权访问提供一个安全开放的标准，核心场景就是第三方登录。平台通过OAuth协议，提示用户对第三方授权使用部分用户数据，不需要触及用户名密码，就能给出授权。核心思想都是对用户资源做权限分级和隔离，ISV引导用户在平台端登录，完成授权，然后ISV就可以用用户的私有数据，且授权可取消。具体授权过程</p>
<h3 id="系统稳定性">系统稳定性</h3><p>一个系统要保持稳定，上线之前就需要有充分的压力测试，并做好容量预估，准备好应急预案，并且具备一定的日志分析和错误定位能力，以便于遇到线上各种问题时快速定位解决。</p>
<h4 id="在线日志分析">在线日志分析</h4><p>常用shell命令</p>
<h4 id="集群监控">集群监控</h4><ol>
<li><p>监控指标</p>
<ul>
<li><strong>load</strong>：特定时间间隔内CPU运行队列中的线程数，一般正常为3以内，到达5以上认为负载过高。可以使用top和uptime来查看average load。</li>
<li><strong>CPU利用率</strong>：各种时间占CPU总时间的比例。通过<code>top|grep cpu</code>查看各种状态占比，1查看不同核的CPU状态，<code>top -p pid</code>查看指定进程的CPU利用率，<code>shift+H</code>查看线程的cpu利用率。</li>
<li><strong>磁盘剩余空间</strong>：<code>df -h</code>, <code>du -sh</code></li>
<li><strong>网络traffic</strong>：<code>sar -n DEV 1 1</code> 抽样查看各个网卡的网络流量</li>
<li><strong>磁盘IO</strong>：IO密集型应用的瓶颈(例如数据库和文件系统)，<code>iostat -d -k</code>查看磁盘IO状况。</li>
<li><strong>内存使用</strong>：<code>free -m</code>，<code>vmstat</code></li>
<li><strong>QPS</strong>：每秒query数。根据压测和运维经验评估得到，代表了系统的业务繁忙程度。</li>
<li><strong>RT</strong>：请求响应时间。可以用缓存、CDN节点、内容压缩等方法来降低RT</li>
<li><strong>数据库相关参数</strong>：select/ps、update/ps、delete/ps来衡量不同类型的数据库操作指标，因为数据库读写耗费资源不同。</li>
<li><strong>JVM GC</strong>：Java stop the world引起的工作线程暂停响应问题，包括发生在老生带的缓慢major GC和新生代的快而频繁的Minor GC</li>
</ul>
</li>
<li><p>心跳检测: 分布式系统中机器规模大，从而导致故障概率增大，所以需要集群心跳检测机制来实时处理slave、master宕机等各种状况。当然也包括业务系统的心跳检测。</p>
<ul>
<li><strong>ping</strong>：使用的ICMP协议，检查网络链路是否畅通</li>
<li><strong>应用层检测</strong>：预留自检页面，监控系统用脚本执行<code>curl</code>命令看返回结果是不是可以访问；或者<code>curl -I</code>检查不同页面的返回header是否正常</li>
</ul>
</li>
<li>容量评估：总体PV分散到多个具体页面，评估需要的机器数量，带宽，然后用CDN缓存，网页静态化等措施降低访问延迟。根据八二原则，<code>峰值QPS=(总PV*80%) / (60*60*24*20%)</code>，需要的机器数等于峰值QPS除以单台机器极限QPS，而单台机器极限QPS需要根据RT要求和机器是否出现瓶颈来确定，一般是一个曲线；系统水位图作为实时监控指标。</li>
</ol>
<h4 id="流量控制">流量控制</h4><p>限制系统QPS，限制系统总并发请求数，引入白名单机制，引入分布式消息队列来将用户请求异步化，削峰填谷，这些都是流量控制的具体措施。</p>
<p>分布式系统的复杂导致互相依赖，引入依赖管理来分析依赖关系和各个部分的压力，采取降级措施来避免故障传递。区分服务的优先级，引入白名单和开关，必要时舍弃非核心服务。不同情况有不同的处理方案。</p>
<h4 id="高并发系统设计">高并发系统设计</h4><ol>
<li>原子操作：数据库事务，CAS操作，原子变量</li>
<li>多线程同步：synchronized和锁、可重入锁</li>
<li>数据一致性：CAP理论导致的三种程度的一致性</li>
<li>系统可扩展性：很方便地增加机器来水平扩展集群，来使得系统处理能力线性增长。</li>
<li>并发减库存案例：活动时瞬时QPS爆炸式增长，由于分布式缓存，数据库分库技术的引进，导致缓存和数据库之间难以实现事务，很容易出现缓存和数据库数据不一致导致的超卖和少卖现象，那么如何解决呢？将实际库存和浏览库存分离，一个在DB，一个在Cache，及时同步就行。DB采用innodb引擎，线程并发更新DB只需要行锁，进一步优化将行拆分，请求过来通过hash方式分发到不同的子行。</li>
</ol>
<h4 id="性能优化—-更少资源更快地服务更多用户">性能优化—-更少资源更快地服务更多用户</h4><ol>
<li>前端优化：YSlow分析网页性能，Firebug查看页面加载时间和请求响应时间，Java Btrace工具追踪耗时方法。<ul>
<li>优化页面http请求数量，包括合并样式和脚本文件</li>
<li>变化较少文件存储到CDN</li>
<li>启用Gzip压缩</li>
</ul>
</li>
<li>代码优化：单例模式减少系统开销，多线程和线程池，同步改异步，减少上下文切换，降低锁竞争</li>
<li>压缩与缓存：</li>
<li>GC日志分析：<ul>
<li>减少Full GC，-Xms等参数的配置，jmap定位代码错误</li>
</ul>
</li>
<li><p>数据库查询：MySQL慢SQL日志功能—-log_slow_queries。</p>
<ul>
<li>数据库索引优化，避免全表扫描</li>
<li>反范式设计，允许数据冗余，避免关联查询和全表扫描</li>
<li>使用查询缓存</li>
<li>换用搜索引擎来解决跨表查询和分组操作，引入KV存储来支持高并发读写</li>
</ul>
</li>
<li><p>系统资源状况：</p>
<ul>
<li>硬件性能提升，SSD盘，高内存，高吞吐网卡，多核和超线程技术</li>
</ul>
</li>
<li><p>性能测试工具：①ApacheBench可以模拟并发请求来测试服务器在高负载情况下支持的QPS和RT。②Apache JMeter不止于http测试。③反向代理引流来调节权重，灰度发布测试性能。④TCPCopy工具可以将线上真实请求复制到测试机器。</p>
</li>
<li>Java应用故障排查工具：<ul>
<li>jps查看JVM进程信息，例如进程主类对应的PID</li>
<li>jstat监控虚拟机运行状态，包括类加载、内存使用、垃圾回收等方面</li>
<li>jinfo查看程序的配置参数，查看和修改JVM运行时参数</li>
<li>jstack查看当前JVM所有线程的堆栈信息</li>
<li>jmap查看等待回收对象队列以及堆的概要信息、转储快照</li>
<li>BTrace用于在不改代码，不重启应用情况下动态查看程序运行细节</li>
<li>Jconsole连接本地或远程JVM，监视应用的性能和资源消耗情况</li>
<li>MAT分析Java对信息，Eclipse插件</li>
<li>VisualVM，啥也能干的JDK工具</li>
<li>案例分析：①内存OOM，利用VisualVM dump堆信息。②线程死锁或者信号量没释放，表现症状为CPU load低，但是请求响应超时，可以线程dump分析 ③类加载冲突</li>
</ul>
</li>
</ol>
<h3 id="大数据分析">大数据分析</h3><h4 id="分布式系统的日志收集(ELK等)">分布式系统的日志收集(ELK等)</h4><p>几种常用的日志收集方式：</p>
<ol>
<li>文件轮询机制定时读取整个日志文件</li>
<li>inotify机制读取日志修改事件，通过CMS写入消息队列，然后各种服务订阅收集，用作分析用途</li>
</ol>
<p>日志分发机制—-分布式消息队列，既可以解耦，也可以起到削峰填谷的缓冲效果</p>
<p>日志收集分析架构：inotify—&gt;消息队列—&gt;流式处理系统—&gt;存储—&gt;分析展现系统。参考框架Chukwa</p>
<h4 id="离线数据分析">离线数据分析</h4><p>对时间要求不高，分析完之后可以数据回流到DB提供实时在线查询服务。Hadoop的主要场景就是离线批处理数据。</p>
<h4 id="流式数据分析">流式数据分析</h4><p>storm是一种分布式实时计算系统，主要用来实时处理流式数据</p>
<h4 id="数据同步与报表">数据同步与报表</h4><ol>
<li>每天在OLTP系统负载最低时定时全量或者增量将数据从OLTP同步到OLAP系统，用于离线分析。</li>
<li>离线数据同步：sqoop开源数据同步工具，利用MR来完成DB和HDFS之间的数据同步和转换，效率很高。</li>
<li><p>实时数据同步：</p>
<ul>
<li>利用消息系统进行实时增量数据同步，其他系统订阅topic就行</li>
<li>类似mysql主从同步，通过binary log重放，变更同步</li>
</ul>
</li>
<li><p>数据报表：Highcharts</p>
</li>
</ol>
<h4 id="大数据生态系统">大数据生态系统</h4><ol>
<li>Hadoop = HDFS + YARN + MapReduce<ul>
<li>HDFS负责大数据存储，高可靠、高容错、高扩展、低成本、高吞吐的分布式文件系统</li>
<li>YARN负责资源调度，依然发挥重要作用</li>
<li>MapReduce并行编程模型和计算框架</li>
<li>Hbase主要解决实时海量数据查询问题</li>
<li>Hive和Pig主要解决数据处理和计算问题，分别以SQL形式和脚本形式，例如通过HiveSQL写SQL查询语句，会转化成MR操作，不实时，主要用于离线分析。</li>
<li><a href="https://www.zhihu.com/question/27974418/answer/156227565" target="_blank" rel="noopener">如何用形象的比喻描述大数据的技术生态？Hadoop、Hive、Spark 之间是什么关系？</a></li>
</ul>
</li>
</ol>
<h3 id="参考链接">参考链接</h3><ol>
<li><a href="http://blog.csdn.net/historyasamirror/article/details/5778378" target="_blank" rel="noopener">IO - 同步，异步，阻塞，非阻塞</a></li>
<li><a href="https://segmentfault.com/a/1190000003063859#articleHeader13" target="_blank" rel="noopener">四种IO与epoll</a></li>
<li><a href="">大数据分析相关工具</a></li>
</ol>

      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="../../../../tags/分布式系统/"> #分布式系统 </a>
          
            <a href="../../../../tags/阅读/"> #阅读 </a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="../../11/投资中最简单的事---读后随记/">投资中最简单的事---读后随记</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="../从Paxos到Raft/">从Raft到Paxos</a>
            
          </div>
        </div>
      

      
      
    </div>
  </div>



    
      <div class="comments" id="comments">
        
          <div class="ds-thread" data-thread-key="2018/01/04/大型分布式网站架构设计与实践/" data-title="大型分布式网站架构设计与实践" data-url="https://charles-xiao.github.io/2018/01/04/大型分布式网站架构设计与实践/">
          </div>
        
      </div>
    
  </div>


        </div>

        
        <!-- 多说热评文章-->
        <p>热评文章</p>
        <div class="ds-top-threads" data-range="weekly" data-num-items="4"></div>
        
      </div>


      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview">
        <div class="site-author motion-element">
          <img class="site-author-image" src="/images/avatar.jpg" alt="CharlesXiao">
          <p class="site-author-name">CharlesXiao</p>
        </div>
        <p class="site-description motion-element">在码农炼成之路不断挣扎……stay hungry……keep learning……</p>
        <div class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="../../../../archives">
              <span class="site-state-item-count">84</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="../../../../categories">
              <span class="site-state-item-count">17</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="../../../../tags">
              <span class="site-state-item-count">76</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </div>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
              <a href="https://github.com/Charles-Xiao" target="_blank">github</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://weibo.com/2262300105/profile?topnav=1&wvr=6" target="_blank">weibo</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://daijiale.github.io/" target="_blank">Daijiale的个人站点</a>
            </span>
            
          
        </div>

        
        

      </div>

      
        <div class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#SOA和RPC"><span class="nav-number">1.</span> <span class="nav-text">SOA和RPC</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#体系化认识RPC"><span class="nav-number">1.1.</span> <span class="nav-text">体系化认识RPC</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RPC组成部分"><span class="nav-number">1.2.</span> <span class="nav-text">RPC组成部分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#基于TCP的RPC"><span class="nav-number">1.2.1.</span> <span class="nav-text">基于TCP的RPC</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#基于HTTP的RPC"><span class="nav-number">1.2.2.</span> <span class="nav-text">基于HTTP的RPC</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RESTFul和RPC形式url"><span class="nav-number">1.2.3.</span> <span class="nav-text">RESTFul和RPC形式url</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RPC相关"><span class="nav-number">1.2.4.</span> <span class="nav-text">RPC相关</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务路由和负载均衡"><span class="nav-number">1.3.</span> <span class="nav-text">服务路由和负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#常用负载均衡算法"><span class="nav-number">1.3.1.</span> <span class="nav-text">常用负载均衡算法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Zookeeper"><span class="nav-number">1.3.2.</span> <span class="nav-text">Zookeeper</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Http服务网关"><span class="nav-number">1.3.3.</span> <span class="nav-text">Http服务网关</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分布式系统基础设施"><span class="nav-number">2.</span> <span class="nav-text">分布式系统基础设施</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#分布式缓存"><span class="nav-number">2.0.1.</span> <span class="nav-text">分布式缓存</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#去IOE的持久化存储"><span class="nav-number">2.0.2.</span> <span class="nav-text">去IOE的持久化存储</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#分布式消息队列"><span class="nav-number">2.0.3.</span> <span class="nav-text">分布式消息队列</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#垂直化搜索引擎"><span class="nav-number">2.0.4.</span> <span class="nav-text">垂直化搜索引擎</span></a></li></ol></li></ol><li class="nav-item nav-level-3"><a class="nav-link" href="#互联网安全架构"><span class="nav-number">3.</span> <span class="nav-text">互联网安全架构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#常见Web攻击手段和防御方法"><span class="nav-number">3.1.</span> <span class="nav-text">常见Web攻击手段和防御方法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#XSS跨站脚本攻击"><span class="nav-number">3.1.1.</span> <span class="nav-text">XSS跨站脚本攻击</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CRSF跨站请求伪造攻击"><span class="nav-number">3.1.2.</span> <span class="nav-text">CRSF跨站请求伪造攻击</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SQL注入攻击"><span class="nav-number">3.1.3.</span> <span class="nav-text">SQL注入攻击</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#文件上传漏洞"><span class="nav-number">3.1.4.</span> <span class="nav-text">文件上传漏洞</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#DDos分布式拒绝服务攻击"><span class="nav-number">3.1.5.</span> <span class="nav-text">DDos分布式拒绝服务攻击</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#常用安全算法"><span class="nav-number">3.2.</span> <span class="nav-text">常用安全算法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#数字摘要"><span class="nav-number">3.2.1.</span> <span class="nav-text">数字摘要</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#对称加密"><span class="nav-number">3.2.2.</span> <span class="nav-text">对称加密</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#非对称加密"><span class="nav-number">3.2.3.</span> <span class="nav-text">非对称加密</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#数字签名(MD5withRSA_or_SHA256withRSA)"><span class="nav-number">3.2.4.</span> <span class="nav-text">数字签名(MD5withRSA or SHA256withRSA)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#数字证书"><span class="nav-number">3.2.5.</span> <span class="nav-text">数字证书</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#摘要认证"><span class="nav-number">3.3.</span> <span class="nav-text">摘要认证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#签名认证"><span class="nav-number">3.4.</span> <span class="nav-text">签名认证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HTTPS协议(基于SSL的http协议)"><span class="nav-number">3.5.</span> <span class="nav-text">HTTPS协议(基于SSL的http协议)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#http和https区别"><span class="nav-number">3.5.1.</span> <span class="nav-text">http和https区别</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#图解https"><span class="nav-number">3.5.2.</span> <span class="nav-text">图解https</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#https对性能的影响"><span class="nav-number">3.5.3.</span> <span class="nav-text">https对性能的影响</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#优化策略"><span class="nav-number">3.5.4.</span> <span class="nav-text">优化策略</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#HTTPS_访问速度优化"><span class="nav-number">3.5.4.1.</span> <span class="nav-text">HTTPS 访问速度优化</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#HTTPS_计算性能优化"><span class="nav-number">3.5.4.2.</span> <span class="nav-text">HTTPS 计算性能优化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#OAuth第三方授权—-开放资源授权的标准协议"><span class="nav-number">3.6.</span> <span class="nav-text">OAuth第三方授权—-开放资源授权的标准协议</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#系统稳定性"><span class="nav-number">4.</span> <span class="nav-text">系统稳定性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#在线日志分析"><span class="nav-number">4.1.</span> <span class="nav-text">在线日志分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#集群监控"><span class="nav-number">4.2.</span> <span class="nav-text">集群监控</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#流量控制"><span class="nav-number">4.3.</span> <span class="nav-text">流量控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#高并发系统设计"><span class="nav-number">4.4.</span> <span class="nav-text">高并发系统设计</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#性能优化—-更少资源更快地服务更多用户"><span class="nav-number">4.5.</span> <span class="nav-text">性能优化—-更少资源更快地服务更多用户</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#大数据分析"><span class="nav-number">5.</span> <span class="nav-text">大数据分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#分布式系统的日志收集(ELK等)"><span class="nav-number">5.1.</span> <span class="nav-text">分布式系统的日志收集(ELK等)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#离线数据分析"><span class="nav-number">5.2.</span> <span class="nav-text">离线数据分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#流式数据分析"><span class="nav-number">5.3.</span> <span class="nav-text">流式数据分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据同步与报表"><span class="nav-number">5.4.</span> <span class="nav-text">数据同步与报表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#大数据生态系统"><span class="nav-number">5.5.</span> <span class="nav-text">大数据生态系统</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考链接"><span class="nav-number">6.</span> <span class="nav-text">参考链接</span></a></li></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </div>
      

    </div>
  </div>


    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">
  
  &copy; &nbsp;  2015.05.16 - 
  2018
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">CharlesXiao</span>
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_pv">
  本站访问次数:<span id="busuanzi_value_site_pv"></span>
</span>
</div>

<div class="theme-info">
  <span class="post-count">博客全站共165.6k字</span>
</div>
<!--
<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>
-->



      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="../../../../vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
  <script type="text/javascript" src="../../../../vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      $('.content img').each(function () {
        var $image = $(this);
        var $imageWrapLink = $image.parent('a');

        if ($imageWrapLink.size() < 1) {
          $imageWrapLink = $image.wrap('<a href="' + this.getAttribute('src') + '"></a>').parent('a');
        }
        $imageWrapLink.addClass('fancybox');
      });
    });
    $('.fancybox').fancybox({
      helpers: {
        overlay: {
          locked: false
        }
      }
    });
  </script>


  <script type="text/javascript">
  function hasMobileUA () {
    var nav = window.navigator;
    var ua = nav.userAgent;
    var pa = /iPad|iPhone|Android|Opera Mini|BlackBerry|webOS|UCWEB|Blazer|PSP|IEMobile|Symbian/g;

    return pa.test(ua);
  }

  function isDesktop () {
    return screen.width > 991 && !hasMobileUA();
  }

  function isTablet () {
    return screen.width < 992 && screen.width > 767 && hasMobileUA();
  }

  function isMobile () {
    return screen.width < 767 && hasMobileUA();
  }

  function escapeSelector (selector) {
    return selector.replace(/[!"$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, "\\$&")
  }
</script>

  

  <script type="text/javascript" src="../../../../vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="../../../../vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" id="motion.global">
  $(document).ready(function () {
    var body = $('body');
    var isSidebarVisible = false;
    var sidebarToggle = $('.sidebar-toggle');
    var sidebarToggleLine1st = $('.sidebar-toggle-line-first')
    var sidebarToggleLine2nd = $('.sidebar-toggle-line-middle');
    var sidebarToggleLine3rd = $('.sidebar-toggle-line-last');
    var sidebar = $('.sidebar');

    var SIDEBAR_WIDTH = '320px';
    var SIDEBAR_DISPLAY_DURATION = 300;

    var sidebarToogleLineStatusInit = {width: '100%', opacity: 1, left: 0, rotateZ: 0, top: 0};

    var sidebarToggleLine1stStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine1stStatusArrow = {width: '50%', rotateZ: '-45deg', top: '2px'};
    var sidebarToogleLine1stStatusClose = {width: '100%', rotateZ: '-45deg', top: '5px'};

    var sidebarToggleLine2ndStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine2ndStatusArrow = {width: '90%'};
    var sidebarToogleLine2ndStatusClose = {opacity: 0};

    var sidebarToggleLine3rdStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine3rdStatusArrow = {width: '50%', rotateZ: '45deg', top: '-2px'};
    var sidebarToogleLine3rdStatusClose = {width: '100%', rotateZ: '45deg', top: '-5px'};

    LogoAndMenuMotion();
    sidebatToggleMotion();
    postsListMotion();
    backToTopMotion();


    $(document)
      .on('sidebar.isShowing', function () {
        isDesktop() && body.velocity(
          {paddingRight: SIDEBAR_WIDTH},
          SIDEBAR_DISPLAY_DURATION
        );
        sidebarContentMotion();
      })
      .on('sidebar.isHiding', function () {});

    function LogoAndMenuMotion() {
      $.Velocity.RunSequence([
        { e: $('.brand'), p: { opacity: 1 }, o: { duration: 100 } },
        { e: $('.logo'), p: { opacity: 1, top: 0 }, o: { duration: 50} },
        
        { e: $('.logo-line-before i'), p: { translateX: "100%" }, o: { duration: 500, sequenceQueue: false } },
        { e: $('.logo-line-after i'), p: { translateX: "-100%" }, o: { duration: 500, sequenceQueue: false } },
        
        { e: $('.site-title'), p: { opacity: 1, top: 0 }, o: { duration: 200 } }
      ]);
      $('.menu-item').velocity('transition.slideDownIn', {display: null});
    }


    function backToTopMotion () {
      var b2top = $('.back-to-top');
      b2top.on('click', function () {
        body.velocity('scroll');
      });
    }

    function sidebarShowMotion () {

      sidebarToggleLine1st.velocity(sidebarToogleLine1stStatusClose);
      sidebarToggleLine2nd.velocity(sidebarToogleLine2ndStatusClose);
      sidebarToggleLine3rd.velocity(sidebarToogleLine3rdStatusClose);

      sidebar.velocity({width: SIDEBAR_WIDTH}, {
        display: 'block',
        duration: SIDEBAR_DISPLAY_DURATION,
        complete: function () {
          sidebar.addClass('sidebar-active');
          sidebar.trigger('sidebar.didShow');
        }
      });
      sidebar.trigger('sidebar.isShowing');
    }

    function sidebarHideMotion () {
      isDesktop() && body.velocity({paddingRight: 0});
      sidebar.velocity('reverse');

      sidebarToggleLine1st.velocity(sidebarToggleLine1stStatusInit);
      sidebarToggleLine2nd.velocity(sidebarToggleLine2ndStatusInit);
      sidebarToggleLine3rd.velocity(sidebarToggleLine3rdStatusInit);

      sidebar.removeClass('sidebar-active');
      sidebar.trigger('sidebar.isHiding');
    };

    function sidebarContentMotion () {
      $('.sidebar .motion-element').velocity(
        'transition.slideRightIn',
        {stagger: 50, drag: true}
      );
    }

    function postsListMotion () {
      var postMotionOptions = window.postMotionOptions || {stagger: 300, drag: true};
      $('.post').velocity('transition.slideDownIn', postMotionOptions);
    }

    function sidebatToggleMotion () {
      sidebarToggle.on('click', function () {
        isSidebarVisible ? sidebarHideMotion() : sidebarShowMotion();
        isSidebarVisible = !isSidebarVisible;
      });

      sidebarToggle.hover(function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusArrow);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusArrow);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusArrow);
      }, function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusInit);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusInit);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusInit);
      });
    }
  });

</script>





  
  
<script type="text/javascript" id="bootstrap.scrollspy.custom">
  /* ========================================================================
  * Bootstrap: scrollspy.js v3.3.2
  * http://getbootstrap.com/javascript/#scrollspy
  * ========================================================================
  * Copyright 2011-2015 Twitter, Inc.
  * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
  * ======================================================================== */

  /**
   * Custom by iissnan
   *
   * - Add a `clear.bs.scrollspy` event.
   * - Esacpe targets selector.
   */


  +function ($) {
    'use strict';

    // SCROLLSPY CLASS DEFINITION
    // ==========================

    function ScrollSpy(element, options) {
      this.$body          = $(document.body)
      this.$scrollElement = $(element).is(document.body) ? $(window) : $(element)
      this.options        = $.extend({}, ScrollSpy.DEFAULTS, options)
      this.selector       = (this.options.target || '') + ' .nav li > a'
      this.offsets        = []
      this.targets        = []
      this.activeTarget   = null
      this.scrollHeight   = 0

      this.$scrollElement.on('scroll.bs.scrollspy', $.proxy(this.process, this))
      this.refresh()
      this.process()
    }

    ScrollSpy.VERSION  = '3.3.2'

    ScrollSpy.DEFAULTS = {
      offset: 10
    }

    ScrollSpy.prototype.getScrollHeight = function () {
      return this.$scrollElement[0].scrollHeight || Math.max(this.$body[0].scrollHeight, document.documentElement.scrollHeight)
    }

    ScrollSpy.prototype.refresh = function () {
      var that          = this
      var offsetMethod  = 'offset'
      var offsetBase    = 0

      this.offsets      = []
      this.targets      = []
      this.scrollHeight = this.getScrollHeight()

      if (!$.isWindow(this.$scrollElement[0])) {
        offsetMethod = 'position'
        offsetBase   = this.$scrollElement.scrollTop()
      }

      this.$body
        .find(this.selector)
        .map(function () {
          var $el   = $(this)
          var href  = $el.data('target') || $el.attr('href')
          var $href = /^#./.test(href) && $(escapeSelector(href)) // Need to escape selector.

          return ($href
            && $href.length
            && $href.is(':visible')
            && [[$href[offsetMethod]().top + offsetBase, href]]) || null
        })
        .sort(function (a, b) { return a[0] - b[0] })
        .each(function () {
          that.offsets.push(this[0])
          that.targets.push(this[1])
        })


    }

    ScrollSpy.prototype.process = function () {
      var scrollTop    = this.$scrollElement.scrollTop() + this.options.offset
      var scrollHeight = this.getScrollHeight()
      var maxScroll    = this.options.offset + scrollHeight - this.$scrollElement.height()
      var offsets      = this.offsets
      var targets      = this.targets
      var activeTarget = this.activeTarget
      var i

      if (this.scrollHeight != scrollHeight) {
        this.refresh()
      }

      if (scrollTop >= maxScroll) {
        return activeTarget != (i = targets[targets.length - 1]) && this.activate(i)
      }

      if (activeTarget && scrollTop < offsets[0]) {
        $(this.selector).trigger('clear.bs.scrollspy')  // Add a custom event.
        this.activeTarget = null
        return this.clear()
      }

      for (i = offsets.length; i--;) {
        activeTarget != targets[i]
          && scrollTop >= offsets[i]
          && (!offsets[i + 1] || scrollTop <= offsets[i + 1])
          && this.activate(targets[i])
      }
    }

    ScrollSpy.prototype.activate = function (target) {
      this.activeTarget = target

      this.clear()

      var selector = this.selector +
        '[data-target="' + target + '"],' +
        this.selector + '[href="' + target + '"]'

      var active = $(selector)
        .parents('li')
        .addClass('active')

      if (active.parent('.dropdown-menu').length) {
        active = active
          .closest('li.dropdown')
          .addClass('active')
      }

      active.trigger('activate.bs.scrollspy')
    }

    ScrollSpy.prototype.clear = function () {
      $(this.selector)
        .parentsUntil(this.options.target, '.active')
        .removeClass('active')
    }


    // SCROLLSPY PLUGIN DEFINITION
    // ===========================

    function Plugin(option) {
      return this.each(function () {
        var $this   = $(this)
        var data    = $this.data('bs.scrollspy')
        var options = typeof option == 'object' && option

        if (!data) $this.data('bs.scrollspy', (data = new ScrollSpy(this, options)))
        if (typeof option == 'string') data[option]()
      })
    }

    var old = $.fn.scrollspy

    $.fn.scrollspy             = Plugin
    $.fn.scrollspy.Constructor = ScrollSpy


    // SCROLLSPY NO CONFLICT
    // =====================

    $.fn.scrollspy.noConflict = function () {
      $.fn.scrollspy = old
      return this
    }


    // SCROLLSPY DATA-API
    // ==================

    $(window).on('load.bs.scrollspy.data-api', function () {
      $('[data-spy="scroll"]').each(function () {
        var $spy = $(this)
        Plugin.call($spy, $spy.data())
      })
    })

  }(jQuery);
</script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var $sidebarInner = $('.sidebar-inner');
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.didShow', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;
          var self = this;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      $(indicator).velocity('stop').velocity({
        opacity: action === 'show' ? 0.4 : 0
      }, { duration: 100 });
    }

  });
</script>


  <script type="text/javascript" id="sidebar.nav">
    $(document).ready(function () {
      var html = $('html');

      $('.sidebar-nav li').on('click', function () {
        var item = $(this);
        var activeTabClassName = 'sidebar-nav-active';
        var activePanelClassName = 'sidebar-panel-active';
        if (item.hasClass(activeTabClassName)) {
          return;
        }

        var currentTarget = $('.' + activePanelClassName);
        var target = $('.' + item.data('target'));

        currentTarget.velocity('transition.slideUpOut', 200, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', 200)
            .addClass(activePanelClassName);
        });

        item.siblings().removeClass(activeTabClassName);
        item.addClass(activeTabClassName);
      });

      $('.post-toc a').on('click', function (e) {
        e.preventDefault();
        var offset = $(escapeSelector(this.getAttribute('href'))).offset().top;
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        });
      });

      // Expand sidebar on post detail page by default, when post has a toc.
      var $tocContent = $('.post-toc-content');
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0 && isDesktop()) {
        setTimeout(function () {
          $('.sidebar-toggle').trigger('click');
        }, 800);
      }
    });
  </script>




  
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  
  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"charles-xiao"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  


  

<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"3","bdPos":"left","bdTop":"250"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>



  

</body>
</html>
