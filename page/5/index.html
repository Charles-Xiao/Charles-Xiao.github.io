<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="//images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="//images/favicon-32x32-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="//images/favicon-16x16-next.png?v=6.5.0">


  <link rel="mask-icon" href="//images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="在码农炼成之路不断挣扎……stay hungry……keep learning……">
<meta property="og:type" content="website">
<meta property="og:title" content="CharlesXiao‘s Blog">
<meta property="og:url" content="https://charles-xiao.github.io/page/5/index.html">
<meta property="og:site_name" content="CharlesXiao‘s Blog">
<meta property="og:description" content="在码农炼成之路不断挣扎……stay hungry……keep learning……">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CharlesXiao‘s Blog">
<meta name="twitter:description" content="在码农炼成之路不断挣扎……stay hungry……keep learning……">






  <link rel="canonical" href="https://charles-xiao.github.io/page/5/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>CharlesXiao‘s Blog</title>
  






  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?6749450";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  ">
    <div class="headband"></div>
<!-- fork me github icon  -->
    <a href="https://github.com/Charles-Xiao" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">CharlesXiao‘s Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

    
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
    

  


  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input">
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'yxUhPQ2aHyszT_1btxX9','2.0.0');
</script>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://charles-xiao.github.io../../2017/12/09/Mysql 长连接与短连接/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CharlesXiao">
      <meta itemprop="description" content="在码农炼成之路不断挣扎……stay hungry……keep learning……">
      <meta itemprop="image" content="../../images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharlesXiao‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../2017/12/09/Mysql 长连接与短连接/" itemprop="url">
                  Mysql 长连接与短连接
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-12-09 16:36:53" itemprop="dateCreated datePublished" datetime="2017-12-09T16:36:53+08:00">2017-12-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-01-18 15:21:08" itemprop="dateModified" datetime="2018-01-18T15:21:08+08:00">2018-01-18</time>
              
            
          </span>

        <span class="post-meta-divider">|</span>
        <span class="post-count">字数统计1.3k字</span>
        <span class="post-meta-divider">|</span>
        <span class="post-count">阅读时长4分钟</span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="概念说明">概念说明</h4><ol>
<li><strong>短连接</strong>：是指程序和数据库通信时需要建立连接，执行操作后，连接关闭。短连接简单来说就是每一次操作数据库，都要打开和关闭数据库连接，基本步骤是：连接→数据传输→关闭连接。</li>
<li><strong>长连接</strong>：是指程序之间的连接在建立之后，就一直打开，被后续程序重用，基本步骤是：连接→数据传输→保持连接→数据传输……。使用长连接的初衷是减少连接的开销，尽管MySQL的连接比其他数据库要快得多。长连接在没有数据通信时，定时发送数据包，以维持连接状态。</li>
<li><strong>数据库连接池</strong>：是一些网络代理服务或应用服务器实现的特性，如J2EE服务器，它实现了一个持久连接的“池”，允许其他程序、客户端来连接，这个连接池将被所有连接的客户端共享使用，连接池可以节省打开数据库的时间，加速连接，也可以减少数据库连接，降低数据库服务器的负载；它是预先打开N个数据库连接，把它们缓存起来，当需要使用数据库的时候就直接使用这些已经打开的连接，节省时间</li>
<li><strong>J2EE数据库连接池的原理</strong>：<ul>
<li>J2EE服务器启动时会建立一定数量的池连接，并一直维持不少于此数目的池连接。</li>
<li>客户端程序需要连接时，池驱动程序会返回一个未使用的池连接并将其表记为忙。</li>
<li>如果当前没有空闲连接，池驱动程序就新建一定数量的连接，新建连接的数量由配置参数决定。</li>
<li>当使用的池连接调用完成后，池驱动程序将此连接表记为空闲，其他调用就可以使用这个连接。</li>
</ul>
</li>
</ol>
<h4 id="适用场景">适用场景</h4><ol>
<li><strong>长连接优劣势</strong><ul>
<li>从客户端的角度来说，使用长连接可以不用每次创建新连接，若客户端对MySQL服务器的连接请求很频繁，永久连接将更加高效。</li>
<li>从服务器的角度来看，情况则略有不同，它可以节省创建连接的开销，但维持连接也是需要内存的。如果滥用长连接的话，可能会使用过多的MySQL服务器连接。现代的操作系统可以拥有几千个MySQL连接，但很有可能绝大部分都是睡眠（sleep）状态的，这样的工作方式不够高效，而且连接占据内存，也会导致内存的浪费。</li>
</ul>
</li>
<li><strong>长连接主要用于在少数客户端与服务端的频繁通信</strong>，因为这时候如果用短连接频繁通信常会发生Socket出错，并且频繁创建Socket连接也是对资源的浪费；但是对于服务端来说，长连接也会耗费一定的资源，需要专门的线程（unix下可以用进程管理）来负责维护连接状态。</li>
<li><strong>长连接</strong>是一些驱动、驱动框架、ORM工具的特性，由驱动来保持连接句柄的打开，以便后续的数据库操作可以重用连接，从而减少数据库的连接开销。而<strong>连接池</strong>是应用服务器的组件，它可以通过参数来配置连接数、连接检测、连接的生命周期等。</li>
</ol>
<h4 id="注意事项">注意事项</h4><ol>
<li>我们一般使用mysql -uroot -p只不过是使用了管理员的身份来创建一个connection，从而登录mysql，mysql的连接过程，内部实际上是经过tcp/ip协议的，当然mysql封装了tcp/ip有自己的一套协议。mysql是会创建一个线程来处理到来的连接的，我们可以在mysql中show status;然后在连接mysql，再次show status就可以看到Thread_connected的数量会增加1</li>
<li>在生产繁忙的系统中，连接也可能会受到系统端口数的限制，如果要每秒建立几千个连接，那么连接断开后，端口不会被马上回收利用，必须经历一个“FIN”阶段的等待，直到可被回收利用为止，这样就可能会导致端口资源不够用。</li>
<li>如果客户端和MySQL数据库之间有连接池或Proxy代理，一般在客户端推荐使用短连接。对于长连接的使用一定要慎重，不可滥用</li>
<li>如果使用了长连接而长期没有对数据库进行任何操作，那么在timeout值(默认8小时)后，mysql server就会关闭此连接，而客户端在执行查询的时候就会得到一个类似于“MySQL server has gone away“这样的错误。在使用mysql_real_connect连接数据库之后，再使用mysql_options( &amp;mysql, MYSQL_OPT_RECONNECT, … ) 来设置为自动重连。</li>
</ol>
<h4 id="常用工具">常用工具</h4><ol>
<li>查看mysql连接数：<code>mysqladmin -uroot -p  processlist</code></li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://charles-xiao.github.io../../2017/12/09/如何实现多个数据库分片的list_objects操作/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CharlesXiao">
      <meta itemprop="description" content="在码农炼成之路不断挣扎……stay hungry……keep learning……">
      <meta itemprop="image" content="../../images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharlesXiao‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../2017/12/09/如何实现多个数据库分片的list_objects操作/" itemprop="url">
                  如何实现多个数据库分片的list_objects操作
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-12-09 16:36:53" itemprop="dateCreated datePublished" datetime="2017-12-09T16:36:53+08:00">2017-12-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-03-23 20:17:46" itemprop="dateModified" datetime="2018-03-23T20:17:46+08:00">2018-03-23</time>
              
            
          </span>

        <span class="post-meta-divider">|</span>
        <span class="post-count">字数统计2.5k字</span>
        <span class="post-meta-divider">|</span>
        <span class="post-count">阅读时长9分钟</span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="业务场景">业务场景</h4><p>我们需要实现一个类似于Linux中ls命令的功能，用户可以用该功能来查看的bucket里边object列表，这些object信息存储在mysql meta表和shard meta表中；正常情况下一个bucket中的所有object存储在一张meta表中；然而当一个bucket中的object数量十分庞大时，我们采用了水平分表的方式，将这些object通过哈希方式分散到了1024个shard meta表中，以避免单表行数过大带来的性能问题。  </p>
<p>因此，ls功能的实现需要考虑以上两种情景，分别是单表和多表的list；list功能需要支持delimiter来折叠文件夹(类似于linux中ls命令，根据该参数来决定是否展开当前目录下的子目录)，marker来指定每次查询的起始位置，maxKeys来指定每次返回数目，prefix来筛选出以前缀开头的object。单表list我们可以直接采用mysql order来保证结果有序；如果object分散在了1024个shard meta表中，要每次拿出前n个就比较困难了，因为数据只是单表有序的，要想全局有序，就还得做一些处理。</p>
<h4 id="分表hash方式">分表hash方式</h4><p>如何把很多object通过哈希方式分散到了1024个shard meta表中？如下代码所示，我们根据bucket和object构建一个url字符串，然后求MD5值，然后按4位做异或操作，最后对shard数目取模，就可以把object都随机分散到1024个表里了；MD5算法对原信息进行数学变换后得到的一个128位(bit)的特征码作为数据摘要，具有高度的离散性，原信息的一点点变化就会导致MD5的巨大变化。</p>
<pre><code><span class="function"><span class="keyword">void</span> <span class="title">GenUrl</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; bucket, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; object, <span class="built_in">std</span>::<span class="built_in">string</span>&amp; url)</span> </span>{
    url.append(<span class="string">"bs://"</span>);
    url.append(bucket);
    url.append(<span class="string">"/"</span>);
    url.append(object);
}

<span class="function"><span class="keyword">int32_t</span> <span class="title">GetShardKey</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;bucket, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;object)</span> </span>{
    <span class="built_in">std</span>::<span class="built_in">string</span> url = <span class="string">""</span>;
    GenUrl(bucket, object, url);
    <span class="built_in">std</span>::<span class="built_in">string</span> md5sum = MD5(url);
    <span class="keyword">const</span> <span class="keyword">uint32_t</span> *p = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">uint32_t</span>*&gt;(md5sum.data());
    <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">int32_t</span>&gt;((p[<span class="number">0</span>]^p[<span class="number">1</span>]^p[<span class="number">2</span>]^p[<span class="number">3</span>]) % BUCKET_SHARD_NUM);
}
</code></pre><h4 id="单表list">单表list</h4><ul>
<li><p><strong>解决方案</strong></p>
<ul>
<li>每次查询都是根据请求参数组装成一条SQL，查出需要的object  <code>select object, etag, size,…… from meta where bucket_id = * and shard_key = * order by object limit 0,1001</code></li>
<li>针对子文件夹的折叠处理：<ul>
<li>ls操作需要支持折叠文件夹操作，以免一个文件夹下边有很多子文件夹，而且子文件夹里有很多文件的时候，会导致多次ls也一直在一个子文件夹里边，支持折叠子文件夹，用户才可以ls出文件夹下边的所有子文件夹</li>
<li>解决方案：当遇到子文件夹中文件多的时候，每次都能list出指定数目的objects，这些objects可能都是一个子文件中的文件；因为用户需要折叠子文件夹，因此我们进行跳过子文件夹的处理，极端情况下这批objects都在一个子文件夹中，此时我们需要根据最后一个object name来判断是否在子文件中，如果该批objects在子文件中，此时我们会对下次查询的起始位置做一个++操作，确保下次查询跳过这个已经获取了的子文件夹；如此进行三次重试，至少保证一次请求可以拿出3个子文件夹给用户</li>
</ul>
</li>
<li>marker的处理：如果需要跳过文件夹，对marker++；例如正常情况下，object &gt; marker；如果要跳过文件夹，变成object &gt;= marker++</li>
</ul>
</li>
<li><p><strong>核心代码</strong></p>
<pre><code><span class="comment">// 需要跳过文件夹时对marker的处理</span>
<span class="built_in">string</span> BucketModel::ProcessMarkerWithDelimiter(<span class="keyword">const</span> <span class="built_in">string</span>&amp; marker,
                    <span class="keyword">const</span> <span class="built_in">string</span>&amp; prefix, <span class="keyword">char</span> delimiter) {
    <span class="comment">//prefix empty, or prefix not empty and marker start with prefix</span>
    <span class="keyword">if</span> (prefix.empty() || marker.compare(<span class="number">0</span>, prefix.length(), prefix) == <span class="number">0</span>) {
        size_t pos = marker.find_first_of(delimiter, prefix.length());
        <span class="built_in">string</span> new_marker;
        <span class="keyword">if</span> (<span class="built_in">std</span>::<span class="built_in">string</span>::npos != pos) {
            ++pos;
            new_marker = marker.substr(<span class="number">0</span>, pos);
            new_marker[new_marker.length()-<span class="number">1</span>]++;
            <span class="keyword">return</span> new_marker;
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> marker;
        }
    }
    <span class="keyword">return</span> marker;
}
</code></pre></li>
</ul>
<h4 id="多表list">多表list</h4><ul>
<li><p><strong>解决方案</strong></p>
<ul>
<li>利用Golang携程并发发送1024个shardMeta的list请求，也就是1024次SQL查询，拿到1024个请求结果之后，对结果做归并和提取处理，最终得出与单表listObject接口逻辑一致的结果。</li>
</ul>
</li>
<li><p><strong>核心代码</strong></p>
<pre><code>// merge two <span class="type">ObjectInfo</span> struct <span class="keyword">type</span> slice, max length <span class="keyword">is</span> maxKeys
func merge(maxKeys <span class="type">int</span>, left, right []<span class="type">ObjectInfo</span>) []<span class="type">ObjectInfo</span> {
    <span class="keyword">var</span> <span class="literal">result</span> []<span class="type">ObjectInfo</span>

    <span class="keyword">for</span> len(left) &gt; <span class="number">0</span> || len(right) &gt; <span class="number">0</span> {
        <span class="keyword">if</span> len(left) == <span class="number">0</span> {
            <span class="literal">result</span> = append(<span class="literal">result</span>, right...)
            <span class="keyword">break</span>
        }
        <span class="keyword">if</span> len(right) == <span class="number">0</span> {
            <span class="literal">result</span> = append(<span class="literal">result</span>, left...)
            <span class="keyword">break</span>
        }
        <span class="keyword">if</span> left[<span class="number">0</span>].<span class="type">Key</span> &lt;= right[<span class="number">0</span>].<span class="type">Key</span> {
            <span class="literal">result</span> = append(<span class="literal">result</span>, left[<span class="number">0</span>])
            left = left[<span class="number">1</span>:]
        } <span class="keyword">else</span> {
            <span class="literal">result</span> = append(<span class="literal">result</span>, right[<span class="number">0</span>])
            right = right[<span class="number">1</span>:]
        }
        <span class="keyword">if</span> len(<span class="literal">result</span>) &gt;= maxKeys {
            <span class="keyword">return</span> <span class="literal">result</span>[<span class="number">0</span>:maxKeys]
        }
    }
    <span class="keyword">if</span> len(<span class="literal">result</span>) &gt;= maxKeys {
        <span class="keyword">return</span> <span class="literal">result</span>[<span class="number">0</span>:maxKeys]
    }
    <span class="keyword">return</span> <span class="literal">result</span>
}
</code></pre></li>
<li><p><strong>方案重难点</strong></p>
<ul>
<li><p><strong>Cache嗅探机制</strong>：<br>List ShardMeta每次会通过VIP从Bucket取回1024个表数据，为了提高请求响应速度，当请求频率达到阈值时，这1024个表的数据会分别以ApiType+Bucket+ShardKey为key保存到Cache中，如何在充分利用Cache降低请求响应速度和对数据库压力的同时，也尽量减少与Cache之间的通信显得尤为重要。  </p>
<p>  在充分考虑了系统Cache的实现机制之后，设计了预读取方案来降低与Cache之间的通信次数，将1024个ShardMeta的请求任务队列切割出一小部分(10个)作为嗅探Cache的任务，多个goroutine并发去读Cache，如果嗅探Cache的ShardMeta都能读取到，说明Cache中能读到1024个表数据，可以继续读Cache，否则后续请求都直接请求数据库，不再读Cache，这样可以把每次List Shard请求<span style="color:red">读Cache的次数从1024次降低到10次</span>。  </p>
</li>
<li><p><strong>性能优化</strong>：<br>List ShardMeta是一个重请求，相当于所有操作开销都放大1024倍，然而又必须满足客户对耗时的要求，我主要从以下几个方面做了性能优化 </p>
<p>  <strong>减少互斥锁粒度，充分利用Golang atomic函数</strong>：在归并1024个表数据时，只给归并过程和写最终结果的少量代码加锁，利用atomic变量做全局信号量，保证变量操作的原子性  </p>
<p>  <strong>并发Goroutine发送请求和进行Json-Struct转换</strong>：利用Golang Goroutine给Bucket并发发请求，加快网络请求速度；归并结果时需要多次进行byte数组和Struct之间的转换，而Golang自带json库函数效率低，也将该过程利用Goroutine来并发完成，加快转换速度</p>
<p>  <strong>通过VIP分发请求</strong>：1024个请求如果并发到本机Bucket服务，会对本机服务造成巨大压力，而且由于单进程资源有限，会导致响应速度很慢。因此采用了将1024个请求发送给VIP的方式，均衡地分散到服务集群数千台机器上，保证了处理速度，降低了单机压力 </p>
</li>
<li><p><strong>异常处理机制</strong>：<br>List ShardMeta每次1024个数据库请求，如果有一个请求遇到网络超时等错误，返回结果不正常，就会导致整个请求返回结果有误；因此我采用了标志量和超时机制来实现异常处理，一旦单个请求出现异常，标志量置位TRUE，其他请求不再继续；同时采用Goroutine等待超时信号量的方式来处理超时情况，如果工作任务出现错误，一旦从任务通道取不到任务超过50ms，Goroutine自动结束操作，给用户返回错误提示</p>
</li>
</ul>
</li>
</ul>
<h4 id="json转换函数性能低的解决方案">json转换函数性能低的解决方案</h4><p>Golang自带json Unmarshal函数转化包含1000个obj的list object接口返回结果时，耗时10ms，效率很低；主要有<strong>两种解决方案</strong>：</p>
<ul>
<li>一种是减少转化次数以及缩小锁的范围，并发地去做转化</li>
<li>另一种是使用开源库，性能能够提升2-4倍，例如easyjson，ffjson</li>
</ul>
<h4 id="并发等待是等goroutine还是Channel">并发等待是等goroutine还是Channel</h4><p>Goroutine一般会结合WaitGroup来使用，wg相当于一个同步信号量，等到wg减到0，才开始下一步的逻辑</p>
<ul>
<li>如果wg等待goroutine，也就是说先给wg.add(Goroutine数目)，然后使用<code>defer this.wg.Done()</code>和<code>return</code>来指定当函数结束(也意味着Goroutine结束)时就给wg减一，这样能确保最终协程都结束时，wg也不再等待，开始下一步的逻辑</li>
<li>如果wg等待channel里边的任务，会存在一些异常问题，例如channel任务没被消费完，Goroutine都异常中止了，那么wg永远等不到减到0的那一刻，程序就会hang住了</li>
</ul>
<h4 id="耗时正比例增加因为多打了log">耗时正比例增加因为多打了log</h4><p>上线之后从某一天开始发现list请求耗时突增到上线时的6倍，非常奇怪，而且耗时随着每次请求数据量的增加而增加，经过git diff版本分析代码，发现是后续debug增加了几行日志打印，打印数据为每个shardMeta返回的数据，而且打印日志的代码被mutex互斥锁锁住，也就意味着每次要串行打印n个object数据，打印1024次，每次耗时10ms，从而导致耗时剧增；后来删除log之后耗时恢复到正常水平 </p>
<h4 id="Golang相关技术和踩坑">Golang相关技术和踩坑</h4><h5 id="defer和WaitGroup">defer和WaitGroup</h5><ol>
<li>在Golang中，defer表达式通常用来处理一些清理和释放资源的操作。defer后面的表达式会被放入一个列表中，在当前方法返回的时候，列表中的表达式就会被执行。一个方法中可以在一个或者多个地方使用defer表达式</li>
<li>defer表达式中变量的值在defer表达式被定义时就已经明确</li>
<li>defer表达式的调用顺序是按照先进后出的方式</li>
<li>defer还可以用于在 return 之后修改函数的返回值</li>
<li>Go语言中, panic用于抛出异常, recover用于捕获异常. </li>
</ol>
<h4 id="参考链接">参考链接</h4><p>1.<a href="https://xiaozhou.net/something-about-defer-2014-05-25.html" target="_blank" rel="noopener">Golang中defer的那些事</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://charles-xiao.github.io../../2017/12/07/Linux终端利器tmux指南/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CharlesXiao">
      <meta itemprop="description" content="在码农炼成之路不断挣扎……stay hungry……keep learning……">
      <meta itemprop="image" content="../../images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharlesXiao‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../2017/12/07/Linux终端利器tmux指南/" itemprop="url">
                  Linux终端利器tmux指南
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-12-07 22:36:53" itemprop="dateCreated datePublished" datetime="2017-12-07T22:36:53+08:00">2017-12-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2017-12-30 23:04:50" itemprop="dateModified" datetime="2017-12-30T23:04:50+08:00">2017-12-30</time>
              
            
          </span>

        <span class="post-meta-divider">|</span>
        <span class="post-count">字数统计1.4k字</span>
        <span class="post-meta-divider">|</span>
        <span class="post-count">阅读时长5分钟</span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="tmux简介">tmux简介</h4><p>tmux是BSD实现的Screen替代品，相对于Screen，它更加先进：支持屏幕切分，而且具备丰富的命令行参数，使其可以灵活、动态的进行各种布局和操作。它可以做到一条命令就启动起来(强大的配置)</p>
<h5 id="安装方法">安装方法</h5><table>
<thead>
<tr>
<th>系统</th>
<th>安装命令</th>
</tr>
</thead>
<tbody>
<tr>
<td>mac</td>
<td><code>brew install tmux</code>（前提需要安装homebrew)</td>
</tr>
<tr>
<td>ubuntu</td>
<td><code>sudo apt-get install tmux</code></td>
</tr>
<tr>
<td>centos</td>
<td><code>yum install -y tmux</code></td>
</tr>
<tr>
<td>其它</td>
<td>下载源码配置-编译-链接-安装</td>
</tr>
</tbody>
</table>
<h5 id="概念名词">概念名词</h5><p>在你输入tmux开启了tmux服务器后，会首先创建一个会话，而这个会话则会首先创建一个窗口，其中仅包含一个面板; 也就是说，这里看到的所谓终端控制台应该称作tmux的一个面板，虽然其使用方法与终端控制台完全相同。</p>
<table>
<thead>
<tr>
<th>概念</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>server服务器</td>
<td>输入tmux命令时就开启了一个服务器</td>
</tr>
<tr>
<td>session会话</td>
<td>一个服务器可以包含多个会话</td>
</tr>
<tr>
<td>window窗口</td>
<td>通过c-b-c创建，所有窗口的名称显示在底部状态栏上，一个会话可以包含多个窗口</td>
</tr>
<tr>
<td>pane面板</td>
<td>窗口里面的分屏，可通过c-b-%创建，一个窗口可以包含多个面板</td>
</tr>
</tbody>
</table>
<h5 id="使用场景和优点">使用场景和优点</h5><ol>
<li>tmux命令开启一个终端之后，可以在这个终端里开启多个windows，同时还可以把windows split成多个pane，并行工作</li>
<li>ssh登录远程主机的情景下，一旦ssh断开，那么当前账户登录的任务就被取消了，但是使用 tmux 可以在断开之后继续工作，下次登录可以查看</li>
</ol>
<h4 id="常用默认快捷键">常用默认快捷键</h4><p>tmux里边所有快捷键都默认以c-b作为前缀，也就是以ctrl+b开头，当然你也可以自行配置；</p>
<ol>
<li>基本命令<ul>
<li><code>tmux</code>创建一个tmux session</li>
<li><code>tmux new -s session_name</code>创建一个叫做session_name的 session</li>
<li><code>tmux ls\tmux list-sessions</code>列出现有的所有session</li>
<li><code>tmux info</code>列出所有的 session, window, pane, 运行的进程号等</li>
<li><code>tmux list-keys</code>列出所有可以的快捷键和其运行的 tmux 命令</li>
<li><code>tmux list-commands</code>列出所有的 tmux 命令及其参数</li>
<li><code>tmux at(attach) -t session_name</code>进入叫做session_name的session</li>
<li><code>tmux detach\c-b-d</code>离开当前开启的session</li>
<li><code>tmux kill-session -t session</code>关闭开启的session</li>
</ul>
</li>
<li><p>基本操作</p>
<ul>
<li><code>d</code>脱离并保存当前会话,可暂时返回Shell界面,tmux仍在后台运行</li>
<li><code>ctrl + z</code>挂起当前会话</li>
<li><code>s</code>选择并切换会话；在同时开启了多个会话时使用</li>
<li><code>D</code>选择要脱离的会话；在同时开启了多个会话时使用</li>
<li><code>:</code>进入命令行模式；此时可输入支持的命令，例如 kill-server 关闭所有tmux会话</li>
<li><code>t</code>显示当前的时间</li>
</ul>
</li>
<li><p>窗口操作</p>
<ul>
<li><code>c</code>创建新窗口</li>
<li><code>&amp;</code>关闭当前窗口</li>
<li><code>[0-9]</code>数字键切换到指定窗口</li>
<li><code>p</code>切换至上一窗口</li>
<li><code>n</code>切换至下一窗口</li>
<li><code>l</code>切换到最后使用的窗口</li>
<li><code>l</code>前后窗口间互相切换</li>
<li><code>w</code>通过窗口列表切换窗口</li>
<li><code>,</code>重命名当前窗口，便于识别</li>
<li><code>.</code>修改当前窗口编号，相当于重新排序</li>
<li><code>f</code>在所有窗口中查找关键词，便于窗口多了切换</li>
</ul>
</li>
<li>(面板)分屏操作<ul>
<li><code>?</code>显示快捷键帮助</li>
<li><code>&quot;</code>将当前面板上下分屏（建议设置成 |）</li>
<li><code>%</code>将当前面板左右分屏（建议设置成 -）</li>
<li><code>x</code>关闭当前分屏</li>
<li><code>q</code>显示面板编号</li>
<li><code>o</code>选择当前窗口中下一个面板</li>
<li><code>;</code>切换到最后一个使用的面板</li>
<li><code>方向键</code>移动光标选择对应面板</li>
<li><code>z</code>最大化当前所在面板</li>
<li><code>!</code>面板转变成窗口</li>
</ul>
</li>
</ol>
<h4 id="推荐配置">推荐配置</h4><p>如果你有个性化配置的需要，包括快捷键，状态栏等，那么修改~/.tmux.conf文件可以达到你的目的，让你用起来更符合自己的习惯; 也可以通过配置~/.bashrc每次ssh登录时都默认attach或者新建tmux会话</p>
<ol>
<li>tmux.conf配置快捷键，配色等</li>
</ol>
<pre><code># 开启鼠标生效
<span class="operator"><span class="keyword">set</span>-<span class="keyword">option</span> -g mouse <span class="keyword">on</span>

#设置前缀为Ctrl + x
<span class="keyword">set</span> -g prefix C-x
unbind C-b

# <span class="keyword">key</span> bindings <span class="keyword">for</span> horizontal <span class="keyword">and</span> vertical panes
unbind %
bind | split-window -h      # 使用|竖屏，方便分屏
unbind <span class="string">'"'</span>
bind - split-window -v      # 使用-横屏，方便分屏

# <span class="keyword">status</span> bar <span class="keyword">with</span> <span class="keyword">load</span> <span class="keyword">and</span> <span class="keyword">time</span>
<span class="keyword">set</span> -g <span class="keyword">status</span>-bg blue
<span class="keyword">set</span> -g <span class="keyword">status</span>-fg <span class="string">'#bbbbbb'</span>
<span class="keyword">set</span> -g <span class="keyword">status</span>-<span class="keyword">left</span>-fg green
<span class="keyword">set</span> -g <span class="keyword">status</span>-<span class="keyword">left</span>-bg blue
<span class="keyword">set</span> -g <span class="keyword">status</span>-<span class="keyword">right</span>-fg green
<span class="keyword">set</span> -g <span class="keyword">status</span>-<span class="keyword">right</span>-bg blue
<span class="keyword">set</span> -g <span class="keyword">status</span>-<span class="keyword">left</span>-length <span class="number">90</span>
<span class="keyword">set</span> -g <span class="keyword">status</span>-<span class="keyword">right</span>-length <span class="number">90</span>
<span class="keyword">set</span> -g <span class="keyword">status</span>-<span class="keyword">left</span> <span class="string">'[#(whoami)]'</span>
<span class="keyword">set</span> -g <span class="keyword">status</span>-<span class="keyword">right</span> <span class="string">'[#(date +" %m-%d %H:%M ")]'</span>
<span class="keyword">set</span> -g <span class="keyword">status</span>-justify <span class="string">"centre"</span>
<span class="keyword">set</span> -g window-<span class="keyword">status</span>-<span class="keyword">format</span> <span class="string">'#I #W'</span>
<span class="keyword">set</span> -g window-<span class="keyword">status</span>-<span class="keyword">current</span>-<span class="keyword">format</span> <span class="string">' #I #W '</span>
setw -g window-<span class="keyword">status</span>-<span class="keyword">current</span>-bg blue
setw -g window-<span class="keyword">status</span>-<span class="keyword">current</span>-fg green
# pane <span class="built_in">number</span> display
<span class="keyword">set</span> -g display-panes-active-colour colour33 #blue
<span class="keyword">set</span> -g display-panes-colour colour166 #orange
<span class="keyword">set</span> -g base-<span class="keyword">index</span> <span class="number">1</span>
<span class="keyword">set</span> -g pane-base-<span class="keyword">index</span> <span class="number">1</span>
<span class="keyword">set</span> -g display-<span class="keyword">time</span> <span class="number">3000</span>
<span class="keyword">set</span> -g history-<span class="keyword">limit</span> <span class="number">10000</span>

# copy-<span class="keyword">mode</span> 将快捷键设置为 vi 模式
setw -g <span class="keyword">mode</span>-keys vi

# 选中窗口
bind-<span class="keyword">key</span> k <span class="keyword">select</span>-pane -U
bind-<span class="keyword">key</span> j <span class="keyword">select</span>-pane -D
bind-<span class="keyword">key</span> h <span class="keyword">select</span>-pane -L
bind-<span class="keyword">key</span> l <span class="keyword">select</span>-pane -R</span>
</code></pre><ol>
<li><p>~/.bash_rc配置登录时自动进入tmux</p>
<pre><code>tmux_init(<span class="function">)</span>
{
    tmux<span class="instruction"> new-session </span>-s <span class="string">"xiaoyong"</span> -d -n <span class="string">"local"</span>    <span class="comment"># 开启一个会话</span>
    tmux<span class="instruction"> new-window </span>-n <span class="string">"other"</span>          <span class="comment"># 开启一个窗口</span>
    tmux split-window -h                <span class="comment"># 开启一个竖屏</span>
    tmux split-window -v                <span class="comment"># 开启一个横屏</span>
    tmux -2 attach-session -d           <span class="comment"># tmux -2强制启用256color，连接已开启的tmux</span>
}

<span class="comment"># 判断是否已有开启的tmux会话，没有则开启</span><span class="instruction">
if </span>which tmux 2&gt;&amp;1 &gt;/dev/null; then
    test -z <span class="string">"$TMUX"</span> &amp;&amp;<span class="function"> (</span>tmux attach || tmux_init<span class="function">)</span>
fi
</code></pre></li>
</ol>
<h4 id="参考链接">参考链接</h4><ol>
<li><a href="http://wdxtub.com/2016/03/30/tmux-guide/" target="_blank" rel="noopener">tmux指南</a></li>
<li><strong> tmux如何将内容复制到系统clipboard ? </strong> Mac下如果用 iterm2 可以在 preference 下选择 Applications in terminal may access  clipboard</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://charles-xiao.github.io../../2017/12/02/Mysql Init线程不安全问题/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CharlesXiao">
      <meta itemprop="description" content="在码农炼成之路不断挣扎……stay hungry……keep learning……">
      <meta itemprop="image" content="../../images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharlesXiao‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../2017/12/02/Mysql Init线程不安全问题/" itemprop="url">
                  Mysql初次Init线程不安全问题
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-12-02 11:36:53" itemprop="dateCreated datePublished" datetime="2017-12-02T11:36:53+08:00">2017-12-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2017-12-03 23:02:04" itemprop="dateModified" datetime="2017-12-03T23:02:04+08:00">2017-12-03</time>
              
            
          </span>

        <span class="post-meta-divider">|</span>
        <span class="post-count">字数统计1.1k字</span>
        <span class="post-meta-divider">|</span>
        <span class="post-count">阅读时长5分钟</span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="现象描述">现象描述</h4><p>沙盒测试时发现的这个问题，在程序启动时偶发core，而且不稳定复现，查看core信息会发现core在了mysql连接上；而且最后发现的规律是每次程序启动时，如果多线程获取数据库连接，就可能出现core。core信息如图所示:</p>
<p><img src="https://raw.githubusercontent.com/Charles-Xiao/Charles-Xiao.github.io/master/images/mysql_core.png" class="full-image"></p>
<h4 id="代码复现">代码复现</h4><p>在主线程内初始化mysql，在子线程内调用mysql_real_connect,就会导致coredump</p>
<pre><code><span class="variable">#include</span> <span class="subst">&lt;</span>mysql<span class="built_in">.</span>h<span class="subst">&gt;</span>
<span class="variable">#include</span> <span class="subst">&lt;</span>pthread<span class="built_in">.</span>h<span class="subst">&gt;</span>
<span class="literal">void</span><span class="subst">*</span> func(<span class="literal">void</span><span class="subst">*</span> arg)
{
    MYSQL<span class="subst">*</span> mysql <span class="subst">=</span> (MYSQL <span class="subst">*</span>)arg;
    mysql_real_connect(mysql, “<span class="number">127.0</span><span class="built_in">.0</span><span class="built_in">.1</span>″, “root”, “<span class="number">123456</span>″, “chen”, <span class="number">1234</span>, <span class="built_in">NULL</span>, <span class="number">0</span>);
    mysql_close(mysql);
    <span class="keyword">return</span> (<span class="literal">void</span> <span class="subst">*</span>)<span class="number">0</span>;
}

int main()
{
    MYSQL mysql;
    <span class="keyword">if</span> (<span class="built_in">NULL</span> <span class="subst">==</span> mysql_init(<span class="subst">&amp;</span>mysql))
    {
        <span class="keyword">return</span> <span class="subst">-</span><span class="number">1</span>;
    }
    pthread_t <span class="keyword">thread</span>;
    pthread_create(<span class="subst">&amp;</span><span class="keyword">thread</span>, <span class="built_in">NULL</span>, func, <span class="subst">&amp;</span>mysql);
    pthread_join(<span class="keyword">thread</span>, <span class="built_in">NULL</span>);
    <span class="keyword">return</span> <span class="number">0</span>;
}
</code></pre><h4 id="出现原因">出现原因</h4><p>如官网文档所说，当我们调用<code>mysql_real_connect()</code>函数去获取数据库连接时，需要先调用<code>mysql_init(MYSQL *mysql)函数</code>去获取一个MYSQL connection handler，然而mysql_init()不是完全线程安全的，但是只要成功调用一次后就线程安全了，如果有多线程并发调用mysql_init()，第一次init时如果刚好多线程并发调用，就会出core；为啥第一次调用mysql_init时线程不安全？我们可以来看看mysql源码:</p>
<ol>
<li><p>mysql.h文件预定义<code>mysql_library_init</code>函数</p>
<pre><code><span class="hexcolor">#def</span>ine mysql_library_init mysql_server_init
</code></pre></li>
<li><p>client.c文件定义<code>mysql_init</code>函数,并调用<code>mysql_server_init</code>函数</p>
<pre><code><span class="comment">// Init MySQL structure or allocate one</span>

MYSQL <span class="subst">*</span> STDCALL
mysql_init(MYSQL <span class="subst">*</span>mysql)
{
  <span class="keyword">if</span> (mysql_server_init(<span class="number">0</span>, <span class="built_in">NULL</span>, <span class="built_in">NULL</span>))
    <span class="keyword">return</span> <span class="number">0</span>;
  <span class="keyword">if</span> (<span class="subst">!</span>mysql)
  {
    <span class="keyword">if</span> (<span class="subst">!</span>(mysql<span class="subst">=</span>(MYSQL<span class="subst">*</span>) my_malloc(sizeof(<span class="subst">*</span>mysql),MYF(MY_WME <span class="subst">|</span> MY_ZEROFILL))))
    {
      set_mysql_error(<span class="built_in">NULL</span>, CR_OUT_OF_MEMORY, unknown_sqlstate);
      <span class="keyword">return</span> <span class="number">0</span>;
    }
    mysql<span class="subst">-&gt;</span>free_me<span class="subst">=</span><span class="number">1</span>;
  }
  <span class="keyword">else</span>
    memset(mysql, <span class="number">0</span>, sizeof(<span class="subst">*</span>(mysql)));
  mysql<span class="subst">-&gt;</span>charset<span class="subst">=</span>default_client_charset_info;
  strmov(mysql<span class="subst">-&gt;</span>net<span class="built_in">.</span>sqlstate, not_error_sqlstate);

  <span class="comment">/*
    Only enable LOAD DATA INFILE by default if configured with option
    ENABLED_LOCAL_INFILE
  */</span>

<span class="variable">#if</span> defined(ENABLED_LOCAL_INFILE) <span class="subst">&amp;&amp;</span> <span class="subst">!</span>defined(MYSQL_SERVER)
  mysql<span class="subst">-&gt;</span>options<span class="built_in">.</span>client_flag<span class="subst">|=</span> CLIENT_LOCAL_FILES;
<span class="variable">#endif</span>

<span class="variable">#ifdef</span> HAVE_SMEM
  mysql<span class="subst">-&gt;</span>options<span class="built_in">.</span>shared_memory_base_name<span class="subst">=</span> (char<span class="subst">*</span>) def_shared_memory_base_name;
<span class="variable">#endif</span>

  mysql<span class="subst">-&gt;</span>options<span class="built_in">.</span>methods_to_use<span class="subst">=</span> MYSQL_OPT_GUESS_CONNECTION;
  mysql<span class="subst">-&gt;</span>options<span class="built_in">.</span>report_data_truncation<span class="subst">=</span> <span class="literal">TRUE</span>;  <span class="comment">/* default */</span>

  mysql<span class="subst">-&gt;</span>reconnect<span class="subst">=</span> <span class="number">0</span>;

  mysql<span class="subst">-&gt;</span>options<span class="built_in">.</span>secure_auth<span class="subst">=</span> <span class="literal">TRUE</span>;

  <span class="keyword">return</span> mysql;
}
</code></pre></li>
<li><p>libmysql.c文件定义<code>mysql_server_init</code>函数, 问题就出在这个函数,用了<code>mysql_client_init</code>这个标记量来判断是否需要调用<code>my_thread_init</code>函数，如果<code>mysql_client_init==1</code>就直接为每个线程初始化私有变量，否则会先去初始化一些全局性的系统函数，资源和变量; 所以如果第一次init时出现多线程并发情景，线程A将<code>mysql_client_init</code>变量置为1，紧接着初始化全局资源，与此同时线程B走了else分支，直接开始调用<code>my_thread_init</code>函数，此时就会报错了，core由此产生。</p>
<pre><code><span class="type">int</span> <span class="type">STDCALL</span> mysql_server_init(<span class="type">int</span> argc __attribute__((unused)),
                  <span class="type">char</span> **argv __attribute__((unused)),
                  <span class="type">char</span> **groups __attribute__((unused)))
{
  <span class="type">int</span> <span class="literal">result</span>= <span class="number">0</span>;
  <span class="keyword">if</span> (!mysql_client_init)
  {
    mysql_client_init=<span class="number">1</span>;
    org_my_init_done=my_init_done;
    <span class="keyword">if</span> (my_init())                /* <span class="type">Will</span> init threads */
      <span class="keyword">return</span> <span class="number">1</span>;
    init_client_errs();
    <span class="keyword">if</span> (mysql_client_plugin_init())
      <span class="keyword">return</span> <span class="number">1</span>;
    <span class="keyword">if</span> (!mysql_port)
    {
      <span class="type">char</span> *env;
      struct servent *serv_ptr __attribute__((unused));

      mysql_port = <span class="type">MYSQL_PORT</span>;

      /*
        <span class="keyword">if</span> builder specifically requested a default port, use that
        (even <span class="keyword">if</span> it coincides <span class="keyword">with</span> our factory default).
        only <span class="keyword">if</span> they didn't <span class="keyword">do</span> we check /etc/services (<span class="keyword">and</span>, failing
        on that, fall back to the factory default <span class="keyword">of</span> <span class="number">3306</span>).
        either default can be overridden by the environment variable
        <span class="type">MYSQL_TCP_PORT</span>, which <span class="keyword">in</span> turn can be overridden <span class="keyword">with</span> command
        line options.
      */

<span class="comment">#if MYSQL_PORT_DEFAULT == 0</span>
      <span class="keyword">if</span> ((serv_ptr= getservbyname(<span class="string">"mysql"</span>, <span class="string">"tcp"</span>)))
        mysql_port= (<span class="type">uint</span>) ntohs((ushort) serv_ptr-&gt;s_port);
<span class="comment">#endif</span>
      <span class="keyword">if</span> ((env= getenv(<span class="string">"MYSQL_TCP_PORT"</span>)))
        mysql_port=(<span class="type">uint</span>) atoi(env);
    }

    <span class="keyword">if</span> (!mysql_unix_port)
    {
      <span class="type">char</span> *env;
<span class="comment">#ifdef __WIN__</span>
      mysql_unix_port = (<span class="type">char</span>*) <span class="type">MYSQL_NAMEDPIPE</span>;
<span class="comment">#else</span>
      mysql_unix_port = (<span class="type">char</span>*) <span class="type">MYSQL_UNIX_ADDR</span>;
<span class="comment">#endif</span>
      <span class="keyword">if</span> ((env = getenv(<span class="string">"MYSQL_UNIX_PORT"</span>)))
    mysql_unix_port = env;
    }
    mysql_debug(<span class="type">NullS</span>);
<span class="comment">#if defined(SIGPIPE) &amp;&amp; !defined(__WIN__)</span>
    (<span class="type">void</span>) signal(<span class="type">SIGPIPE</span>, <span class="type">SIG_IGN</span>);
<span class="comment">#endif</span>
<span class="comment">#ifdef EMBEDDED_LIBRARY</span>
    <span class="keyword">if</span> (argc &gt; -<span class="number">1</span>)
       <span class="literal">result</span>= init_embedded_server(argc, argv, groups);
<span class="comment">#endif</span>
  }
  <span class="keyword">else</span>
    <span class="literal">result</span>= (<span class="type">int</span>)my_thread_init();         /* <span class="type">Init</span> <span class="keyword">if</span> new thread */
  <span class="keyword">return</span> <span class="literal">result</span>;
}
</code></pre></li>
<li><p>官方文档</p>
<ul>
<li><p><a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-real-connect.html" target="_blank" rel="noopener"><code>mysql_real_connect()</code></a> attempts to establish a connection to a MySQL database engine running on host. mysql_real_connect() must complete successfully before you can execute any other API functions that require a valid MYSQL connection handler structure.  </p>
</li>
<li><p><a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-init.html" target="_blank" rel="noopener"><code>MYSQL *mysql_init(MYSQL *mysql)</code></a>  </p>
<p>  Allocates or initializes a MYSQL object suitable for <code>mysql_real_connect()</code>. If mysql is a NULL pointer, the function allocates, initializes, and returns a new object. Otherwise, the object is initialized and the address of the object is returned. If <code>mysql_init()</code> allocates a new object, it is freed when <code>mysql_close()</code> is called to close the connection.  </p>
<p>  In a nonmulti-threaded environment, <code>mysql_init()</code> invokes <code>mysql_library_init()</code> automatically as necessary. However, <code>mysql_library_init()</code> is not thread-safe in a multi-threaded environment, and thus neither is <code>mysql_init()</code>. Before calling <code>mysql_init()</code>, either call <code>mysql_library_init()</code> prior to spawning any threads, or use a mutex to protect the <code>mysql_library_init()</code> call. This should be done prior to any other client library call.</p>
</li>
</ul>
</li>
</ol>
<h4 id="解决方案">解决方案</h4><ol>
<li>每一次连接数据库时都先后加锁调用mysql_init()和mysql_real_connect()，确保init先于connect函数被调用过，而且不会被其他线程并发调用，以免初次连接数据库时多线程并发导致core</li>
<li>在程序启动时先全局调用一次mysql_init()函数，确保初次调用mysql_init时是线程安全的，之后的调用mysql_real_connect函数就不会出core</li>
<li>MySQL提供了线程安全的库libmysql_r，可以考虑替换原来的线程不安全的libmysql库</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://charles-xiao.github.io../../2017/11/11/C++基础/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CharlesXiao">
      <meta itemprop="description" content="在码农炼成之路不断挣扎……stay hungry……keep learning……">
      <meta itemprop="image" content="../../images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharlesXiao‘s Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="../../2017/11/11/C++基础/" itemprop="url">
                  C++基础
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-11-11 11:36:53" itemprop="dateCreated datePublished" datetime="2017-11-11T11:36:53+08:00">2017-11-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-01-03 16:39:45" itemprop="dateModified" datetime="2019-01-03T16:39:45+08:00">2019-01-03</time>
              
            
          </span>

        <span class="post-meta-divider">|</span>
        <span class="post-count">字数统计5.4k字</span>
        <span class="post-meta-divider">|</span>
        <span class="post-count">阅读时长19分钟</span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="基础语法">基础语法</h3><ol>
<li>在C和C++语言中的全局变量和静态变量都是会自动初始化为0，堆和栈中的局部变量不会初始化而拥有不可预测的值。 C++保证了所有对象与对象成员都会初始化，但其中基本数据类型的初始化还得依赖于构造函数。</li>
<li>在C语言中int a;表示声明了整型a但未初始化，而C++中的对象总是会被初始化的，无论是否写了圆括号或者是否写了参数列表；定义基本数据类型变量（单个值、数组）的同时可以指定初始值，如果未指定C++会去执行默认初始化(default-initialization)。<a href="http://harttle.land/2015/10/05/cpp-variable-init.html" target="_blank" rel="noopener">变量初始化</a></li>
<li><a href="https://blog.csdn.net/bzhxuexi/article/details/19899803" target="_blank" rel="noopener">size_t,ssize_t,int和long的区别</a></li>
<li><code>gcc test.c -o test</code>编译指令分为四个阶段进行，即预处理(也称预编译，Preprocessing, 把头文件内容真正引入cpp文件中)、编译(Compilation生成汇编代码.s文件)、汇编 (Assembly编译为目标文件.o)和连接(Linking包括静态连接库中需要的库文件)。<a href="http://www.ruanyifeng.com/blog/2018/01/assembly-language-primer.html" target="_blank" rel="noopener">汇编语言入门教程</a></li>
<li>函数库分为<strong>静态库和动态库</strong>两种。静态库在程序编译时会被连接到目标代码中，程序运行时将不再需要该静态库。动态库在程序编译时并不会被连接到目标代码中，而是在程序运行是才被载入，因此在程序运行时还需要动态库存在。无论静态库，还是动态库，都是由.o文件创建的。<ul>
<li>.o 一个.c或.cpp文件对应一个.o文件, 也就是编译器编译cpp源代码文件生成的目标文件</li>
<li>.a是静态库，是好多个.o合在一起，多个.a可以链接生成一个可执行文件；静态库文件名的命名规范是以lib为前缀，紧接着跟静态库名，扩展名为.a</li>
<li>.so是动态库，文件名命名规范和静态库文件名命名规范类似，也是在动态库名增加前缀lib，但其文件扩展名为.so</li>
<li>默认情况下， GCC在链接时优先使用动态链接库，只有当动态链接库不存在时才考虑使用静态链接库，如果需要的话可以在编译时加上-static选项，强制使用静态链接库。</li>
</ul>
</li>
</ol>
<h3 id="智能指针boost::scoped_ptr/std::auto_ptr">智能指针boost::scoped_ptr/std::auto_ptr</h3><p>boost::scoped_ptr和std::auto_ptr（已被C++11废弃）非常类似，是一个简单的智能指针，它能够保证在离开作用域后对象被自动释放，避免由于忘记手动调用delete而造成内存泄漏。实现原理都是利用了一个栈上的对象去管理一个堆上的对象，从而使得堆上的对象随着栈上的对象销毁时自动删除。  </p>
<h4 id="两者区别">两者区别</h4><ol>
<li><strong>不能转换所有权</strong>：boost::scoped_ptr所管理的对象生命周期仅仅局限于一个区间（该指针所在的”{}”之间），无法传到区间之外，无法拷贝。这就意味着boost::scoped_ptr对象是不能作为函数的返回值的（std::auto_ptr可以）。</li>
<li><strong>不能共享所有权</strong>：这点和std::auto_ptr类似。这个特点一方面使得该指针简单易用。另一方面也造成了功能的薄弱——不能用于stl的容器中。</li>
<li><strong>不能用于管理数组对象</strong>：由于boost::scoped_ptr是通过delete来删除所管理对象的，而数组对象必须通过deletep[]来删除，因此boost::scoped_ptr是不能管理数组对象的，如果要管理数组对象需要使用boost::scoped_array类。</li>
<li>如何在他们之间取舍取决于是否需要转移所管理的对象的所有权（如是否需要作为函数的返回值）。如果没有这个需要的话，大可以使用boost::scoped_ptr，让编译器来进行更严格的检查，来发现一些不正确的赋值操作。</li>
</ol>
<h3 id="C++_显式类型转换">C++ 显式类型转换</h3><blockquote>
<figure class="highlight plain"><figcaption><span>分别为转换方式，目标类型，被转换的值。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1. ```static_cast&lt;type&gt;(expression)```: 不提供运行时的检查的类型转换方式</span><br><span class="line">	* 主要用于父类和子类之间指针和引用的转换；进行上行转换，把子类对象的指针/引用转换为父类指针/引用，这种转换是安全的；进行下行转换，把父类对象的指针/引用转换成子类指针/引用，这种转换是不安全的</span><br><span class="line">	* 用于基本数据类型之间的转换，例如把int转char，int转enum等，需要编写程序时来确认安全性</span><br><span class="line">	* 把void指针转换成目标类型的指针（这是极其不安全的）</span><br><span class="line"></span><br><span class="line">2. ```dynamic_cast&lt;type&gt;(expression)```: 在运行时检查类型转换是否合法，具有一定的安全性，额外消耗一些性能；仅适用于指针或引用转换，若指针转换失败，则返回空指针，若引用转换失败，则抛出异常。经常用于将指针转换为void*: ```A *pA = new A; void *pV = dynamic_cast&lt;void *&gt;(pA);</span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">4. ```reinterpret_cast```非常激进的指针类型转换，在编译期完成，可以转换任何类型的指针，所以极不安全。非极端情况不要使用。</span><br><span class="line"></span><br><span class="line">### 守护进程</span><br><span class="line">#### Supervisor</span><br><span class="line">1. Supervisor是一个C/S系统， 允许用户监控和管理一系列运行于类Unix系统上的进程。通常，我们使用Supervisor将一个普通的命令行进程变为后台daemon，并监控这一些进程，以便这些进程在意外退出后能够重新启动。</span><br><span class="line">2. Supervisor有以下优点：</span><br><span class="line">	* 简单， ini风格的配置文件，容易阅读，对每个进程都提供了许多选项以便失败重启和日志轮替。</span><br><span class="line">	* 集中，一站式的进程启动，停止，监控平台。进程可以单独管理或分组管理，更提供了Web管理界面。</span><br><span class="line">	* 高效，通过fork/exec启动子进程且子进程不会进入守护模式，当子进程意外终止时，操作系统会立即发送信号给Supervisor，而不像其他方案那样，需要通过PID轮询。</span><br><span class="line">	* 可扩展，拥有非常简单的事件通知协议，任何编程语言程序都能监控它，也提供了XML-RPC管理接口，也为Python开发者预留了扩展空间。</span><br><span class="line">兼容性，除了Windows，几乎可以运行于任何操作系统，已经测试过的包括Linux, Mac OS X, Solaris, 和 FreeBSD。</span><br><span class="line">	* 久经考验，虽然开发非常活跃，但Supervisor并不是新软件，它已经存在多年，广泛运行于许多服务器上。</span><br><span class="line"></span><br><span class="line">#### systemd</span><br><span class="line">1. Systemd是一个Linux操作系统下的系统和服务管理器。它被设计成向后兼容SysV启动脚本，并提供了大量的特性，如开机时平行启动系统服务，按需启动守护进程，支持系统状态快照，或者基于依赖的服务控制逻辑,已成为大多数发行版的标准配置。可以通过 systemctl --version 命令来查看使用的版本</span><br><span class="line">3. systemd 和 supervisord 各有长短，不存在哪一方绝对的碾压。systemd 跟 Linux 紧密结合，所需的依赖少，其提供的保障自然比 supervisord 更可靠。然而在强大的能力背后，也有配置复杂、不易上手等问题。</span><br><span class="line"></span><br><span class="line">### 常用测试工具</span><br><span class="line">1. Apache自带ApacheBench程序对Apache或其它类型的服务器进行网站访问压力测试。</span><br><span class="line"></span><br><span class="line">&gt; ApacheBench命令原理：ab命令会创建很多的并发访问线程，模拟多个访问者同时对某一URL地址进行访问。它的测试目标是基于URL的，因此，既可以用来测试Apache的负载压力，也可以测试nginx、lighthttp、tomcat、IIS等其它Web服务器的压力。</span><br><span class="line"></span><br><span class="line">&gt; ab命令对发出负载的计算机要求很低，既不会占用很高CPU，也不会占用很多内存，但却会给目标服务器造成巨大的负载，其原理类似CC攻击。自己测试使用也须注意，否则一次上太多的负载，可能造成目标服务器因资源耗完，严重时甚至导致死机。</span><br><span class="line"></span><br><span class="line">2. [服务器性能评估相关指标QPS](https://ruby-china.org/topics/26221)</span><br><span class="line"></span><br><span class="line">### C++常用错误调试工具</span><br><span class="line"></span><br><span class="line">#### core dump</span><br><span class="line">core dump是大多数UNIX系统实现的一种特性，当进程运行的过程中异常终止或崩溃时，操作系统会将进程当前的内存映像和一部分相关的调试信息写入core文件，例如寄存器信息（包括程序指针、栈指针等）、内存管理信息、其他处理器和操作系统状态和信息。我们可以使用```ulimit -c unlimited```命令来开启core dump。  </span><br><span class="line"></span><br><span class="line">Linux中信号是一种异步事件处理的机制，每种信号对应有其默认的操作，默认操作主要包括忽略该信号（Ingore）、暂停进程（Stop）、终止进程（Terminate）、终止并发生core dump（core）等；```kill -l```可以看到linux里边的信号种类，默认动作中可能产生core文件的信号包括以下种类：</span><br><span class="line"></span><br><span class="line">信号名字 | 说明 | 默认动作</span><br><span class="line">--- | --- | ---</span><br><span class="line">SIGABRT(6) | 异常终止（调用abort函数产生此信号）| 终止+core</span><br><span class="line">SIGBUS(7) | 硬件故障，比如出现某些内存故障 | 终止+core</span><br><span class="line">SIGEMT | 硬件故障 | 终止+core</span><br><span class="line">SIGFPE(8) | 算术异常，比如除以0，浮点溢出等 | 终止+core</span><br><span class="line">SIGILL(4) | 非法硬件指令	| 终止+core</span><br><span class="line">SIGIOT(29) | 硬件故障	| 终止+core</span><br><span class="line">SIGQUIT(3) | 终端退出符，比如Ctrl+C	| 终止+core</span><br><span class="line">SIGSEGV(11) | 无效内存引用 | 终止+core</span><br><span class="line">SIGSYS(31) | 无效系统调用	| 终止+core</span><br><span class="line">SIGXCPU(24) | 超过CPU限制（setrlimit）| 终止+core/忽略</span><br><span class="line">SIGXFSZ(25) | 超过文件长度限制（setrlimit）| 终止+core/忽略</span><br><span class="line"></span><br><span class="line">这就是为什么我们使用```ctrl+z```来挂起一个进程或者```Ctrl+C```结束一个进程均不会产生 core dump，因为前者会向进程发出SIGTSTP信号，该信号的默认操作为暂停进程（Stop Process）；后者会向进程发出SIGINT信号，该信号默认操作为终止进程（Terminate Process）。同样上面提到的 kill -9 命令会发出 SIGKILL 命令，该命令默认为终止进程。而如果我们使用 Ctrl+\ 来终止一个进程，会向进程发出 SIGQUIT 信号，默认是会产生 core dump 的。还有其它情景会产生core dump， 如：程序调用 abort() 函数、访存错误、非法指令等等。</span><br><span class="line"></span><br><span class="line">#### dmesg</span><br><span class="line">**段错误**是指访问的内存超出了系统给这个程序所设定的内存空间， 例如访问了不存在的内存地址，访问了系统保护的内存地址，访问了只读的内存地址等等情况。```dmesg```命令显示linux内核的环形缓冲区信息，我们可以从中获得诸如系统架构、cpu、挂载的硬件，RAM等多个运行级别的大量的系统信息。通过dmesg命令可以查看发生段错误的程序名称、引起段错误发生的内存地址、指令指针地址、堆栈指针地址、错误代码、错误原因等。</span><br><span class="line"></span><br><span class="line">1. dmesg信息解读: 如下是bucket bin文件段错误信息，ip信息会用到后续objdump反编译分析</span><br><span class="line"></span><br><span class="line">```bucket[14306]: segfault at b8c6000 ip 0000000000c3dece sp 00007ffd2c96ae80 error 6 in bucket[400000+eea000]</span><br></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>error number是6, 转成二进制就是110, 即bit2=1, bit1=1, bit0=0, 按照上面的解释，我们可以得出这条信息是由于用户态程序写操作访问越界，访问的是无效地址造成的。</p>
<p>error number是由三个字位组成的，从高到底分别为bit2 bit1和bit0,所以它的取值范围是0~7.</p>
<blockquote>
<ul>
<li>bit2: 值为1表示是用户态程序内存访问越界，值为0表示是内核态程序内存访问越界</li>
<li>bit1: 值为1表示是写操作导致内存访问越界，值为0表示是读操作导致内存访问越界</li>
<li>bit0: 值为1表示没有足够的权限访问非法地址的内容，值为0表示访问的非法地址根本没有对应的页面，也就是无效地址</li>
</ul>
</blockquote>
</blockquote>
<ol>
<li>addr2line -e 进程名 c3dece; <a href="https://mp.weixin.qq.com/s/Dgh3P5ZJDcJdhdSG5t-tlw" target="_blank" rel="noopener">使用addr2line命令获取出错具体行号</a></li>
</ol>
<h4 id="objdump">objdump</h4><p>objdump命令是Linux下的反汇编目标文件或者可执行文件的命令，使用objdump生成二进制的相关信息，并重定向到文件中</p>
<figure class="highlight plain"><figcaption><span>-d(-S尽可能完全反编译) bin/bucket > segfaultDump```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">```grep -n -A 10 -B 10 &quot;c3dece&quot; ./segfaultDump</span><br></pre></td></tr></table></figure>
<h4 id="pstack和strace">pstack和strace</h4><p>strace跟踪程序使用的底层系统调用，可输出系统调用被执行的时间点以及各个调用耗时；pstack工具对指定PID的进程输出函数调用栈。一般两者配合调用，先用strace查看耗时的系统调用，然后用pstack看函数调用栈信息，找到出问题的函数。</p>
<ol>
<li><p>在Linux世界，进程不能直接访问硬件设备，当进程需要访问硬件设备(比如读取磁盘文件，接收网络数据等等)时，必须由用户态模式切换至内核态模式，通过系统调用访问硬件设备。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">		# -f -F选项设置同时跟踪fork和vfork出来的进程，输出到~/straceout.txt，myserver是要启动和调试的程序</span><br><span class="line">		strace -f -F -o ~/straceout.txt myserver</span><br><span class="line">		</span><br><span class="line">		# 跟踪28979进程的所有系统调用（-e trace=all），并统计系统调用的花费时间，以及开始时间（并以可视化的时分秒格式显示）</span><br><span class="line">		strace -o output.txt -T -tt -e trace=all -p 28979</span><br><span class="line">2. ```pstack pid```: print a stack trace of a running process</span><br><span class="line">3. [实例讲解如何使用strace+pstack利器分析程序性能](https://blog.csdn.net/jiang1013nan/article/details/17558165)</span><br><span class="line"></span><br><span class="line">#### 其它</span><br><span class="line">1. ldd：使用ldd命令查看二进制程序的共享链接库依赖，包括库的名称、起始地址，这样可以确定段错误到底是发生在了自己的程序中还是依赖的共享库中。例如```ldd bin/bucket</span><br></pre></td></tr></table></figure></p>
</li>
<li><p>nm：使用nm命令列出二进制文件中的符号表，包括符号地址、符号类型、符号名等，这样可以帮助定位在哪里发生了段错误。<figure class="highlight plain"><figcaption><span>bin/bucket```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">#### 参考链接</span><br><span class="line">1. [Linux工具](http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/objdump.html)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### condition_variable/mutex/thread_pool</span><br><span class="line"></span><br><span class="line">1. **条件变量(Condtion Variable)是在多线程程序中用来实现“等待-&gt;唤醒”逻辑常用的方法，条件变量能使一个或多个线程进入阻塞状态,直到接到另一个线程的通知(notify),或者发生超时或虚假唤醒时,才退出阻塞**。例如，应用程序A中包含两个线程t1和t2。t1需要在bool变量test_cond为true时才能继续执行，而test_cond的值是由t2来改变的，这种情况下可供选择的方案有两种：</span><br><span class="line"></span><br><span class="line">   * t1定时的去轮询变量test_cond，如果test_cond为false，则继续休眠；如果test_cond为true，则开始执行。</span><br><span class="line">   * 利用条件变量，t1在test_cond为false时调用cond_wait进行等待，t2在改变test_cond的值后，调用cond_signal，唤醒在等待中的t1，告诉t1 test_cond的值变了，这样t1便可继续往下执行。</span><br><span class="line">   * Wait_for: 在条件变量收到信号或者指定的超时发生前，线程一直处于阻塞状态；</span><br><span class="line">   * Wait_until:在条件变量收到信号或者指定的时刻到达之前，线程一直处于阻塞状态。</span><br><span class="line"></span><br><span class="line">2. **Thread相关的函数**：</span><br><span class="line"></span><br><span class="line">   * t.join()：使调用线程（本例是指主线程）一直处于阻塞状态，直到正在执行的线程t执行结束。如果线程函数返回某个值，该值也将被忽略。不过，该函数可以接收任意数量的参数，尽管可以向线程函数传递任意数量的参数，但是所有的参数应当按值传递。如果需要将参数按引用传递，那要向下例所示那样，必须将参数用std::ref 或者std::cref进行封装。</span><br><span class="line"></span><br><span class="line">     ```cpp</span><br><span class="line">     void func(int i, double d, const std::string&amp; s)</span><br><span class="line">     &#123;</span><br><span class="line">         std::cout &lt;&lt; i &lt;&lt; &quot;, &quot; &lt;&lt; d &lt;&lt; &quot;, &quot; &lt;&lt; s &lt;&lt; std::endl;</span><br><span class="line">     &#125;</span><br><span class="line">      </span><br><span class="line">     void func1(int&amp; a)</span><br><span class="line">     &#123;</span><br><span class="line">        a++;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     int main()</span><br><span class="line">     &#123;</span><br><span class="line">        std::thread t(func, 1, 12.50, &quot;sample&quot;);</span><br><span class="line">        t.join();</span><br><span class="line">      </span><br><span class="line">        int a = 42;</span><br><span class="line">        std::thread t1(func, std::ref(a));</span><br><span class="line">        t1.join();</span><br><span class="line">        </span><br><span class="line">        return 0;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>Detach: 允许执行该方法的线程脱离其线程对象而继续独立执行。脱离后的线程不再是可结合线程（你不能等待它们执行结束）。</p>
</li>
<li><p>get_id: 返回当前线程的id</p>
</li>
<li><p>yield:在处于等待状态时，可以让调度器先运行其他可用的线程。</p>
</li>
<li><p>sleep_for:阻塞当前线程，时间不少于其参数指定的时间。</p>
</li>
<li><p>sleep_util:在参数指定的时间到达之前，使当前线程一直处于阻塞状态。</p>
</li>
</ul>
</li>
<li><p><strong>std::recursive_mutex：</strong>允许同一个线程多次获取同一个互斥量，可获取的互斥量的最大次数并没有具体说明。但是一旦超过最大次数，再对lock进行调用就会抛出std::system_error错误异常。</p>
</li>
<li><p><strong>Timed_mutex和Recursive_timed_mutex</strong>：try_lock_for() 和 try_lock_until()，分别用于在某个时间段里或者某个时刻到达之间获取该互斥量</p>
</li>
<li><p><strong>Lock_guard</strong>: 在构造对象时，它试图去获取互斥量的所有权（通过调用lock()），在析构对象时，自动释放互斥量（通过调用unlock()）.这是一个不可复制的类。</p>
</li>
<li><p><strong>Unique_lock</strong>: 这个一通用的互斥量封装类，不同于lock_guard，它还支持延迟加锁，时间加锁和递归加锁以及锁所有权的转移和条件变量的使用。这也是一个不可复制的类，但它是可移动类。</p>
</li>
<li><p><a href="http://blog.jobbole.com/44409/" target="_blank" rel="noopener">C++11 中的线程、锁和条件变量</a></p>
</li>
</ol>
<h3 id="Linux中的线程同步机制-Futex/Mutexes/Condition_Variables/POSIX_Semaphores">Linux中的线程同步机制-Futex/Mutexes/Condition Variables/POSIX Semaphores</h3><p>Futex是一种用户态和内核态混合的同步机制。首先，同步的进程间通过mmap共享一段内存，futex变量就位于这段共享 的内存中且操作是原子的，当进程尝试进入互斥区或者退出互斥区的时候，先去查看共享内存中的futex变量，如果没有竞争发生，则只修改futex,而不 用再执行系统调用了。当通过访问futex变量告诉进程有竞争发生，则还是得执行系统调用去完成相应的处理(wait 或者 wake up)。简单的说，futex就是通过在用户态的检查，（motivation）如果了解到没有竞争就不用陷入内核了，大大提高了low-contention时候的效率。<br><a href="http://ju.outofmemory.cn/entry/38941" target="_blank" rel="noopener">Linux多线程同步机制参考链接</a></p>
<h3 id="C++的RAII_—-_资源获取即初始化">C++的RAII —- 资源获取即初始化</h3><p>C++的一种利用C++构造的对象最终会被销毁的原则来管理资源避免泄露的用法。具体做法是使用一个对象，在其构造时获取对应的资源，在对象生命期内控制对资源的访问，使之始终保持有效，最后在对象析构的时候，释放构造时获取的资源。</p>
<p><strong>如何使用RAII ？</strong><br>把资源用类进行封装起来，对资源操作都封装在类的内部，在析构函数中进行释放资源。当定义的局部变量的生命结束时，它的析构函数就会自动的被调用，如此，就不用程序员显示的去调用释放资源的操作了。例如对socket、互斥锁、文件句柄和内存的申请和释放。</p>
<h3 id="其它">其它</h3><ol>
<li>C++ 11 auto关键字编译时类型推断。</li>
<li>std::map::emplace_hint 暗示指定位置前插入元素；make_shared构造类型对象和make_pair构造pair</li>
<li>常用第三方库：boost，gflag，glog，folly，chromium，bazel代码构建</li>
<li>性能分析和内存泄漏：gperftools</li>
<li>C++单例：std::atomic + DCLP, std::once_flag</li>
<li>线程池：rocksdb/util/thread_pool_imp.h</li>
<li>C++智能指针：boost::smart_ptr, std::shared_ptr, std::unique_ptr</li>
<li>boost::shared_ptr 主要的功能是，管理动态创建的对象的销毁。它的基本原理就是记录对象被引用的次数，当引用次数为 0 的时候，也就是最后一个指向某对象的共享指针析构的时候，共享指针的析构函数就把指向的内存区域释放掉。共享指针对象重载了 operator* 和 operator-&gt; , 所以你可以像通常的指针一样使用它. <a href="https://blog.csdn.net/codestinity/article/details/6898613" target="_blank" rel="noopener">shared_ptr</a></li>
<li><strong><a href="https://www.ibm.com/developerworks/cn/aix/library/1307_lisl_c11/index.html" target="_blank" rel="noopener">C++左值与右值引用</a></strong>: C++( 包括 C) 中所有的表达式和变量要么是左值，要么是右值。通俗的左值的定义就是非临时对象，那些可以在多条语句中使用的对象。所有的变量都满足这个定义，在多条代码中都可以使用，都是左值。右值是指临时的对象，它们只在当前的语句中有效。左值的声明符号为”&amp;”， 为了和左值区分，右值的声明符号为”&amp;&amp;”。右值引用是用来支持转移语义的。转移语义可以将资源 ( 堆，系统对象等 ) 从一个对象转移到另一个对象，这样能够减少不必要的临时对象的创建、拷贝以及销毁，能够大幅度提高 C++ 应用程序的性能。要实现转移语义，需要定义转移构造函数，还可以定义转移赋值操作符。标准库提供了函数 std::move，这个函数以非常简单的方式将左值引用转换为右值引用。</li>
<li>C++11之后支持lamda语法：std::function可调用实体，std::bind返回可调用实体，用于后续作为回调函数</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="../4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="../../">1</a><span class="space">&hellip;</span><a class="page-number" href="../4/">4</a><span class="page-number current">5</span><a class="page-number" href="../6/">6</a><span class="space">&hellip;</span><a class="page-number" href="../18/">18</a><a class="extend next" rel="next" href="../6/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="../../images/avatar.jpg" alt="CharlesXiao">
            
              <p class="site-author-name" itemprop="name">CharlesXiao</p>
              <p class="site-description motion-element" itemprop="description">在码农炼成之路不断挣扎……stay hungry……keep learning……</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="../../archives/">
                
                    <span class="site-state-item-count">87</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="../../categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">18</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="../../tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">78</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/Charles-Xiao" target="_blank" title="github" rel="external nofollow"><i class="fa fa-fw fa-github"></i>github</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://weibo.com/2262300105/profile?topnav=1&wvr=6" target="_blank" title="weibo" rel="external nofollow"><i class="fa fa-fw fa-weibo"></i>weibo</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://daijiale.github.io/" target="_blank" title="Daijiale的个人站点" rel="external nofollow"><i class="fa fa-fw fa-github"></i>Daijiale的个人站点</a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                推荐阅读
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://rocksdb.org/" title="RocksDB" target="_blank">RocksDB</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://wf.uisdc.com/cn/" title="Google FE" target="_blank">Google FE</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright"><a target="_blank" rel="external nofollow" href="http://www.miitbeian.gov.cn/">  </a> &copy; 2015.05.16 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CharlesXiao</span>

  

  
</div>


  




<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_pv">
  本站总访问量:<span id="busuanzi_value_site_pv"></span>
</span>
</div>

<span class="post-meta-divider">|</span>
<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  总访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>

<span class="post-meta-divider">|</span>


<div class="powered-by"></div>
<span class="post-count">博客全站共169.6k字</span>


        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  





  
  









  



  
  
    <script type="text/javascript" src="../../lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="../../lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="../../lib/three/three-waves.min.js"></script>
  

  
  
    <script type="text/javascript" src="../../lib/reading_progress/reading_progress.js"></script>
  


  


  <script type="text/javascript" src="../../js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="../../js/src/motion.js?v=6.5.0"></script>



  
  

  

  


  <script type="text/javascript" src="../../js/src/bootstrap.js?v=6.5.0"></script>



  



  










  





  

  

  

  

  

  
  
  
  <script src="../../lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "box";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
      flOptions = {};
      
          flOptions.iconStyle = "box";
      
          flOptions.boxForm = "horizontal";
      
          flOptions.position = "middleRight";
      
          flOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  </script>

  

  

  

  

  

  


</body>
</html>
