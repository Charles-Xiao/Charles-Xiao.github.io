<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






  <link rel="stylesheet" type="text/css" href="../../vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="../../css/main.css?v=0.4.2"/>


    <meta name="description" content="在码农炼成之路不断挣扎……stay hungry……keep learning……" />



  <meta name="keywords" content="java,android,life,CharlesXiao" />





  <link rel="shorticon icon" type="image/x-icon" href="../..//favicon.ico?v=0.4.2" />



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?6749450";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  <title> CharlesXiao‘s Blog </title>
</head>

<body>
<!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">CharlesXiao‘s Blog</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>


  <ul id="menu" class="menu">
     
    <!--增加swiftype搜索功能-->
    <form class="menu-item menu-item-search">
      <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
    </form>
    
    <script type="text/javascript">
      (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
      (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
      e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
      })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

      _st('install','yxUhPQ2aHyszT_1btxX9','2.0.0');
    </script>
    <!--增加swiftype搜索功能end-->
    
    
      
      <li class="menu-item menu-item-home">
        <a href="../..//">
          <i class="menu-item-icon icon-home"></i> <br />
          首页
        </a>
      </li>
    
      
      <li class="menu-item menu-item-categories">
        <a href="../..//categories">
          <i class="menu-item-icon icon-categories"></i> <br />
          分类
        </a>
      </li>
    
      
      <li class="menu-item menu-item-about">
        <a href="../..//about">
          <i class="menu-item-icon icon-about"></i> <br />
          关于
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="../..//archives">
          <i class="menu-item-icon icon-archives"></i> <br />
          归档
        </a>
      </li>
    
      
      <li class="menu-item menu-item-tags">
        <a href="../..//tags">
          <i class="menu-item-icon icon-tags"></i> <br />
          标签
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <div id="posts" class="posts-expand">
    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="../../2017/12/07/Linux终端利器tmux指南/">
                Linux终端利器tmux指南
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2017-12-07
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="../../2017/12/07/Linux终端利器tmux指南/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2017/12/07/Linux终端利器tmux指南/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h4 id="tmux简介">tmux简介</h4><p>tmux是BSD实现的Screen替代品，相对于Screen，它更加先进：支持屏幕切分，而且具备丰富的命令行参数，使其可以灵活、动态的进行各种布局和操作。它可以做到一条命令就启动起来(强大的配置)</p>
<h5 id="安装方法">安装方法</h5><table>
<thead>
<tr>
<th>系统</th>
<th>安装命令</th>
</tr>
</thead>
<tbody>
<tr>
<td>mac</td>
<td><code>brew install tmux</code>（前提需要安装homebrew)</td>
</tr>
<tr>
<td>ubuntu</td>
<td><code>sudo apt-get install tmux</code></td>
</tr>
<tr>
<td>centos</td>
<td><code>yum install -y tmux</code></td>
</tr>
<tr>
<td>其它</td>
<td>下载源码配置-编译-链接-安装</td>
</tr>
</tbody>
</table>
<h5 id="概念名词">概念名词</h5><p>在你输入tmux开启了tmux服务器后，会首先创建一个会话，而这个会话则会首先创建一个窗口，其中仅包含一个面板; 也就是说，这里看到的所谓终端控制台应该称作tmux的一个面板，虽然其使用方法与终端控制台完全相同。</p>
<table>
<thead>
<tr>
<th>概念</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>server服务器</td>
<td>输入tmux命令时就开启了一个服务器</td>
</tr>
<tr>
<td>session会话</td>
<td>一个服务器可以包含多个会话</td>
</tr>
<tr>
<td>window窗口</td>
<td>通过c-b-c创建，所有窗口的名称显示在底部状态栏上，一个会话可以包含多个窗口</td>
</tr>
<tr>
<td>pane面板</td>
<td>窗口里面的分屏，可通过c-b-%创建，一个窗口可以包含多个面板</td>
</tr>
</tbody>
</table>
<h5 id="使用场景和优点">使用场景和优点</h5><ol>
<li>tmux命令开启一个终端之后，可以在这个终端里开启多个windows，同时还可以把windows split成多个pane，并行工作</li>
<li>ssh登录远程主机的情景下，一旦ssh断开，那么当前账户登录的任务就被取消了，但是使用 tmux 可以在断开之后继续工作，下次登录可以查看</li>
</ol>
<h4 id="常用默认快捷键">常用默认快捷键</h4><p>tmux里边所有快捷键都默认以c-b作为前缀，也就是以ctrl+b开头，当然你也可以自行配置；</p>
<ol>
<li>基本命令<ul>
<li><code>tmux</code>创建一个tmux session</li>
<li><code>tmux new -s session_name</code>创建一个叫做session_name的 session</li>
<li><code>tmux ls\tmux list-sessions</code>列出现有的所有session</li>
<li><code>tmux info</code>列出所有的 session, window, pane, 运行的进程号等</li>
<li><code>tmux list-keys</code>列出所有可以的快捷键和其运行的 tmux 命令</li>
<li><code>tmux list-commands</code>列出所有的 tmux 命令及其参数</li>
<li><code>tmux at(attach) -t session_name</code>进入叫做session_name的session</li>
<li><code>tmux detach\c-b-d</code>离开当前开启的session</li>
<li><code>tmux kill-session -t session</code>关闭开启的session</li>
</ul>
</li>
<li><p>基本操作</p>
<ul>
<li><code>d</code>脱离并保存当前会话,可暂时返回Shell界面,tmux仍在后台运行</li>
<li><code>ctrl + z</code>挂起当前会话</li>
<li><code>s</code>选择并切换会话；在同时开启了多个会话时使用</li>
<li><code>D</code>选择要脱离的会话；在同时开启了多个会话时使用</li>
<li><code>:</code>进入命令行模式；此时可输入支持的命令，例如 kill-server 关闭所有tmux会话</li>
<li><code>t</code>显示当前的时间</li>
</ul>
</li>
<li><p>窗口操作</p>
<ul>
<li><code>c</code>创建新窗口</li>
<li><code>&amp;</code>关闭当前窗口</li>
<li><code>[0-9]</code>数字键切换到指定窗口</li>
<li><code>p</code>切换至上一窗口</li>
<li><code>n</code>切换至下一窗口</li>
<li><code>l</code>切换到最后使用的窗口</li>
<li><code>l</code>前后窗口间互相切换</li>
<li><code>w</code>通过窗口列表切换窗口</li>
<li><code>,</code>重命名当前窗口，便于识别</li>
<li><code>.</code>修改当前窗口编号，相当于重新排序</li>
<li><code>f</code>在所有窗口中查找关键词，便于窗口多了切换</li>
</ul>
</li>
<li>(面板)分屏操作<ul>
<li><code>?</code>显示快捷键帮助</li>
<li><code>&quot;</code>将当前面板上下分屏（建议设置成 |）</li>
<li><code>%</code>将当前面板左右分屏（建议设置成 -）</li>
<li><code>x</code>关闭当前分屏</li>
<li><code>q</code>显示面板编号</li>
<li><code>o</code>选择当前窗口中下一个面板</li>
<li><code>;</code>切换到最后一个使用的面板</li>
<li><code>方向键</code>移动光标选择对应面板</li>
<li><code>z</code>最大化当前所在面板</li>
<li><code>!</code>面板转变成窗口</li>
</ul>
</li>
</ol>
<h4 id="推荐配置">推荐配置</h4><p>如果你有个性化配置的需要，包括快捷键，状态栏等，那么修改~/.tmux.conf文件可以达到你的目的，让你用起来更符合自己的习惯; 也可以通过配置~/.bashrc每次ssh登录时都默认attach或者新建tmux会话</p>
<ol>
<li>tmux.conf配置快捷键，配色等</li>
</ol>
<pre><code># 开启鼠标生效
<span class="operator"><span class="keyword">set</span>-<span class="keyword">option</span> -g mouse <span class="keyword">on</span>

#设置前缀为Ctrl + x
<span class="keyword">set</span> -g prefix C-x
unbind C-b

# <span class="keyword">key</span> bindings <span class="keyword">for</span> horizontal <span class="keyword">and</span> vertical panes
unbind %
bind | split-window -h      # 使用|竖屏，方便分屏
unbind <span class="string">'"'</span>
bind - split-window -v      # 使用-横屏，方便分屏

# <span class="keyword">status</span> bar <span class="keyword">with</span> <span class="keyword">load</span> <span class="keyword">and</span> <span class="keyword">time</span>
<span class="keyword">set</span> -g <span class="keyword">status</span>-bg blue
<span class="keyword">set</span> -g <span class="keyword">status</span>-fg <span class="string">'#bbbbbb'</span>
<span class="keyword">set</span> -g <span class="keyword">status</span>-<span class="keyword">left</span>-fg green
<span class="keyword">set</span> -g <span class="keyword">status</span>-<span class="keyword">left</span>-bg blue
<span class="keyword">set</span> -g <span class="keyword">status</span>-<span class="keyword">right</span>-fg green
<span class="keyword">set</span> -g <span class="keyword">status</span>-<span class="keyword">right</span>-bg blue
<span class="keyword">set</span> -g <span class="keyword">status</span>-<span class="keyword">left</span>-length <span class="number">90</span>
<span class="keyword">set</span> -g <span class="keyword">status</span>-<span class="keyword">right</span>-length <span class="number">90</span>
<span class="keyword">set</span> -g <span class="keyword">status</span>-<span class="keyword">left</span> <span class="string">'[#(whoami)]'</span>
<span class="keyword">set</span> -g <span class="keyword">status</span>-<span class="keyword">right</span> <span class="string">'[#(date +" %m-%d %H:%M ")]'</span>
<span class="keyword">set</span> -g <span class="keyword">status</span>-justify <span class="string">"centre"</span>
<span class="keyword">set</span> -g window-<span class="keyword">status</span>-<span class="keyword">format</span> <span class="string">'#I #W'</span>
<span class="keyword">set</span> -g window-<span class="keyword">status</span>-<span class="keyword">current</span>-<span class="keyword">format</span> <span class="string">' #I #W '</span>
setw -g window-<span class="keyword">status</span>-<span class="keyword">current</span>-bg blue
setw -g window-<span class="keyword">status</span>-<span class="keyword">current</span>-fg green
# pane <span class="built_in">number</span> display
<span class="keyword">set</span> -g display-panes-active-colour colour33 #blue
<span class="keyword">set</span> -g display-panes-colour colour166 #orange
<span class="keyword">set</span> -g base-<span class="keyword">index</span> <span class="number">1</span>
<span class="keyword">set</span> -g pane-base-<span class="keyword">index</span> <span class="number">1</span>
<span class="keyword">set</span> -g display-<span class="keyword">time</span> <span class="number">3000</span>
<span class="keyword">set</span> -g history-<span class="keyword">limit</span> <span class="number">10000</span>

# copy-<span class="keyword">mode</span> 将快捷键设置为 vi 模式
setw -g <span class="keyword">mode</span>-keys vi

# 选中窗口
bind-<span class="keyword">key</span> k <span class="keyword">select</span>-pane -U
bind-<span class="keyword">key</span> j <span class="keyword">select</span>-pane -D
bind-<span class="keyword">key</span> h <span class="keyword">select</span>-pane -L
bind-<span class="keyword">key</span> l <span class="keyword">select</span>-pane -R</span>
</code></pre><ol>
<li><p>~/.bash_rc配置登录时自动进入tmux</p>
<pre><code>tmux_init(<span class="function">)</span>
{
    tmux<span class="instruction"> new-session </span>-s <span class="string">"xiaoyong"</span> -d -n <span class="string">"local"</span>    <span class="comment"># 开启一个会话</span>
    tmux<span class="instruction"> new-window </span>-n <span class="string">"other"</span>          <span class="comment"># 开启一个窗口</span>
    tmux split-window -h                <span class="comment"># 开启一个竖屏</span>
    tmux split-window -v                <span class="comment"># 开启一个横屏</span>
    tmux -2 attach-session -d           <span class="comment"># tmux -2强制启用256color，连接已开启的tmux</span>
}

<span class="comment"># 判断是否已有开启的tmux会话，没有则开启</span><span class="instruction">
if </span>which tmux 2&gt;&amp;1 &gt;/dev/null; then
    test -z <span class="string">"$TMUX"</span> &amp;&amp;<span class="function"> (</span>tmux attach || tmux_init<span class="function">)</span>
fi
</code></pre></li>
</ol>
<h4 id="参考链接">参考链接</h4><ol>
<li><a href="http://wdxtub.com/2016/03/30/tmux-guide/" target="_blank" rel="external">tmux指南</a></li>
<li><strong> tmux如何将内容复制到系统clipboard ? </strong> Mac下如果用 iterm2 可以在 preference 下选择 Applications in terminal may access  clipboard</li>
</ol>

        
      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="../../tags/Linux/"> #Linux </a>
          
            <a href="../../tags/tmux/"> #tmux </a>
          
        </div>
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="../../2017/12/02/Mysql Init线程不安全问题/">
                Mysql初次Init线程不安全问题
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2017-12-02
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="../../2017/12/02/Mysql Init线程不安全问题/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2017/12/02/Mysql Init线程不安全问题/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h4 id="现象描述">现象描述</h4><p>沙盒测试时发现的这个问题，在程序启动时偶发core，而且不稳定复现，查看core信息会发现core在了mysql连接上；而且最后发现的规律是每次程序启动时，如果多线程获取数据库连接，就可能出现core。core信息如图所示:</p>
<p><img src="https://raw.githubusercontent.com/Charles-Xiao/Charles-Xiao.github.io/master/images/mysql_core.png" class="full-image"></p>
<h4 id="代码复现">代码复现</h4><p>在主线程内初始化mysql，在子线程内调用mysql_real_connect,就会导致coredump</p>
<pre><code><span class="variable">#include</span> <span class="subst">&lt;</span>mysql<span class="built_in">.</span>h<span class="subst">&gt;</span>
<span class="variable">#include</span> <span class="subst">&lt;</span>pthread<span class="built_in">.</span>h<span class="subst">&gt;</span>
<span class="literal">void</span><span class="subst">*</span> func(<span class="literal">void</span><span class="subst">*</span> arg)
{
    MYSQL<span class="subst">*</span> mysql <span class="subst">=</span> (MYSQL <span class="subst">*</span>)arg;
    mysql_real_connect(mysql, “<span class="number">127.0</span><span class="built_in">.0</span><span class="built_in">.1</span>″, “root”, “<span class="number">123456</span>″, “chen”, <span class="number">1234</span>, <span class="built_in">NULL</span>, <span class="number">0</span>);
    mysql_close(mysql);
    <span class="keyword">return</span> (<span class="literal">void</span> <span class="subst">*</span>)<span class="number">0</span>;
}

int main()
{
    MYSQL mysql;
    <span class="keyword">if</span> (<span class="built_in">NULL</span> <span class="subst">==</span> mysql_init(<span class="subst">&amp;</span>mysql))
    {
        <span class="keyword">return</span> <span class="subst">-</span><span class="number">1</span>;
    }
    pthread_t <span class="keyword">thread</span>;
    pthread_create(<span class="subst">&amp;</span><span class="keyword">thread</span>, <span class="built_in">NULL</span>, func, <span class="subst">&amp;</span>mysql);
    pthread_join(<span class="keyword">thread</span>, <span class="built_in">NULL</span>);
    <span class="keyword">return</span> <span class="number">0</span>;
}
</code></pre><h4 id="出现原因">出现原因</h4><p>如官网文档所说，当我们调用<code>mysql_real_connect()</code>函数去获取数据库连接时，需要先调用<code>mysql_init(MYSQL *mysql)函数</code>去获取一个MYSQL connection handler，然而mysql_init()不是完全线程安全的，但是只要成功调用一次后就线程安全了，如果有多线程并发调用mysql_init()，第一次init时如果刚好多线程并发调用，就会出core；为啥第一次调用mysql_init时线程不安全？我们可以来看看mysql源码:</p>
<ol>
<li><p>mysql.h文件预定义<code>mysql_library_init</code>函数</p>
<pre><code><span class="hexcolor">#def</span>ine mysql_library_init mysql_server_init
</code></pre></li>
<li><p>client.c文件定义<code>mysql_init</code>函数,并调用<code>mysql_server_init</code>函数</p>
<pre><code><span class="comment">// Init MySQL structure or allocate one</span>

MYSQL <span class="subst">*</span> STDCALL
mysql_init(MYSQL <span class="subst">*</span>mysql)
{
  <span class="keyword">if</span> (mysql_server_init(<span class="number">0</span>, <span class="built_in">NULL</span>, <span class="built_in">NULL</span>))
    <span class="keyword">return</span> <span class="number">0</span>;
  <span class="keyword">if</span> (<span class="subst">!</span>mysql)
  {
    <span class="keyword">if</span> (<span class="subst">!</span>(mysql<span class="subst">=</span>(MYSQL<span class="subst">*</span>) my_malloc(sizeof(<span class="subst">*</span>mysql),MYF(MY_WME <span class="subst">|</span> MY_ZEROFILL))))
    {
      set_mysql_error(<span class="built_in">NULL</span>, CR_OUT_OF_MEMORY, unknown_sqlstate);
      <span class="keyword">return</span> <span class="number">0</span>;
    }
    mysql<span class="subst">-&gt;</span>free_me<span class="subst">=</span><span class="number">1</span>;
  }
  <span class="keyword">else</span>
    memset(mysql, <span class="number">0</span>, sizeof(<span class="subst">*</span>(mysql)));
  mysql<span class="subst">-&gt;</span>charset<span class="subst">=</span>default_client_charset_info;
  strmov(mysql<span class="subst">-&gt;</span>net<span class="built_in">.</span>sqlstate, not_error_sqlstate);

  <span class="comment">/*
    Only enable LOAD DATA INFILE by default if configured with option
    ENABLED_LOCAL_INFILE
  */</span>

<span class="variable">#if</span> defined(ENABLED_LOCAL_INFILE) <span class="subst">&amp;&amp;</span> <span class="subst">!</span>defined(MYSQL_SERVER)
  mysql<span class="subst">-&gt;</span>options<span class="built_in">.</span>client_flag<span class="subst">|=</span> CLIENT_LOCAL_FILES;
<span class="variable">#endif</span>

<span class="variable">#ifdef</span> HAVE_SMEM
  mysql<span class="subst">-&gt;</span>options<span class="built_in">.</span>shared_memory_base_name<span class="subst">=</span> (char<span class="subst">*</span>) def_shared_memory_base_name;
<span class="variable">#endif</span>

  mysql<span class="subst">-&gt;</span>options<span class="built_in">.</span>methods_to_use<span class="subst">=</span> MYSQL_OPT_GUESS_CONNECTION;
  mysql<span class="subst">-&gt;</span>options<span class="built_in">.</span>report_data_truncation<span class="subst">=</span> <span class="literal">TRUE</span>;  <span class="comment">/* default */</span>

  mysql<span class="subst">-&gt;</span>reconnect<span class="subst">=</span> <span class="number">0</span>;

  mysql<span class="subst">-&gt;</span>options<span class="built_in">.</span>secure_auth<span class="subst">=</span> <span class="literal">TRUE</span>;

  <span class="keyword">return</span> mysql;
}
</code></pre></li>
<li><p>libmysql.c文件定义<code>mysql_server_init</code>函数, 问题就出在这个函数,用了<code>mysql_client_init</code>这个标记量来判断是否需要调用<code>my_thread_init</code>函数，如果<code>mysql_client_init==1</code>就直接为每个线程初始化私有变量，否则会先去初始化一些全局性的系统函数，资源和变量; 所以如果第一次init时出现多线程并发情景，线程A将<code>mysql_client_init</code>变量置为1，紧接着初始化全局资源，与此同时线程B走了else分支，直接开始调用<code>my_thread_init</code>函数，此时就会报错了，core由此产生。</p>
<pre><code><span class="type">int</span> <span class="type">STDCALL</span> mysql_server_init(<span class="type">int</span> argc __attribute__((unused)),
                  <span class="type">char</span> **argv __attribute__((unused)),
                  <span class="type">char</span> **groups __attribute__((unused)))
{
  <span class="type">int</span> <span class="literal">result</span>= <span class="number">0</span>;
  <span class="keyword">if</span> (!mysql_client_init)
  {
    mysql_client_init=<span class="number">1</span>;
    org_my_init_done=my_init_done;
    <span class="keyword">if</span> (my_init())                /* <span class="type">Will</span> init threads */
      <span class="keyword">return</span> <span class="number">1</span>;
    init_client_errs();
    <span class="keyword">if</span> (mysql_client_plugin_init())
      <span class="keyword">return</span> <span class="number">1</span>;
    <span class="keyword">if</span> (!mysql_port)
    {
      <span class="type">char</span> *env;
      struct servent *serv_ptr __attribute__((unused));

      mysql_port = <span class="type">MYSQL_PORT</span>;

      /*
        <span class="keyword">if</span> builder specifically requested a default port, use that
        (even <span class="keyword">if</span> it coincides <span class="keyword">with</span> our factory default).
        only <span class="keyword">if</span> they didn't <span class="keyword">do</span> we check /etc/services (<span class="keyword">and</span>, failing
        on that, fall back to the factory default <span class="keyword">of</span> <span class="number">3306</span>).
        either default can be overridden by the environment variable
        <span class="type">MYSQL_TCP_PORT</span>, which <span class="keyword">in</span> turn can be overridden <span class="keyword">with</span> command
        line options.
      */

<span class="comment">#if MYSQL_PORT_DEFAULT == 0</span>
      <span class="keyword">if</span> ((serv_ptr= getservbyname(<span class="string">"mysql"</span>, <span class="string">"tcp"</span>)))
        mysql_port= (<span class="type">uint</span>) ntohs((ushort) serv_ptr-&gt;s_port);
<span class="comment">#endif</span>
      <span class="keyword">if</span> ((env= getenv(<span class="string">"MYSQL_TCP_PORT"</span>)))
        mysql_port=(<span class="type">uint</span>) atoi(env);
    }

    <span class="keyword">if</span> (!mysql_unix_port)
    {
      <span class="type">char</span> *env;
<span class="comment">#ifdef __WIN__</span>
      mysql_unix_port = (<span class="type">char</span>*) <span class="type">MYSQL_NAMEDPIPE</span>;
<span class="comment">#else</span>
      mysql_unix_port = (<span class="type">char</span>*) <span class="type">MYSQL_UNIX_ADDR</span>;
<span class="comment">#endif</span>
      <span class="keyword">if</span> ((env = getenv(<span class="string">"MYSQL_UNIX_PORT"</span>)))
    mysql_unix_port = env;
    }
    mysql_debug(<span class="type">NullS</span>);
<span class="comment">#if defined(SIGPIPE) &amp;&amp; !defined(__WIN__)</span>
    (<span class="type">void</span>) signal(<span class="type">SIGPIPE</span>, <span class="type">SIG_IGN</span>);
<span class="comment">#endif</span>
<span class="comment">#ifdef EMBEDDED_LIBRARY</span>
    <span class="keyword">if</span> (argc &gt; -<span class="number">1</span>)
       <span class="literal">result</span>= init_embedded_server(argc, argv, groups);
<span class="comment">#endif</span>
  }
  <span class="keyword">else</span>
    <span class="literal">result</span>= (<span class="type">int</span>)my_thread_init();         /* <span class="type">Init</span> <span class="keyword">if</span> new thread */
  <span class="keyword">return</span> <span class="literal">result</span>;
}
</code></pre></li>
<li><p>官方文档</p>
<ul>
<li><p><a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-real-connect.html" target="_blank" rel="external"><code>mysql_real_connect()</code></a> attempts to establish a connection to a MySQL database engine running on host. mysql_real_connect() must complete successfully before you can execute any other API functions that require a valid MYSQL connection handler structure.  </p>
</li>
<li><p><a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-init.html" target="_blank" rel="external"><code>MYSQL *mysql_init(MYSQL *mysql)</code></a>  </p>
<p>  Allocates or initializes a MYSQL object suitable for <code>mysql_real_connect()</code>. If mysql is a NULL pointer, the function allocates, initializes, and returns a new object. Otherwise, the object is initialized and the address of the object is returned. If <code>mysql_init()</code> allocates a new object, it is freed when <code>mysql_close()</code> is called to close the connection.  </p>
<p>  In a nonmulti-threaded environment, <code>mysql_init()</code> invokes <code>mysql_library_init()</code> automatically as necessary. However, <code>mysql_library_init()</code> is not thread-safe in a multi-threaded environment, and thus neither is <code>mysql_init()</code>. Before calling <code>mysql_init()</code>, either call <code>mysql_library_init()</code> prior to spawning any threads, or use a mutex to protect the <code>mysql_library_init()</code> call. This should be done prior to any other client library call.</p>
</li>
</ul>
</li>
</ol>
<h4 id="解决方案">解决方案</h4><ol>
<li>每一次连接数据库时都先后加锁调用mysql_init()和mysql_real_connect()，确保init先于connect函数被调用过，而且不会被其他线程并发调用，以免初次连接数据库时多线程并发导致core</li>
<li>在程序启动时先全局调用一次mysql_init()函数，确保初次调用mysql_init时是线程安全的，之后的调用mysql_real_connect函数就不会出core</li>
<li>MySQL提供了线程安全的库libmysql_r，可以考虑替换原来的线程不安全的libmysql库</li>
</ol>

        
      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="../../tags/Mysql/"> #Mysql </a>
          
            <a href="../../tags/bug/"> #bug </a>
          
            <a href="../../tags/databse/"> #databse </a>
          
        </div>
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="../../2017/11/11/计算机体系结构学习札记/">
                计算机体系结构学习札记
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2017-11-11
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="../../2017/11/11/计算机体系结构学习札记/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2017/11/11/计算机体系结构学习札记/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <p>计算机系统是由硬件和系统软件组成的，它们共同工作来运行应用程序。</p>
<h3 id="操作系统">操作系统</h3><p>操作系统处于中间位置，它的一边是应用程序、实用程序和用户，另一边是计算机系统的硬件。</p>
<h3 id="计算机硬件">计算机硬件</h3>
        
      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="../../tags/操作系统/"> #操作系统 </a>
          
            <a href="../../tags/计算机体系结构/"> #计算机体系结构 </a>
          
        </div>
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="../../2017/11/11/投资随笔/">
                投资随笔
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2017-11-11
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="../../2017/11/11/投资随笔/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2017/11/11/投资随笔/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h3 id="实战经验">实战经验</h3><ol>
<li>在大盘整体上涨的情况下，一定要等行情回调形势明朗时再买入，因为回调往往会连续几天，这几天里始终是会有上车机会的，不要着急，急于下手往往导致被套住。例如迅速买入京东亏损150刀</li>
<li>每天的曲线，最低点到最高点的振幅其实已经够大，果断抓住也是非常重要的。但是短线的前提是重仓，否则你往往会因为收益不够多而恋战，从而导致最终盈变成亏，重仓时不要跟大盘趋势作对。</li>
<li>在面对盈亏变化时心态和自制力非常重要，一定要有耐性。</li>
<li>从阿里和好未来的股价变化来看，在股价创新高时抛售是极不明智的，长期持有带来的收益会达到3倍左右，不要做“弱水三千只取一瓢”的愚蠢举动。例如对阿里，好未来，百度没有长期持有</li>
<li>不要跟趋势作对！参考第一条，下跌时买入往往会导致你止损割肉，从而亏损，例如短线操作微博亏损150刀</li>
<li>尽量不买入不熟悉的股票，如果需要买入尽量先观察一段时间。因为买入一只不熟悉的股票，往往会因为没有信心，而在回调时割肉退场，得不偿失。</li>
<li>相信自己的观察和股票的周期性，果断地买入被低估的公司，周期之后必会达到期望的价值例如低点的网易(250-310)，微博(95-110)</li>
<li>迅雷日内交易严重失误！不应该被情绪左右，短线操作最好在下单之前有相应的计划，包括止损和止盈点，否则的人性的贪婪和恐惧心理影响下，很难果断作出决定，从15%止损，一直到拖到30%止损</li>
<li>日内交易成交数过多导致杠杆太大，比如阿里日内交易只想下单20，却成交了40，如何处理？趋势不对，5%以内建议迅速果断立马减仓至20，不要有侥幸心理。</li>
<li>类似于迅雷，人人网这种没有基本面支撑的暴涨暴跌型股票，很难拿得住；如果暴涨，赌对了方向，尽量设好止损点退场，不要被贪婪驱使死守住，因为它既然会暴涨，也就能暴跌给你看。</li>
<li>及时止盈和做好计划，收割利润；近期10%以上的标的都考虑卖出，等等下一轮回调买入，目标3500</li>
<li>不论股价如何变化，行情只有两种，一是趋势行情，一是横盘整理行情。趋势行情和横盘整理行情通常是连在一起的，一波趋势行情后跟着一段横盘整理行情，一段横盘整理行情被突破后又跟着一波趋势行情。在上涨趋势行情中，每次回调都可以加仓，但一般这种行情回调很少且幅度有限，抓住就一定不能放过，技术指标上可以参考均线，股价回踩5日或10日均线时加仓。如果在牛市行情中，不建议在区间震荡时减仓，应尽量避免过多买入卖出的操作。如果是在熊市行情中，则每次反弹都是减仓的好时机，熊市中不用等，越早平仓越好。<a href="https://mp.weixin.qq.com/s/c2CxG4QYtqsaBQxSOO_6eA" target="_blank" rel="external">如何选择加仓和减仓时机</a></li>
<li>大盘回调风险以及黑天鹅事件的规避，例如中美贸易战等。整体回调可能持续上周；本次采用了去杠杆形式避险，导致利润回吐50%，如果及时补仓，利润则翻倍</li>
<li>回顾之前持有过的亏损标的，发现都是高买，然后顶不住回调风险才割肉；教训就是一定要提前了解，对买入标的要有信心，如果回调，应该以月为单位考虑割肉，设置一个止损比例，才能理性投资，避免割肉</li>
</ol>
<h4 id="近期关注和交易计划">近期关注和交易计划</h4><ol>
<li>从目前来看可以买入的低点股有特斯拉(300)，百度(240)，AMD(10)</li>
<li>网易300即可买入；微博125可买入；如果大盘有大幅回调，可以考虑等到回转再买入；华住考虑120左右；好未来等回调到35左右；阿里巴巴继续观望，包括百度在内，预估会分别到210和275的价格，如果分别回调到195和260，考虑割肉.</li>
</ol>
<h3 id="学习研究">学习研究</h3><ol>
<li><strong>二级市场里只有两种赚钱方式</strong>：一种是赚企业成长带来的收益，股价涨幅基本与企业利润涨幅保持正比；二种是通过博弈从交易对手身上赚来的钱，作为一名散户，想通过博傻来赚其他人的钱往往不太现实，但是可以赚市场犯错带来的收益，包括市场情绪以及理解偏差。</li>
<li><strong>猿猴心态</strong>让人看到K线图里的新高就理所当然地认为会下跌或者风险高，然而盛极而衰并不科学，股价创新高从来不是停止上涨的理由，创新低也不是停止下跌的理由。</li>
<li><strong>铆钉偏见</strong>让你以过去的数字作为参照，会让你在错过一只股票50块的买入时间，当他涨到100块时，理所当然地认为太贵，然后你就错过了将来涨到150的机会，一定要向未来价格看。一个股票便宜与否，看估值比看近期涨跌更可靠。</li>
<li>不要低估<strong>复利</strong>的威力，如果你在7年前买入腾讯，意味着每年回报率为38%，等于7年翻了10倍</li>
</ol>
<h3 id="基础知识">基础知识</h3><ol>
<li>限价单：最大程度获取利润，下跌到N就买入，上涨到N就卖出，低买高卖</li>
<li>止损单：最大程度避免损失，下跌到N就卖出，上涨到N就买入，低卖高买</li>
<li>止损限价单：到达止损价格就触发，接着要以限价价格交易，可能出现交易不成功</li>
<li>跟踪止损单：</li>
</ol>
<h4 id="期权交易的4种基本类型"><a href="http://finance.china.com.cn/stock/usstock/20170817/4355475.shtml" target="_blank" rel="external">期权交易的4种基本类型</a></h4>
        
      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="../../tags/投资理财/"> #投资理财 </a>
          
        </div>
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
      

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              <a class="post-title-link" href="../../2017/11/11/C++基础/">
                C++基础
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2017-11-11
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="../../2017/11/11/C++基础/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2017/11/11/C++基础/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        
          <h3 id="基础语法">基础语法</h3><ol>
<li>在C和C++语言中的全局变量和静态变量都是会自动初始化为0，堆和栈中的局部变量不会初始化而拥有不可预测的值。 C++保证了所有对象与对象成员都会初始化，但其中基本数据类型的初始化还得依赖于构造函数。</li>
<li>在C语言中int a;表示声明了整型a但未初始化，而C++中的对象总是会被初始化的，无论是否写了圆括号或者是否写了参数列表；定义基本数据类型变量（单个值、数组）的同时可以指定初始值，如果未指定C++会去执行默认初始化(default-initialization)。<a href="http://harttle.land/2015/10/05/cpp-variable-init.html" target="_blank" rel="external">变量初始化</a></li>
<li><a href="https://blog.csdn.net/bzhxuexi/article/details/19899803" target="_blank" rel="external">size_t,ssize_t,int和long的区别</a></li>
<li></li>
</ol>
<h3 id="智能指针boost::scoped_ptr/std::auto_ptr">智能指针boost::scoped_ptr/std::auto_ptr</h3><p>boost::scoped_ptr和std::auto_ptr（已被C++11废弃）非常类似，是一个简单的智能指针，它能够保证在离开作用域后对象被自动释放，避免由于忘记手动调用delete而造成内存泄漏。实现原理都是利用了一个栈上的对象去管理一个堆上的对象，从而使得堆上的对象随着栈上的对象销毁时自动删除。  </p>
<h4 id="两者区别">两者区别</h4><ol>
<li><strong>不能转换所有权</strong>：boost::scoped_ptr所管理的对象生命周期仅仅局限于一个区间（该指针所在的”{}”之间），无法传到区间之外，无法拷贝。这就意味着boost::scoped_ptr对象是不能作为函数的返回值的（std::auto_ptr可以）。</li>
<li><strong>不能共享所有权</strong>：这点和std::auto_ptr类似。这个特点一方面使得该指针简单易用。另一方面也造成了功能的薄弱——不能用于stl的容器中。</li>
<li><strong>不能用于管理数组对象</strong>：由于boost::scoped_ptr是通过delete来删除所管理对象的，而数组对象必须通过deletep[]来删除，因此boost::scoped_ptr是不能管理数组对象的，如果要管理数组对象需要使用boost::scoped_array类。</li>
<li>如何在他们之间取舍取决于是否需要转移所管理的对象的所有权（如是否需要作为函数的返回值）。如果没有这个需要的话，大可以使用boost::scoped_ptr，让编译器来进行更严格的检查，来发现一些不正确的赋值操作。</li>
</ol>
<h3 id="C++_显式类型转换">C++ 显式类型转换</h3><blockquote>
<figure class="highlight"><figcaption><span>分别为转换方式，目标类型，被转换的值。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;1. ```static_cast&#60;type&#62;(expression)```: &#19981;&#25552;&#20379;&#36816;&#34892;&#26102;&#30340;&#26816;&#26597;&#30340;&#31867;&#22411;&#36716;&#25442;&#26041;&#24335;&#10;&#9;* &#20027;&#35201;&#29992;&#20110;&#29238;&#31867;&#21644;&#23376;&#31867;&#20043;&#38388;&#25351;&#38024;&#21644;&#24341;&#29992;&#30340;&#36716;&#25442;&#65307;&#36827;&#34892;&#19978;&#34892;&#36716;&#25442;&#65292;&#25226;&#23376;&#31867;&#23545;&#35937;&#30340;&#25351;&#38024;/&#24341;&#29992;&#36716;&#25442;&#20026;&#29238;&#31867;&#25351;&#38024;/&#24341;&#29992;&#65292;&#36825;&#31181;&#36716;&#25442;&#26159;&#23433;&#20840;&#30340;&#65307;&#36827;&#34892;&#19979;&#34892;&#36716;&#25442;&#65292;&#25226;&#29238;&#31867;&#23545;&#35937;&#30340;&#25351;&#38024;/&#24341;&#29992;&#36716;&#25442;&#25104;&#23376;&#31867;&#25351;&#38024;/&#24341;&#29992;&#65292;&#36825;&#31181;&#36716;&#25442;&#26159;&#19981;&#23433;&#20840;&#30340;&#10;&#9;* &#29992;&#20110;&#22522;&#26412;&#25968;&#25454;&#31867;&#22411;&#20043;&#38388;&#30340;&#36716;&#25442;&#65292;&#20363;&#22914;&#25226;int&#36716;char&#65292;int&#36716;enum&#31561;&#65292;&#38656;&#35201;&#32534;&#20889;&#31243;&#24207;&#26102;&#26469;&#30830;&#35748;&#23433;&#20840;&#24615;&#10;&#9;* &#25226;void&#25351;&#38024;&#36716;&#25442;&#25104;&#30446;&#26631;&#31867;&#22411;&#30340;&#25351;&#38024;&#65288;&#36825;&#26159;&#26497;&#20854;&#19981;&#23433;&#20840;&#30340;&#65289;&#10;&#10;2. ```dynamic_cast&#60;type&#62;(expression)```: &#22312;&#36816;&#34892;&#26102;&#26816;&#26597;&#31867;&#22411;&#36716;&#25442;&#26159;&#21542;&#21512;&#27861;&#65292;&#20855;&#26377;&#19968;&#23450;&#30340;&#23433;&#20840;&#24615;&#65292;&#39069;&#22806;&#28040;&#32791;&#19968;&#20123;&#24615;&#33021;&#65307;&#20165;&#36866;&#29992;&#20110;&#25351;&#38024;&#25110;&#24341;&#29992;&#36716;&#25442;&#65292;&#33509;&#25351;&#38024;&#36716;&#25442;&#22833;&#36133;&#65292;&#21017;&#36820;&#22238;&#31354;&#25351;&#38024;&#65292;&#33509;&#24341;&#29992;&#36716;&#25442;&#22833;&#36133;&#65292;&#21017;&#25243;&#20986;&#24322;&#24120;&#12290;&#32463;&#24120;&#29992;&#20110;&#23558;&#25351;&#38024;&#36716;&#25442;&#20026;void*: ```A *pA = new A; void *pV = dynamic_cast&#60;void *&#62;(pA);</span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4. ```reinterpret_cast```&#38750;&#24120;&#28608;&#36827;&#30340;&#25351;&#38024;&#31867;&#22411;&#36716;&#25442;&#65292;&#22312;&#32534;&#35793;&#26399;&#23436;&#25104;&#65292;&#21487;&#20197;&#36716;&#25442;&#20219;&#20309;&#31867;&#22411;&#30340;&#25351;&#38024;&#65292;&#25152;&#20197;&#26497;&#19981;&#23433;&#20840;&#12290;&#38750;&#26497;&#31471;&#24773;&#20917;&#19981;&#35201;&#20351;&#29992;&#12290;&#10;&#10;### &#23432;&#25252;&#36827;&#31243;&#10;#### Supervisor&#10;1. Supervisor&#26159;&#19968;&#20010;C/S&#31995;&#32479;&#65292; &#20801;&#35768;&#29992;&#25143;&#30417;&#25511;&#21644;&#31649;&#29702;&#19968;&#31995;&#21015;&#36816;&#34892;&#20110;&#31867;Unix&#31995;&#32479;&#19978;&#30340;&#36827;&#31243;&#12290;&#36890;&#24120;&#65292;&#25105;&#20204;&#20351;&#29992;Supervisor&#23558;&#19968;&#20010;&#26222;&#36890;&#30340;&#21629;&#20196;&#34892;&#36827;&#31243;&#21464;&#20026;&#21518;&#21488;daemon&#65292;&#24182;&#30417;&#25511;&#36825;&#19968;&#20123;&#36827;&#31243;&#65292;&#20197;&#20415;&#36825;&#20123;&#36827;&#31243;&#22312;&#24847;&#22806;&#36864;&#20986;&#21518;&#33021;&#22815;&#37325;&#26032;&#21551;&#21160;&#12290;&#10;2. Supervisor&#26377;&#20197;&#19979;&#20248;&#28857;&#65306;&#10;&#9;* &#31616;&#21333;&#65292; ini&#39118;&#26684;&#30340;&#37197;&#32622;&#25991;&#20214;&#65292;&#23481;&#26131;&#38405;&#35835;&#65292;&#23545;&#27599;&#20010;&#36827;&#31243;&#37117;&#25552;&#20379;&#20102;&#35768;&#22810;&#36873;&#39033;&#20197;&#20415;&#22833;&#36133;&#37325;&#21551;&#21644;&#26085;&#24535;&#36718;&#26367;&#12290;&#10;&#9;* &#38598;&#20013;&#65292;&#19968;&#31449;&#24335;&#30340;&#36827;&#31243;&#21551;&#21160;&#65292;&#20572;&#27490;&#65292;&#30417;&#25511;&#24179;&#21488;&#12290;&#36827;&#31243;&#21487;&#20197;&#21333;&#29420;&#31649;&#29702;&#25110;&#20998;&#32452;&#31649;&#29702;&#65292;&#26356;&#25552;&#20379;&#20102;Web&#31649;&#29702;&#30028;&#38754;&#12290;&#10;&#9;* &#39640;&#25928;&#65292;&#36890;&#36807;fork/exec&#21551;&#21160;&#23376;&#36827;&#31243;&#19988;&#23376;&#36827;&#31243;&#19981;&#20250;&#36827;&#20837;&#23432;&#25252;&#27169;&#24335;&#65292;&#24403;&#23376;&#36827;&#31243;&#24847;&#22806;&#32456;&#27490;&#26102;&#65292;&#25805;&#20316;&#31995;&#32479;&#20250;&#31435;&#21363;&#21457;&#36865;&#20449;&#21495;&#32473;Supervisor&#65292;&#32780;&#19981;&#20687;&#20854;&#20182;&#26041;&#26696;&#37027;&#26679;&#65292;&#38656;&#35201;&#36890;&#36807;PID&#36718;&#35810;&#12290;&#10;&#9;* &#21487;&#25193;&#23637;&#65292;&#25317;&#26377;&#38750;&#24120;&#31616;&#21333;&#30340;&#20107;&#20214;&#36890;&#30693;&#21327;&#35758;&#65292;&#20219;&#20309;&#32534;&#31243;&#35821;&#35328;&#31243;&#24207;&#37117;&#33021;&#30417;&#25511;&#23427;&#65292;&#20063;&#25552;&#20379;&#20102;XML-RPC&#31649;&#29702;&#25509;&#21475;&#65292;&#20063;&#20026;Python&#24320;&#21457;&#32773;&#39044;&#30041;&#20102;&#25193;&#23637;&#31354;&#38388;&#12290;&#10;&#20860;&#23481;&#24615;&#65292;&#38500;&#20102;Windows&#65292;&#20960;&#20046;&#21487;&#20197;&#36816;&#34892;&#20110;&#20219;&#20309;&#25805;&#20316;&#31995;&#32479;&#65292;&#24050;&#32463;&#27979;&#35797;&#36807;&#30340;&#21253;&#25324;Linux, Mac OS X, Solaris, &#21644; FreeBSD&#12290;&#10;&#9;* &#20037;&#32463;&#32771;&#39564;&#65292;&#34429;&#28982;&#24320;&#21457;&#38750;&#24120;&#27963;&#36291;&#65292;&#20294;Supervisor&#24182;&#19981;&#26159;&#26032;&#36719;&#20214;&#65292;&#23427;&#24050;&#32463;&#23384;&#22312;&#22810;&#24180;&#65292;&#24191;&#27867;&#36816;&#34892;&#20110;&#35768;&#22810;&#26381;&#21153;&#22120;&#19978;&#12290;&#10;&#10;#### systemd&#10;1. Systemd&#26159;&#19968;&#20010;Linux&#25805;&#20316;&#31995;&#32479;&#19979;&#30340;&#31995;&#32479;&#21644;&#26381;&#21153;&#31649;&#29702;&#22120;&#12290;&#23427;&#34987;&#35774;&#35745;&#25104;&#21521;&#21518;&#20860;&#23481;SysV&#21551;&#21160;&#33050;&#26412;&#65292;&#24182;&#25552;&#20379;&#20102;&#22823;&#37327;&#30340;&#29305;&#24615;&#65292;&#22914;&#24320;&#26426;&#26102;&#24179;&#34892;&#21551;&#21160;&#31995;&#32479;&#26381;&#21153;&#65292;&#25353;&#38656;&#21551;&#21160;&#23432;&#25252;&#36827;&#31243;&#65292;&#25903;&#25345;&#31995;&#32479;&#29366;&#24577;&#24555;&#29031;&#65292;&#25110;&#32773;&#22522;&#20110;&#20381;&#36182;&#30340;&#26381;&#21153;&#25511;&#21046;&#36923;&#36753;,&#24050;&#25104;&#20026;&#22823;&#22810;&#25968;&#21457;&#34892;&#29256;&#30340;&#26631;&#20934;&#37197;&#32622;&#12290;&#21487;&#20197;&#36890;&#36807; systemctl --version &#21629;&#20196;&#26469;&#26597;&#30475;&#20351;&#29992;&#30340;&#29256;&#26412;&#10;3. systemd &#21644; supervisord &#21508;&#26377;&#38271;&#30701;&#65292;&#19981;&#23384;&#22312;&#21738;&#19968;&#26041;&#32477;&#23545;&#30340;&#30910;&#21387;&#12290;systemd &#36319; Linux &#32039;&#23494;&#32467;&#21512;&#65292;&#25152;&#38656;&#30340;&#20381;&#36182;&#23569;&#65292;&#20854;&#25552;&#20379;&#30340;&#20445;&#38556;&#33258;&#28982;&#27604; supervisord &#26356;&#21487;&#38752;&#12290;&#28982;&#32780;&#22312;&#24378;&#22823;&#30340;&#33021;&#21147;&#32972;&#21518;&#65292;&#20063;&#26377;&#37197;&#32622;&#22797;&#26434;&#12289;&#19981;&#26131;&#19978;&#25163;&#31561;&#38382;&#39064;&#12290;&#10;&#10;### &#24120;&#29992;&#27979;&#35797;&#24037;&#20855;&#10;1. Apache&#33258;&#24102;ApacheBench&#31243;&#24207;&#23545;Apache&#25110;&#20854;&#23427;&#31867;&#22411;&#30340;&#26381;&#21153;&#22120;&#36827;&#34892;&#32593;&#31449;&#35775;&#38382;&#21387;&#21147;&#27979;&#35797;&#12290;&#10;&#10;&#62; ApacheBench&#21629;&#20196;&#21407;&#29702;&#65306;ab&#21629;&#20196;&#20250;&#21019;&#24314;&#24456;&#22810;&#30340;&#24182;&#21457;&#35775;&#38382;&#32447;&#31243;&#65292;&#27169;&#25311;&#22810;&#20010;&#35775;&#38382;&#32773;&#21516;&#26102;&#23545;&#26576;&#19968;URL&#22320;&#22336;&#36827;&#34892;&#35775;&#38382;&#12290;&#23427;&#30340;&#27979;&#35797;&#30446;&#26631;&#26159;&#22522;&#20110;URL&#30340;&#65292;&#22240;&#27492;&#65292;&#26082;&#21487;&#20197;&#29992;&#26469;&#27979;&#35797;Apache&#30340;&#36127;&#36733;&#21387;&#21147;&#65292;&#20063;&#21487;&#20197;&#27979;&#35797;nginx&#12289;lighthttp&#12289;tomcat&#12289;IIS&#31561;&#20854;&#23427;Web&#26381;&#21153;&#22120;&#30340;&#21387;&#21147;&#12290;&#10;&#10;&#62; ab&#21629;&#20196;&#23545;&#21457;&#20986;&#36127;&#36733;&#30340;&#35745;&#31639;&#26426;&#35201;&#27714;&#24456;&#20302;&#65292;&#26082;&#19981;&#20250;&#21344;&#29992;&#24456;&#39640;CPU&#65292;&#20063;&#19981;&#20250;&#21344;&#29992;&#24456;&#22810;&#20869;&#23384;&#65292;&#20294;&#21364;&#20250;&#32473;&#30446;&#26631;&#26381;&#21153;&#22120;&#36896;&#25104;&#24040;&#22823;&#30340;&#36127;&#36733;&#65292;&#20854;&#21407;&#29702;&#31867;&#20284;CC&#25915;&#20987;&#12290;&#33258;&#24049;&#27979;&#35797;&#20351;&#29992;&#20063;&#39035;&#27880;&#24847;&#65292;&#21542;&#21017;&#19968;&#27425;&#19978;&#22826;&#22810;&#30340;&#36127;&#36733;&#65292;&#21487;&#33021;&#36896;&#25104;&#30446;&#26631;&#26381;&#21153;&#22120;&#22240;&#36164;&#28304;&#32791;&#23436;&#65292;&#20005;&#37325;&#26102;&#29978;&#33267;&#23548;&#33268;&#27515;&#26426;&#12290;&#10;&#10;2. [&#26381;&#21153;&#22120;&#24615;&#33021;&#35780;&#20272;&#30456;&#20851;&#25351;&#26631;QPS](https://ruby-china.org/topics/26221)&#10;&#10;### C++&#24120;&#29992;&#38169;&#35823;&#35843;&#35797;&#24037;&#20855;&#10;&#10;#### core dump&#10;core dump&#26159;&#22823;&#22810;&#25968;UNIX&#31995;&#32479;&#23454;&#29616;&#30340;&#19968;&#31181;&#29305;&#24615;&#65292;&#24403;&#36827;&#31243;&#36816;&#34892;&#30340;&#36807;&#31243;&#20013;&#24322;&#24120;&#32456;&#27490;&#25110;&#23849;&#28291;&#26102;&#65292;&#25805;&#20316;&#31995;&#32479;&#20250;&#23558;&#36827;&#31243;&#24403;&#21069;&#30340;&#20869;&#23384;&#26144;&#20687;&#21644;&#19968;&#37096;&#20998;&#30456;&#20851;&#30340;&#35843;&#35797;&#20449;&#24687;&#20889;&#20837;core&#25991;&#20214;&#65292;&#20363;&#22914;&#23492;&#23384;&#22120;&#20449;&#24687;&#65288;&#21253;&#25324;&#31243;&#24207;&#25351;&#38024;&#12289;&#26632;&#25351;&#38024;&#31561;&#65289;&#12289;&#20869;&#23384;&#31649;&#29702;&#20449;&#24687;&#12289;&#20854;&#20182;&#22788;&#29702;&#22120;&#21644;&#25805;&#20316;&#31995;&#32479;&#29366;&#24577;&#21644;&#20449;&#24687;&#12290;&#25105;&#20204;&#21487;&#20197;&#20351;&#29992;```ulimit -c unlimited```&#21629;&#20196;&#26469;&#24320;&#21551;core dump&#12290;  &#10;&#10;Linux&#20013;&#20449;&#21495;&#26159;&#19968;&#31181;&#24322;&#27493;&#20107;&#20214;&#22788;&#29702;&#30340;&#26426;&#21046;&#65292;&#27599;&#31181;&#20449;&#21495;&#23545;&#24212;&#26377;&#20854;&#40664;&#35748;&#30340;&#25805;&#20316;&#65292;&#40664;&#35748;&#25805;&#20316;&#20027;&#35201;&#21253;&#25324;&#24573;&#30053;&#35813;&#20449;&#21495;&#65288;Ingore&#65289;&#12289;&#26242;&#20572;&#36827;&#31243;&#65288;Stop&#65289;&#12289;&#32456;&#27490;&#36827;&#31243;&#65288;Terminate&#65289;&#12289;&#32456;&#27490;&#24182;&#21457;&#29983;core dump&#65288;core&#65289;&#31561;&#65307;```kill -l```&#21487;&#20197;&#30475;&#21040;linux&#37324;&#36793;&#30340;&#20449;&#21495;&#31181;&#31867;&#65292;&#40664;&#35748;&#21160;&#20316;&#20013;&#21487;&#33021;&#20135;&#29983;core&#25991;&#20214;&#30340;&#20449;&#21495;&#21253;&#25324;&#20197;&#19979;&#31181;&#31867;&#65306;&#10;&#10;&#20449;&#21495;&#21517;&#23383; | &#35828;&#26126; | &#40664;&#35748;&#21160;&#20316;&#10;--- | --- | ---&#10;SIGABRT(6) | &#24322;&#24120;&#32456;&#27490;&#65288;&#35843;&#29992;abort&#20989;&#25968;&#20135;&#29983;&#27492;&#20449;&#21495;&#65289;| &#32456;&#27490;+core&#10;SIGBUS(7) | &#30828;&#20214;&#25925;&#38556;&#65292;&#27604;&#22914;&#20986;&#29616;&#26576;&#20123;&#20869;&#23384;&#25925;&#38556; | &#32456;&#27490;+core&#10;SIGEMT | &#30828;&#20214;&#25925;&#38556; | &#32456;&#27490;+core&#10;SIGFPE(8) | &#31639;&#26415;&#24322;&#24120;&#65292;&#27604;&#22914;&#38500;&#20197;0&#65292;&#28014;&#28857;&#28322;&#20986;&#31561; | &#32456;&#27490;+core&#10;SIGILL(4) | &#38750;&#27861;&#30828;&#20214;&#25351;&#20196;&#9;| &#32456;&#27490;+core&#10;SIGIOT(29) | &#30828;&#20214;&#25925;&#38556;&#9;| &#32456;&#27490;+core&#10;SIGQUIT(3) | &#32456;&#31471;&#36864;&#20986;&#31526;&#65292;&#27604;&#22914;Ctrl+C&#9;| &#32456;&#27490;+core&#10;SIGSEGV(11) | &#26080;&#25928;&#20869;&#23384;&#24341;&#29992; | &#32456;&#27490;+core&#10;SIGSYS(31) | &#26080;&#25928;&#31995;&#32479;&#35843;&#29992;&#9;| &#32456;&#27490;+core&#10;SIGXCPU(24) | &#36229;&#36807;CPU&#38480;&#21046;&#65288;setrlimit&#65289;| &#32456;&#27490;+core/&#24573;&#30053;&#10;SIGXFSZ(25) | &#36229;&#36807;&#25991;&#20214;&#38271;&#24230;&#38480;&#21046;&#65288;setrlimit&#65289;| &#32456;&#27490;+core/&#24573;&#30053;&#10;&#10;&#36825;&#23601;&#26159;&#20026;&#20160;&#20040;&#25105;&#20204;&#20351;&#29992;```ctrl+z```&#26469;&#25346;&#36215;&#19968;&#20010;&#36827;&#31243;&#25110;&#32773;```Ctrl+C```&#32467;&#26463;&#19968;&#20010;&#36827;&#31243;&#22343;&#19981;&#20250;&#20135;&#29983; core dump&#65292;&#22240;&#20026;&#21069;&#32773;&#20250;&#21521;&#36827;&#31243;&#21457;&#20986;SIGTSTP&#20449;&#21495;&#65292;&#35813;&#20449;&#21495;&#30340;&#40664;&#35748;&#25805;&#20316;&#20026;&#26242;&#20572;&#36827;&#31243;&#65288;Stop Process&#65289;&#65307;&#21518;&#32773;&#20250;&#21521;&#36827;&#31243;&#21457;&#20986;SIGINT&#20449;&#21495;&#65292;&#35813;&#20449;&#21495;&#40664;&#35748;&#25805;&#20316;&#20026;&#32456;&#27490;&#36827;&#31243;&#65288;Terminate Process&#65289;&#12290;&#21516;&#26679;&#19978;&#38754;&#25552;&#21040;&#30340; kill -9 &#21629;&#20196;&#20250;&#21457;&#20986; SIGKILL &#21629;&#20196;&#65292;&#35813;&#21629;&#20196;&#40664;&#35748;&#20026;&#32456;&#27490;&#36827;&#31243;&#12290;&#32780;&#22914;&#26524;&#25105;&#20204;&#20351;&#29992; Ctrl+\ &#26469;&#32456;&#27490;&#19968;&#20010;&#36827;&#31243;&#65292;&#20250;&#21521;&#36827;&#31243;&#21457;&#20986; SIGQUIT &#20449;&#21495;&#65292;&#40664;&#35748;&#26159;&#20250;&#20135;&#29983; core dump &#30340;&#12290;&#36824;&#26377;&#20854;&#23427;&#24773;&#26223;&#20250;&#20135;&#29983;core dump&#65292; &#22914;&#65306;&#31243;&#24207;&#35843;&#29992; abort() &#20989;&#25968;&#12289;&#35775;&#23384;&#38169;&#35823;&#12289;&#38750;&#27861;&#25351;&#20196;&#31561;&#31561;&#12290;&#10;&#10;#### dmesg&#10;**&#27573;&#38169;&#35823;**&#26159;&#25351;&#35775;&#38382;&#30340;&#20869;&#23384;&#36229;&#20986;&#20102;&#31995;&#32479;&#32473;&#36825;&#20010;&#31243;&#24207;&#25152;&#35774;&#23450;&#30340;&#20869;&#23384;&#31354;&#38388;&#65292; &#20363;&#22914;&#35775;&#38382;&#20102;&#19981;&#23384;&#22312;&#30340;&#20869;&#23384;&#22320;&#22336;&#65292;&#35775;&#38382;&#20102;&#31995;&#32479;&#20445;&#25252;&#30340;&#20869;&#23384;&#22320;&#22336;&#65292;&#35775;&#38382;&#20102;&#21482;&#35835;&#30340;&#20869;&#23384;&#22320;&#22336;&#31561;&#31561;&#24773;&#20917;&#12290;```dmesg```&#21629;&#20196;&#26174;&#31034;linux&#20869;&#26680;&#30340;&#29615;&#24418;&#32531;&#20914;&#21306;&#20449;&#24687;&#65292;&#25105;&#20204;&#21487;&#20197;&#20174;&#20013;&#33719;&#24471;&#35832;&#22914;&#31995;&#32479;&#26550;&#26500;&#12289;cpu&#12289;&#25346;&#36733;&#30340;&#30828;&#20214;&#65292;RAM&#31561;&#22810;&#20010;&#36816;&#34892;&#32423;&#21035;&#30340;&#22823;&#37327;&#30340;&#31995;&#32479;&#20449;&#24687;&#12290;&#36890;&#36807;dmesg&#21629;&#20196;&#21487;&#20197;&#26597;&#30475;&#21457;&#29983;&#27573;&#38169;&#35823;&#30340;&#31243;&#24207;&#21517;&#31216;&#12289;&#24341;&#36215;&#27573;&#38169;&#35823;&#21457;&#29983;&#30340;&#20869;&#23384;&#22320;&#22336;&#12289;&#25351;&#20196;&#25351;&#38024;&#22320;&#22336;&#12289;&#22534;&#26632;&#25351;&#38024;&#22320;&#22336;&#12289;&#38169;&#35823;&#20195;&#30721;&#12289;&#38169;&#35823;&#21407;&#22240;&#31561;&#12290;&#10;&#10;1. dmesg&#20449;&#24687;&#35299;&#35835;: &#22914;&#19979;&#26159;bucket bin&#25991;&#20214;&#27573;&#38169;&#35823;&#20449;&#24687;&#65292;ip&#20449;&#24687;&#20250;&#29992;&#21040;&#21518;&#32493;objdump&#21453;&#32534;&#35793;&#20998;&#26512;&#10;&#10;```bucket[14306]: segfault at b8c6000 ip 0000000000c3dece sp 00007ffd2c96ae80 error 6 in bucket[400000+eea000]</span><br></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>error number是6, 转成二进制就是110, 即bit2=1, bit1=1, bit0=0, 按照上面的解释，我们可以得出这条信息是由于用户态程序写操作访问越界，访问的是无效地址造成的。</p>
<p>error number是由三个字位组成的，从高到底分别为bit2 bit1和bit0,所以它的取值范围是0~7.</p>
<blockquote>
<ul>
<li>bit2: 值为1表示是用户态程序内存访问越界，值为0表示是内核态程序内存访问越界</li>
<li>bit1: 值为1表示是写操作导致内存访问越界，值为0表示是读操作导致内存访问越界</li>
<li>bit0: 值为1表示没有足够的权限访问非法地址的内容，值为0表示访问的非法地址根本没有对应的页面，也就是无效地址</li>
</ul>
</blockquote>
</blockquote>
<h4 id="objdump">objdump</h4><p>objdump命令是Linux下的反汇编目标文件或者可执行文件的命令，使用objdump生成二进制的相关信息，并重定向到文件中</p>
<figure class="highlight"><figcaption><span>-d(-S尽可能完全反编译) bin/bucket > segfaultDump```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;```grep -n -A 10 -B 10 &#34;c3dece&#34; ./segfaultDump</span><br></pre></td></tr></table></figure>
<h4 id="pstack和trace">pstack和trace</h4><p>strace跟踪程序使用的底层系统调用，可输出系统调用被执行的时间点以及各个调用耗时；pstack工具对指定PID的进程输出函数调用栈。一般两者配合调用，先用strace查看耗时的系统调用，然后用pstack看函数调用栈信息，找到出问题的函数。</p>
<ol>
<li><p>在Linux世界，进程不能直接访问硬件设备，当进程需要访问硬件设备(比如读取磁盘文件，接收网络数据等等)时，必须由用户态模式切换至内核态模式，通过系统调用访问硬件设备。<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#9;&#10;&#9;&#9;# -f -F&#36873;&#39033;&#35774;&#32622;&#21516;&#26102;&#36319;&#36394;fork&#21644;vfork&#20986;&#26469;&#30340;&#36827;&#31243;&#65292;&#36755;&#20986;&#21040;~/straceout.txt&#65292;myserver&#26159;&#35201;&#21551;&#21160;&#21644;&#35843;&#35797;&#30340;&#31243;&#24207;&#10;&#9;&#9;strace -f -F -o ~/straceout.txt myserver&#10;&#9;&#9;&#10;&#9;&#9;# &#36319;&#36394;28979&#36827;&#31243;&#30340;&#25152;&#26377;&#31995;&#32479;&#35843;&#29992;&#65288;-e trace=all&#65289;&#65292;&#24182;&#32479;&#35745;&#31995;&#32479;&#35843;&#29992;&#30340;&#33457;&#36153;&#26102;&#38388;&#65292;&#20197;&#21450;&#24320;&#22987;&#26102;&#38388;&#65288;&#24182;&#20197;&#21487;&#35270;&#21270;&#30340;&#26102;&#20998;&#31186;&#26684;&#24335;&#26174;&#31034;&#65289;&#10;&#9;&#9;strace -o output.txt -T -tt -e trace=all -p 28979&#10;2. ```pstack pid```: print a stack trace of a running process&#10;&#10;#### &#20854;&#23427;&#10;1. ldd&#65306;&#20351;&#29992;ldd&#21629;&#20196;&#26597;&#30475;&#20108;&#36827;&#21046;&#31243;&#24207;&#30340;&#20849;&#20139;&#38142;&#25509;&#24211;&#20381;&#36182;&#65292;&#21253;&#25324;&#24211;&#30340;&#21517;&#31216;&#12289;&#36215;&#22987;&#22320;&#22336;&#65292;&#36825;&#26679;&#21487;&#20197;&#30830;&#23450;&#27573;&#38169;&#35823;&#21040;&#24213;&#26159;&#21457;&#29983;&#22312;&#20102;&#33258;&#24049;&#30340;&#31243;&#24207;&#20013;&#36824;&#26159;&#20381;&#36182;&#30340;&#20849;&#20139;&#24211;&#20013;&#12290;&#20363;&#22914;```ldd bin/bucket</span><br></pre></td></tr></table></figure></p>
</li>
<li><p>nm：使用nm命令列出二进制文件中的符号表，包括符号地址、符号类型、符号名等，这样可以帮助定位在哪里发生了段错误。<figure class="highlight"><figcaption><span>bin/bucket```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#10;#### &#21442;&#32771;&#38142;&#25509;&#10;1. [Linux&#24037;&#20855;](http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/objdump.html)&#10;&#10;&#10;&#10;### condition_variable/mutex/thread_pool&#10;&#10;1. **&#26465;&#20214;&#21464;&#37327;(Condtion Variable)&#26159;&#22312;&#22810;&#32447;&#31243;&#31243;&#24207;&#20013;&#29992;&#26469;&#23454;&#29616;&#8220;&#31561;&#24453;-&#62;&#21796;&#37266;&#8221;&#36923;&#36753;&#24120;&#29992;&#30340;&#26041;&#27861;&#65292;&#26465;&#20214;&#21464;&#37327;&#33021;&#20351;&#19968;&#20010;&#25110;&#22810;&#20010;&#32447;&#31243;&#36827;&#20837;&#38459;&#22622;&#29366;&#24577;,&#30452;&#21040;&#25509;&#21040;&#21478;&#19968;&#20010;&#32447;&#31243;&#30340;&#36890;&#30693;(notify),&#25110;&#32773;&#21457;&#29983;&#36229;&#26102;&#25110;&#34394;&#20551;&#21796;&#37266;&#26102;,&#25165;&#36864;&#20986;&#38459;&#22622;**&#12290;&#20363;&#22914;&#65292;&#24212;&#29992;&#31243;&#24207;A&#20013;&#21253;&#21547;&#20004;&#20010;&#32447;&#31243;t1&#21644;t2&#12290;t1&#38656;&#35201;&#22312;bool&#21464;&#37327;test_cond&#20026;true&#26102;&#25165;&#33021;&#32487;&#32493;&#25191;&#34892;&#65292;&#32780;test_cond&#30340;&#20540;&#26159;&#30001;t2&#26469;&#25913;&#21464;&#30340;&#65292;&#36825;&#31181;&#24773;&#20917;&#19979;&#21487;&#20379;&#36873;&#25321;&#30340;&#26041;&#26696;&#26377;&#20004;&#31181;&#65306;&#10;&#10;   * t1&#23450;&#26102;&#30340;&#21435;&#36718;&#35810;&#21464;&#37327;test_cond&#65292;&#22914;&#26524;test_cond&#20026;false&#65292;&#21017;&#32487;&#32493;&#20241;&#30496;&#65307;&#22914;&#26524;test_cond&#20026;true&#65292;&#21017;&#24320;&#22987;&#25191;&#34892;&#12290;&#10;   * &#21033;&#29992;&#26465;&#20214;&#21464;&#37327;&#65292;t1&#22312;test_cond&#20026;false&#26102;&#35843;&#29992;cond_wait&#36827;&#34892;&#31561;&#24453;&#65292;t2&#22312;&#25913;&#21464;test_cond&#30340;&#20540;&#21518;&#65292;&#35843;&#29992;cond_signal&#65292;&#21796;&#37266;&#22312;&#31561;&#24453;&#20013;&#30340;t1&#65292;&#21578;&#35785;t1 test_cond&#30340;&#20540;&#21464;&#20102;&#65292;&#36825;&#26679;t1&#20415;&#21487;&#32487;&#32493;&#24448;&#19979;&#25191;&#34892;&#12290;&#10;   * Wait_for: &#22312;&#26465;&#20214;&#21464;&#37327;&#25910;&#21040;&#20449;&#21495;&#25110;&#32773;&#25351;&#23450;&#30340;&#36229;&#26102;&#21457;&#29983;&#21069;&#65292;&#32447;&#31243;&#19968;&#30452;&#22788;&#20110;&#38459;&#22622;&#29366;&#24577;&#65307;&#10;   * Wait_until:&#22312;&#26465;&#20214;&#21464;&#37327;&#25910;&#21040;&#20449;&#21495;&#25110;&#32773;&#25351;&#23450;&#30340;&#26102;&#21051;&#21040;&#36798;&#20043;&#21069;&#65292;&#32447;&#31243;&#19968;&#30452;&#22788;&#20110;&#38459;&#22622;&#29366;&#24577;&#12290;&#10;&#10;2. **Thread&#30456;&#20851;&#30340;&#20989;&#25968;**&#65306;&#10;&#10;   * t.join()&#65306;&#20351;&#35843;&#29992;&#32447;&#31243;&#65288;&#26412;&#20363;&#26159;&#25351;&#20027;&#32447;&#31243;&#65289;&#19968;&#30452;&#22788;&#20110;&#38459;&#22622;&#29366;&#24577;&#65292;&#30452;&#21040;&#27491;&#22312;&#25191;&#34892;&#30340;&#32447;&#31243;t&#25191;&#34892;&#32467;&#26463;&#12290;&#22914;&#26524;&#32447;&#31243;&#20989;&#25968;&#36820;&#22238;&#26576;&#20010;&#20540;&#65292;&#35813;&#20540;&#20063;&#23558;&#34987;&#24573;&#30053;&#12290;&#19981;&#36807;&#65292;&#35813;&#20989;&#25968;&#21487;&#20197;&#25509;&#25910;&#20219;&#24847;&#25968;&#37327;&#30340;&#21442;&#25968;&#65292;&#23613;&#31649;&#21487;&#20197;&#21521;&#32447;&#31243;&#20989;&#25968;&#20256;&#36882;&#20219;&#24847;&#25968;&#37327;&#30340;&#21442;&#25968;&#65292;&#20294;&#26159;&#25152;&#26377;&#30340;&#21442;&#25968;&#24212;&#24403;&#25353;&#20540;&#20256;&#36882;&#12290;&#22914;&#26524;&#38656;&#35201;&#23558;&#21442;&#25968;&#25353;&#24341;&#29992;&#20256;&#36882;&#65292;&#37027;&#35201;&#21521;&#19979;&#20363;&#25152;&#31034;&#37027;&#26679;&#65292;&#24517;&#39035;&#23558;&#21442;&#25968;&#29992;std::ref &#25110;&#32773;std::cref&#36827;&#34892;&#23553;&#35013;&#12290;&#10;&#10;     ```cpp&#10;     void func(int i, double d, const std::string&#38; s)&#10;     &#123;&#10;         std::cout &#60;&#60; i &#60;&#60; &#34;, &#34; &#60;&#60; d &#60;&#60; &#34;, &#34; &#60;&#60; s &#60;&#60; std::endl;&#10;     &#125;&#10;      &#10;     void func1(int&#38; a)&#10;     &#123;&#10;        a++;&#10;     &#125;&#10;     &#10;     int main()&#10;     &#123;&#10;        std::thread t(func, 1, 12.50, &#34;sample&#34;);&#10;        t.join();&#10;      &#10;        int a = 42;&#10;        std::thread t1(func, std::ref(a));&#10;        t1.join();&#10;        &#10;        return 0;&#10;     &#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>Detach: 允许执行该方法的线程脱离其线程对象而继续独立执行。脱离后的线程不再是可结合线程（你不能等待它们执行结束）。</p>
</li>
<li><p>get_id: 返回当前线程的id</p>
</li>
<li><p>yield:在处于等待状态时，可以让调度器先运行其他可用的线程。</p>
</li>
<li><p>sleep_for:阻塞当前线程，时间不少于其参数指定的时间。</p>
</li>
<li><p>sleep_util:在参数指定的时间到达之前，使当前线程一直处于阻塞状态。</p>
</li>
</ul>
</li>
<li><p><strong>std::recursive_mutex：</strong>允许同一个线程多次获取同一个互斥量，可获取的互斥量的最大次数并没有具体说明。但是一旦超过最大次数，再对lock进行调用就会抛出std::system_error错误异常。</p>
</li>
<li><p><strong>Timed_mutex和Recursive_timed_mutex</strong>：try_lock_for() 和 try_lock_until()，分别用于在某个时间段里或者某个时刻到达之间获取该互斥量</p>
</li>
<li><p><strong>Lock_guard</strong>: 在构造对象时，它试图去获取互斥量的所有权（通过调用lock()），在析构对象时，自动释放互斥量（通过调用unlock()）.这是一个不可复制的类。</p>
</li>
<li><p><strong>Unique_lock</strong>: 这个一通用的互斥量封装类，不同于lock_guard，它还支持延迟加锁，时间加锁和递归加锁以及锁所有权的转移和条件变量的使用。这也是一个不可复制的类，但它是可移动类。</p>
</li>
<li><p><a href="http://blog.jobbole.com/44409/" target="_blank" rel="external">C++11 中的线程、锁和条件变量</a></p>
</li>
</ol>
<h3 id="其它">其它</h3><ol>
<li>C++ 11 auto关键字编译时类型推断。</li>
<li>std::map::emplace_hint 暗示指定位置前插入元素；make_shared构造类型对象和make_pair构造pair</li>
<li>常用第三方库：boost，gflag，glog，folly，chromium，bazel代码构建</li>
<li>性能分析和内存泄漏：gperftools</li>
<li>C++单例：std::atomic + DCLP, std::once_flag</li>
<li>线程池：rocksdb/util/thread_pool_imp.h</li>
<li>C++智能指针：boost::smart_ptr, std::shared_ptr, std::unique_ptr</li>
<li>boost::shared_ptr 主要的功能是，管理动态创建的对象的销毁。它的基本原理就是记录对象被引用的次数，当引用次数为 0 的时候，也就是最后一个指向某对象的共享指针析构的时候，共享指针的析构函数就把指向的内存区域释放掉。共享指针对象重载了 operator* 和 operator-&gt; , 所以你可以像通常的指针一样使用它. <a href="https://blog.csdn.net/codestinity/article/details/6898613" target="_blank" rel="external">shared_ptr</a></li>
<li><strong><a href="https://www.ibm.com/developerworks/cn/aix/library/1307_lisl_c11/index.html" target="_blank" rel="external">C++左值与右值引用</a></strong>: C++( 包括 C) 中所有的表达式和变量要么是左值，要么是右值。通俗的左值的定义就是非临时对象，那些可以在多条语句中使用的对象。所有的变量都满足这个定义，在多条代码中都可以使用，都是左值。右值是指临时的对象，它们只在当前的语句中有效。左值的声明符号为”&amp;”， 为了和左值区分，右值的声明符号为”&amp;&amp;”。右值引用是用来支持转移语义的。转移语义可以将资源 ( 堆，系统对象等 ) 从一个对象转移到另一个对象，这样能够减少不必要的临时对象的创建、拷贝以及销毁，能够大幅度提高 C++ 应用程序的性能。要实现转移语义，需要定义转移构造函数，还可以定义转移赋值操作符。标准库提供了函数 std::move，这个函数以非常简单的方式将左值引用转换为右值引用。</li>
<li>C++11之后支持lamda语法：std::function可调用实体，std::bind返回可调用实体，用于后续作为回调函数</li>
</ol>

        
      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="../../tags/C/"> #C++ </a>
          
        </div>
      

      

      
      
        <div class="post-eof"></div>
      
    </div>
  </div>


    
  </div>

  
  <div class="pagination">
    <a class="extend prev" rel="prev" href="../3/">&laquo;</a><a class="page-number" href="../..//">1</a><span class="space">&hellip;</span><a class="page-number" href="../3/">3</a><span class="page-number current">4</span><a class="page-number" href="../5/">5</a><span class="space">&hellip;</span><a class="page-number" href="../16/">16</a><a class="extend next" rel="next" href="../5/">&raquo;</a>
  </div>


        </div>

        
      </div>


      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      <div class="site-overview">
        <div class="site-author motion-element">
          <img class="site-author-image" src="/images/avatar.jpg" alt="CharlesXiao" />
          <p class="site-author-name">CharlesXiao</p>
        </div>
        <p class="site-description motion-element">在码农炼成之路不断挣扎……stay hungry……keep learning……</p>
        <div class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="../..//archives">
              <span class="site-state-item-count">80</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="../..//categories">
              <span class="site-state-item-count">17</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="../..//tags">
              <span class="site-state-item-count">75</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </div>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
              <a href="https://github.com/Charles-Xiao" target="_blank">github</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://weibo.com/2262300105/profile?topnav=1&wvr=6" target="_blank">weibo</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://daijiale.github.io/" target="_blank">Daijiale的个人站点</a>
            </span>
            
          
        </div>

        
        

      </div>

      

    </div>
  </div>


    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp;  2015.05.16 - 
  2018
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">CharlesXiao</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="../../vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
  <script type="text/javascript" src="../../vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      $('.content img').each(function () {
        var $image = $(this);
        var $imageWrapLink = $image.parent('a');

        if ($imageWrapLink.size() < 1) {
          $imageWrapLink = $image.wrap('<a href="' + this.getAttribute('src') + '"></a>').parent('a');
        }
        $imageWrapLink.addClass('fancybox');
      });
    });
    $('.fancybox').fancybox({
      helpers: {
        overlay: {
          locked: false
        }
      }
    });
  </script>


  <script type="text/javascript">
  function hasMobileUA () {
    var nav = window.navigator;
    var ua = nav.userAgent;
    var pa = /iPad|iPhone|Android|Opera Mini|BlackBerry|webOS|UCWEB|Blazer|PSP|IEMobile|Symbian/g;

    return pa.test(ua);
  }

  function isDesktop () {
    return screen.width > 991 && !hasMobileUA();
  }

  function isTablet () {
    return screen.width < 992 && screen.width > 767 && hasMobileUA();
  }

  function isMobile () {
    return screen.width < 767 && hasMobileUA();
  }

  function escapeSelector (selector) {
    return selector.replace(/[!"$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, "\\$&")
  }
</script>

  

  <script type="text/javascript" src="../../vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="../../vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" id="motion.global">
  $(document).ready(function () {
    var body = $('body');
    var isSidebarVisible = false;
    var sidebarToggle = $('.sidebar-toggle');
    var sidebarToggleLine1st = $('.sidebar-toggle-line-first')
    var sidebarToggleLine2nd = $('.sidebar-toggle-line-middle');
    var sidebarToggleLine3rd = $('.sidebar-toggle-line-last');
    var sidebar = $('.sidebar');

    var SIDEBAR_WIDTH = '320px';
    var SIDEBAR_DISPLAY_DURATION = 300;

    var sidebarToogleLineStatusInit = {width: '100%', opacity: 1, left: 0, rotateZ: 0, top: 0};

    var sidebarToggleLine1stStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine1stStatusArrow = {width: '50%', rotateZ: '-45deg', top: '2px'};
    var sidebarToogleLine1stStatusClose = {width: '100%', rotateZ: '-45deg', top: '5px'};

    var sidebarToggleLine2ndStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine2ndStatusArrow = {width: '90%'};
    var sidebarToogleLine2ndStatusClose = {opacity: 0};

    var sidebarToggleLine3rdStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine3rdStatusArrow = {width: '50%', rotateZ: '45deg', top: '-2px'};
    var sidebarToogleLine3rdStatusClose = {width: '100%', rotateZ: '45deg', top: '-5px'};

    LogoAndMenuMotion();
    sidebatToggleMotion();
    postsListMotion();
    backToTopMotion();


    $(document)
      .on('sidebar.isShowing', function () {
        isDesktop() && body.velocity(
          {paddingRight: SIDEBAR_WIDTH},
          SIDEBAR_DISPLAY_DURATION
        );
        sidebarContentMotion();
      })
      .on('sidebar.isHiding', function () {});

    function LogoAndMenuMotion() {
      $.Velocity.RunSequence([
        { e: $('.brand'), p: { opacity: 1 }, o: { duration: 100 } },
        { e: $('.logo'), p: { opacity: 1, top: 0 }, o: { duration: 50} },
        
        { e: $('.logo-line-before i'), p: { translateX: "100%" }, o: { duration: 500, sequenceQueue: false } },
        { e: $('.logo-line-after i'), p: { translateX: "-100%" }, o: { duration: 500, sequenceQueue: false } },
        
        { e: $('.site-title'), p: { opacity: 1, top: 0 }, o: { duration: 200 } }
      ]);
      $('.menu-item').velocity('transition.slideDownIn', {display: null});
    }


    function backToTopMotion () {
      var b2top = $('.back-to-top');
      b2top.on('click', function () {
        body.velocity('scroll');
      });
    }

    function sidebarShowMotion () {

      sidebarToggleLine1st.velocity(sidebarToogleLine1stStatusClose);
      sidebarToggleLine2nd.velocity(sidebarToogleLine2ndStatusClose);
      sidebarToggleLine3rd.velocity(sidebarToogleLine3rdStatusClose);

      sidebar.velocity({width: SIDEBAR_WIDTH}, {
        display: 'block',
        duration: SIDEBAR_DISPLAY_DURATION,
        complete: function () {
          sidebar.addClass('sidebar-active');
          sidebar.trigger('sidebar.didShow');
        }
      });
      sidebar.trigger('sidebar.isShowing');
    }

    function sidebarHideMotion () {
      isDesktop() && body.velocity({paddingRight: 0});
      sidebar.velocity('reverse');

      sidebarToggleLine1st.velocity(sidebarToggleLine1stStatusInit);
      sidebarToggleLine2nd.velocity(sidebarToggleLine2ndStatusInit);
      sidebarToggleLine3rd.velocity(sidebarToggleLine3rdStatusInit);

      sidebar.removeClass('sidebar-active');
      sidebar.trigger('sidebar.isHiding');
    };

    function sidebarContentMotion () {
      $('.sidebar .motion-element').velocity(
        'transition.slideRightIn',
        {stagger: 50, drag: true}
      );
    }

    function postsListMotion () {
      var postMotionOptions = window.postMotionOptions || {stagger: 300, drag: true};
      $('.post').velocity('transition.slideDownIn', postMotionOptions);
    }

    function sidebatToggleMotion () {
      sidebarToggle.on('click', function () {
        isSidebarVisible ? sidebarHideMotion() : sidebarShowMotion();
        isSidebarVisible = !isSidebarVisible;
      });

      sidebarToggle.hover(function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusArrow);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusArrow);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusArrow);
      }, function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusInit);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusInit);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusInit);
      });
    }
  });

</script>





  

  
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  
  
  


  

  
</body>
</html>
